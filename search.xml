<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>Mobile Malware Analysis : Overlay and How to Counter it (partly)</title>
      <link href="/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/"/>
      <url>/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/</url>
      <content type="html"><![CDATA[<h2 id="Defeating-Overlay"><a href="#Defeating-Overlay" class="headerlink" title="Defeating Overlay"></a>Defeating Overlay</h2><p>In my last <a href="https://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/">anubis</a> post I touched on overlay and how malware use process scanning to get top process. If somehow we can bypass those techniques, in a way overlay can be defeated. In this<br>post I will try to explain my way of finding a protection for some android versions. </p><h2 id="TLDR"><a href="#TLDR" class="headerlink" title="TLDR;"></a>TLDR;</h2><p>You can use </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">    Method setter = android.os.Process.class.getMethod(<span class="string">"setArgV0"</span>, String.class); </span><br><span class="line">    setter.invoke(android.os.Process.class, text); &#125; </span><br><span class="line">    <span class="keyword">catch</span> (NoSuchMethodException e) &#123; e.printStackTrace(); &#125; </span><br><span class="line">    <span class="keyword">catch</span> (IllegalAccessException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InvocationTargetException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>to change your application’s name to protect users that have android 5.1 and 6.0 </p><h2 id="What-is-process-scanning-and-why-malware-use-it"><a href="#What-is-process-scanning-and-why-malware-use-it" class="headerlink" title="What is process scanning and why malware use it?"></a>What is process scanning and why malware use it?</h2><p>Process scanning is a way for getting list of running processes. Most of the android malware use process scanning to get top activity currenlty running. Then they use this information for deploying overlay attacks. Knowing which processes is currenly top active, helps to select which phishing overlay page malware will use and make attack more believable. Android was aware of this attack vector and take some steps to disable these functions. Here is a <a href="https://jaredrummler.com/2017/09/13/android-processes/" target="_blank" rel="noopener">blogpost</a> cover overall situtation. </p><p>Generally android is secure environment for processes. Each application have different userid and none of application/process have rights to read/write of other processes data. But up until API 23, there was always a way to read process list without any permission. After API 23, applications need to get PACKAGE_USAGE_STATS (system permission) or Accessibility permissions to read process list.</p><h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Lets say <code>com.x.bank</code> is targeted application by malware. Malware infected the device and overlays <code>com.x.bank</code>. Mechanism of overlaying itself can be divided in two elements. First one is triggering when <code>com.x.bank</code> started (achieved via process scanning) and second one is how an app can overlay itself on top of another app. Second element is functionality of android applications. Any app can open itself with the help of services/receivers/intents. We can’t interfere that functionality. What about first element of overlay mechanism ? Is there a way for an application to defend itself by not being in process list or giving randomized name to process list ? This was in my head for a long time. </p><h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>Randomize package name<br>Change process name<br>Hide from usage stats service ? :)</p><h2 id="Android-Version-vs-Technique"><a href="#Android-Version-vs-Technique" class="headerlink" title="Android Version vs Technique"></a>Android Version vs Technique</h2><p>Each android version invervals malware use different techniques to list process/package names. </p><table><thead><tr><th style="text-align:center">API</th><th style="text-align:center">Technique</th></tr></thead><tbody><tr><td style="text-align:center">&lt;= 19</td><td style="text-align:center">runningTask.get(0).topActivity</td></tr><tr><td style="text-align:center">20,21</td><td style="text-align:center">getRunningAppProcesses().get(0).processName</td></tr><tr><td style="text-align:center">22 23</td><td style="text-align:center">/proc/pid/cmdline, /proc/pid/stat</td></tr><tr><td style="text-align:center">&gt;23</td><td style="text-align:center">UsageStats (anubis) or Accessibility (hydra)</td></tr></tbody></table><p>According to <a href="https://developer.android.com/about/dashboards" target="_blank" rel="noopener">Android</a> usage distrubition chart of android versions as follows :</p><table><thead><tr><th style="text-align:center">Version</th><th style="text-align:center">Codename</th><th style="text-align:center">API</th><th style="text-align:center">Usage Percent</th></tr></thead><tbody><tr><td style="text-align:center">4.4</td><td style="text-align:center">Kitkat</td><td style="text-align:center">19</td><td style="text-align:center">%7.6</td></tr><tr><td style="text-align:center">5.0</td><td style="text-align:center">Lollipop</td><td style="text-align:center">21</td><td style="text-align:center">%3.5</td></tr><tr><td style="text-align:center">5.1</td><td style="text-align:center"></td><td style="text-align:center">22</td><td style="text-align:center">%14.4</td></tr><tr><td style="text-align:center">6.0</td><td style="text-align:center">Marshmallow</td><td style="text-align:center">23</td><td style="text-align:center">%21.3</td></tr><tr><td style="text-align:center">7.0</td><td style="text-align:center">Nougat</td><td style="text-align:center">24</td><td style="text-align:center">%18.1</td></tr><tr><td style="text-align:center">7.1</td><td style="text-align:center"></td><td style="text-align:center">25</td><td style="text-align:center">%10.1</td></tr><tr><td style="text-align:center">8.0</td><td style="text-align:center">Oreo</td><td style="text-align:center">26</td><td style="text-align:center">%14.0</td></tr><tr><td style="text-align:center">8.1</td><td style="text-align:center"></td><td style="text-align:center">27</td><td style="text-align:center">%7.5</td></tr></tbody></table><h2 id="Processes-in-Android"><a href="#Processes-in-Android" class="headerlink" title="Processes in Android"></a>Processes in Android</h2><p>If I can change process name of the application, since malware checks static package names, I can avoid being detected. </p><p>Sadly I can only do something for <code>/proc/pid</code> listing techniques. (which is %35.7 of android users tho) To get information about process there are several places. You can try yourself also.</p><ul><li>/proc/pid/cmdline</li><li>/proc/pid/stat</li><li>/proc/pid/status</li></ul><p>To change process name I came across to prctl system call. Using PR_SET_NAME and New name as argument one can change current process’ name. Maybe I could call prctl from native side of application and change process name. But before writing code I tried it with frida. I hooked prctl and checked if its called with PR_SET_NAME (15). Then I replaced called string with another string. </p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> prctlPtr = Module.findExportByName(<span class="literal">null</span>, <span class="string">'prctl'</span>);</span><br><span class="line"><span class="keyword">var</span> prctlOri = <span class="keyword">new</span> NativeFunction(prctlPtr,<span class="string">'int'</span>,[<span class="string">'int'</span>,<span class="string">'int'</span>,<span class="string">'int'</span>,<span class="string">'int'</span>,<span class="string">'int'</span>])</span><br><span class="line">Interceptor.replace(prctlPtr, <span class="keyword">new</span> NativeCallback( <span class="function"><span class="keyword">function</span> (<span class="params">a,b,c,d,e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="number">15</span>)&#123;</span><br><span class="line">        pname = Memory.readUtf8String(ptr(b))</span><br><span class="line">        <span class="keyword">if</span> (pname.includes(<span class="string">"cbunlkwsqtz"</span>))&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(a,b,c,d,e)</span><br><span class="line">            <span class="keyword">for</span> ( i=<span class="number">0</span>; i&lt; <span class="number">9</span> ;i++)&#123;</span><br><span class="line">                pname = Memory.readUtf8String(ptr(b-i))</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"Brute: "</span>+i+ <span class="string">" "</span>+pname)</span><br><span class="line">            &#125;</span><br><span class="line">            Memory.writeS64(ptr(b<span class="number">-9</span>),<span class="number">0x306362617830</span>)</span><br><span class="line">            pname = Memory.readUtf8String(ptr(b<span class="number">-9</span>))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"YAY ! new process name : "</span>,pname)</span><br><span class="line">            <span class="keyword">var</span> fd = prctlOri(a,b<span class="number">-9</span>,c,d,e)</span><br><span class="line">            <span class="keyword">return</span> fd</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">var</span> fd = prctlOri(a,b,c,d,e)</span><br><span class="line">    <span class="keyword">return</span> fd</span><br><span class="line">    &#125;, <span class="string">'int'</span>, [<span class="string">'int'</span>,<span class="string">'int'</span>,<span class="string">'int'</span>,<span class="string">'int'</span>,<span class="string">'int'</span>]));</span><br></pre></td></tr></table></figure><p>And <code>voila</code></p><p><img src="frida.jpg" alt="frida"></p><p>Ps commands shows new process name but malware doesn’t get changed name. Because proc/pid/cmdline didn’t change. Also why prctl even called ? Since I didnt know much about how android processes get their names I searched up again. <code>How can process change its cmdline or stat value ?</code> <a href="https://unix.stackexchange.com/questions/302948/change-proc-pid-environ-after-process-start" target="_blank" rel="noopener">Stackoverflow</a>. But does Android application have argc or argv ? So I searched aosp project and come across to <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/6bebb8418ceecf44d2af40033870f3aabacfe36e/cmds/app_process/app_main.cpp#L332" target="_blank" rel="noopener">this</a> :) See the comment<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// Also note that this is a constant for &quot;normal&quot; android apps.</span><br><span class="line">// Since they&apos;re forked from zygote, the size of their command line</span><br><span class="line">// is the size of the zygote command line.</span><br><span class="line">//</span><br><span class="line">// We change the process name of the process by over-writing</span><br><span class="line">// the start of the argument block (argv[0]) with the new name of</span><br><span class="line">// the process, so we&apos;d mysteriously start getting truncated process</span><br><span class="line">// names if the zygote command line decreases in size.</span><br></pre></td></tr></table></figure></p><p>In android there is a process called Zygote. Zygote is the ancestor of all processes like init0. Every process is fork of zygote.<br>After being forked from zygote, application’s process name changes within app_main.cpp. Knowing that I looked up which function I could used and saw <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/os/Process.java" target="_blank" rel="noopener"><code>setArgv0</code></a> which sound right. Then I tried with application. Opened up android studio.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os.Process</span><br><span class="line">Process.setArgv0(<span class="string">"0xabc0"</span>);</span><br></pre></td></tr></table></figure><p>But android studio didn’t resolve setArgv0. If I go to declartion of Process class I can see setArgv0 there.</p><p><img src="huh.jpg" alt="huh"></p><p>So whats happenning ?<br>See <code>@hide</code> tag. That tag means its hidden from developer because they are internally used and can be changed in future APIs. Also these methods can be classified in four list  after <a href="https://developer.android.com/distribute/best-practices/develop/restrictions-non-sdk-interfaces" target="_blank" rel="noopener">Android 9</a>. But we are trying to protect users that use Android 6. So there is no problem. </p><p>You can’t directly call these hidden methods but you can use reflection (big thanks to <a href="https://twitter.com/ibrahimsn98" target="_blank" rel="noopener">@ibrahimsn98</a>!) </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">    Method setter = android.os.Process.class.getMethod(<span class="string">"setArgV0"</span>, String.class); </span><br><span class="line">    setter.invoke(android.os.Process.class, text); &#125; </span><br><span class="line">    <span class="keyword">catch</span> (NoSuchMethodException e) &#123; e.printStackTrace(); &#125; </span><br><span class="line">    <span class="keyword">catch</span> (IllegalAccessException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InvocationTargetException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>With this, process name is changed everywhere cmdline,stat,status. YAY!</p><p>I created 2 apk to test this. One apk is getting processes. I used this <a href="https://github.com/jaredrummler/AndroidProcesses" target="_blank" rel="noopener">project</a> which is used in Anubis. And other app is changing its process name with <code>setArgv0</code>. </p><p><img src="hide.gif" width="350" height="200"></p><p>The reason why app is not in process list is scanner app tries to access /data/app/package-name folder. Since we changed the name, it tries to access /data/app/0xabc0 which is not there. So it doesn’t display it.</p><h2 id="Thoughts-1"><a href="#Thoughts-1" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>For other methods I couldn’t find anything. Android can give rights/permissions to applications for not being in stats menu to avoid being detected by <code>USAGE_STATS</code> or  by <code>Accessibility</code> maybe . Targeted apps can be saved from overlaying attacks with these rights. </p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>With little code you can change your application’s process name in certain API versions. It can be used to protect users from malware :)</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.geeksonsecurity.com/android-overlay-malware/2016/07/27/android-overlay-malware-analysis/" target="_blank" rel="noopener">https://www.geeksonsecurity.com/android-overlay-malware/2016/07/27/android-overlay-malware-analysis/</a></p><p><a href="https://www.symantec.com/connect/blogs/android-malware-finds-new-ways-derive-current-running-tasks" target="_blank" rel="noopener">https://www.symantec.com/connect/blogs/android-malware-finds-new-ways-derive-current-running-tasks</a></p><p><a href="https://www.nowsecure.com/blog/2017/05/25/android-overlay-malware-system-alert-window-permission/" target="_blank" rel="noopener">https://www.nowsecure.com/blog/2017/05/25/android-overlay-malware-system-alert-window-permission/</a></p>]]></content>
      
      
    </entry>
    
    <entry>
      <title>DEF CON Quals 2019 : Vitor</title>
      <link href="/DEF-CON-Quals-2019-Vitor/"/>
      <url>/DEF-CON-Quals-2019-Vitor/</url>
      <content type="html"><![CDATA[<h2 id="Vitor"><a href="#Vitor" class="headerlink" title="Vitor"></a>Vitor</h2><p><img src="mm.jpg" alt="mm"></p><p>Defcon 2019 qualifiersda sorulmuş android reverse kategorisine ait bir ctf sorusu. Matruşka misali birkaç bölümden oluşuyor. Soruda bize bir <a href="https://github.com/o-o-overflow/dc2019q-vitor-public/blob/master/vitor.apk" target="_blank" rel="noopener">apk</a> veriliyor. Uygulama bizden input olarak flagi istiyor ve doğruluğunu kontrol ediyor. </p><h2 id="Asama-1-Dex"><a href="#Asama-1-Dex" class="headerlink" title="Aşama 1 : Dex"></a>Aşama 1 : Dex</h2><p>Verilen apkyı <code>jadx</code> gibi araçlarla decompile edip java kodunu inceleyebiliyoruz. Classlara göz attığımızda <code>fc</code> class’ını görüyoruz. Genel olarak her aşamada yapılacak olanlar birbirine benzer. Sadece ilk aşama için detaylı bir açıklama yapacağım. Flagi kontrol eden fonksiyonumuz şu şekilde:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">cf</span><span class="params">(MainActivity mainActivity, String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> z = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cfa(mainActivity, p1EncFn);</span><br><span class="line">        cfa(mainActivity, p5EncFn);</span><br><span class="line">        cfa(mainActivity, randEncFn);</span><br><span class="line">        cfa(mainActivity, rand2EncFn);</span><br><span class="line">        <span class="keyword">if</span> (str.startsWith(<span class="string">"OOO&#123;"</span>) &amp;&amp; str.endsWith(<span class="string">"&#125;"</span>) &amp;&amp; str.length() == <span class="number">45</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cf(mainActivity, dp1(mainActivity, <span class="keyword">new</span> File(mainActivity.getFilesDir(), p1EncFn), g0(str.substring(<span class="number">4</span>, <span class="number">44</span>))), str)) &#123;</span><br><span class="line">                File file = <span class="keyword">new</span> File(mainActivity.getFilesDir(), <span class="string">"bam.html"</span>);</span><br><span class="line">                WebView webView = mainActivity.mWebView;</span><br><span class="line">                StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                stringBuilder.append(<span class="string">"file:///"</span>);</span><br><span class="line">                stringBuilder.append(file.getAbsolutePath());</span><br><span class="line">                stringBuilder.append(<span class="string">"?flag="</span>);</span><br><span class="line">                stringBuilder.append(Uri.encode(str));</span><br><span class="line">                webView.loadUrl(stringBuilder.toString());</span><br><span class="line">                z = mValid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> z;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>İlk kontrolden anlıyoruzki Flag <code>OOO{</code> ile başlayıp <code>}</code> ile bitiyor. Uzunluğu 45. Ardından sırasıyla incelersek:</p><p><code>g0(str.substring(4, 44)))</code> : g0 fonksiyonuna flagimizin süslü parantezler içerisinde kalan input yollanıyor. g0 fonksiyonu :</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] g0(String str) &#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">byte</span>[] bArr = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = str.getBytes();</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        bArr[i] = (<span class="keyword">byte</span>) <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i2 = <span class="number">0</span>; i2 &lt; <span class="number">10</span>; i2++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            bArr[i] = (<span class="keyword">byte</span>) ((<span class="keyword">byte</span>) (bArr[i] ^ bytes[(i2 * <span class="number">4</span>) + i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bArr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Fonksiyon 4 bytelık bir array döndürüyor. Bu 4 byte’ı da şu şekilde hesaplıyor:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">0</span>]^flag[<span class="number">8</span>]^flag[<span class="number">16</span>]^flag[<span class="number">24</span>]^flag[<span class="number">32</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">1</span>]^flag[<span class="number">9</span>]^flag[<span class="number">17</span>]^flag[<span class="number">25</span>]^flag[<span class="number">33</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">2</span>]^flag[<span class="number">10</span>]^flag[<span class="number">18</span>]^flag[<span class="number">26</span>]^flag[<span class="number">34</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">3</span>]^flag[<span class="number">11</span>]^flag[<span class="number">19</span>]^flag[<span class="number">27</span>]^flag[<span class="number">35</span>]</span><br></pre></td></tr></table></figure><p>g0 fonksiyonundan dönen 4byte, dp1 fonksiyonuna 3. parametre olarak gidiyor.</p><p><code>dp1(mainActivity, new File(mainActivity.getFilesDir(), p1EncFn), g0(str.substring(4, 44)))</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> File <span class="title">dp1</span><span class="params">(Context context, File file, <span class="keyword">byte</span>[] bArr)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] hash = hash(bArr);</span><br><span class="line">    <span class="keyword">byte</span>[] readAllBytes = Files.readAllBytes(file.toPath());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AlgorithmParameterSpec ivParameterSpec = <span class="keyword">new</span> IvParameterSpec(initVector);</span><br><span class="line">        Key secretKeySpec = <span class="keyword">new</span> SecretKeySpec(hash, <span class="string">"AES"</span>);</span><br><span class="line">        Cipher instance = Cipher.getInstance(<span class="string">"AES/CBC/PKCS5PADDING"</span>);</span><br><span class="line">        instance.init(<span class="number">2</span>, secretKeySpec, ivParameterSpec);</span><br><span class="line">        readAllBytes = instance.doFinal(readAllBytes);</span><br><span class="line">        File file2 = <span class="keyword">new</span> File(context.getFilesDir(), p1Fn);</span><br><span class="line">        OutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(file2);</span><br><span class="line">        fileOutputStream.write(readAllBytes, <span class="number">0</span>, readAllBytes.length);</span><br><span class="line">        fileOutputStream.flush();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="keyword">return</span> file2;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Bu fonksiyonda önce 4byte’ın md5ini alıyor. Bu digest değerini aes keyi olarak kullanıyor ve input olarak verilen dosyayı decrypt ediyor. dp1’i çağırıken class’ın başında tanımlanmış<br><code>public static String p1EncFn = &quot;ckxalskuaewlkszdva&quot;;</code> değeri kullanılıyor. Apk’ımızın içerisindeki asset klasorune bakarsak bu dosyayı görebiliyoruz. Peki bu dosyayı decrypt edip ne yapıyor ?</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">cf</span><span class="params">(Context context, File file, String str)</span> </span>&#123;</span><br><span class="line">    File file2 = <span class="keyword">new</span> File(context.getFilesDir().getAbsolutePath());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class loadClass = <span class="keyword">new</span> DexClassLoader(file.getAbsolutePath(), file2.getAbsolutePath(), file2.getAbsolutePath(), ClassLoader.getSystemClassLoader()).loadClass(<span class="string">"ooo.p1.P1"</span>);</span><br><span class="line">        <span class="keyword">return</span> ((Boolean) loadClass.getDeclaredMethod(<span class="string">"cf"</span>, <span class="keyword">new</span> Class[]&#123;Context.class, String.class&#125;).invoke(loadClass, <span class="keyword">new</span> Object[]&#123;context, str&#125;)).booleanValue();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Decrypt edilen dosya DexClassLoader APIsi ile contexte yükleniyor. Bu olayı android malwarelerinde çok görüyoruz. Tersine mühendisliği zorlaştırmak için “packing” yöntemini sıklıkla kullanıyorlar. </p><p>ooo.p1.P1 class’ı invoke edilip o class içerisinden bir fonksiyon çağırılıyor. Bu fonksiyon boolean bir değer döndürüyor ( O fonksiyonda baska fonksiyonlar cagiriyor tabi ). Ve flagin doğruluğu kontrol edilmiş oluyor .</p><p>Aşama 1’i toparlasak:</p><ul><li>Flagin belli indexlerini XORla ve 4byte’ı al</li><li>md5</li><li>ckxalskuaewlkszdva dosyasını bu keyle decrypt et</li><li>decrypt edilen dosya içerisinden ooo.p1.P1 classını load et.</li></ul><p>Peki biz bu 4byte’ı nasıl bulabiliriz ?</p><p>Biliyoruzki decrypt edilen dosyanın bir jar dosyası olması lazım. Neden ? Çünkü kullanılan DexClassLoader fonksiyonu dosya formatı olarak jar kabul ediyor. Jar dosyaları da bir nevi zip ve zip dosyalarının Magic Byte’ını yani dosya tipini anladığımız header kısmını biliyoruz. <code>\x50\x4b\x03\x04</code> dosya headerı olarak bu byteları arayacağız.</p><p>Şimdi brute için şu şekilde bir python scripti yazalım:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">IV = bytes([<span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>])</span><br><span class="line">N_BIT = <span class="number">4</span></span><br><span class="line">S_BIT = <span class="number">2</span>**<span class="number">7</span> + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">DATA = open(<span class="string">'ckxalskuaewlkszdva'</span>, <span class="string">'rb'</span>).read(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key_1 <span class="keyword">in</span> range(S_BIT):</span><br><span class="line">    <span class="keyword">for</span> key_2 <span class="keyword">in</span> range(S_BIT):</span><br><span class="line">        print(key_1, key_2, end=<span class="string">'\r'</span>)</span><br><span class="line">        <span class="keyword">for</span> key_3 <span class="keyword">in</span> range(S_BIT):</span><br><span class="line">            <span class="keyword">for</span> key_4 <span class="keyword">in</span> range(S_BIT):</span><br><span class="line">                key = hashlib.md5(</span><br><span class="line">                    bytes([key_1, key_2, key_3, key_4])).digest()</span><br><span class="line">                aes = AES.new(key, AES.MODE_CBC, IV)</span><br><span class="line">                decrypted_data = aes.decrypt(DATA)</span><br><span class="line">                <span class="keyword">if</span> decrypted_data.startswith(<span class="string">b'\x50\x4b\x03\x04'</span>):</span><br><span class="line">                     print(key_1, key_2, key_3, key_4)</span><br><span class="line">                     IV = bytes([<span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>])</span><br><span class="line">                     f= open(<span class="string">"ckxalskuaewlkszdva"</span>,<span class="string">"rb"</span>)</span><br><span class="line">                     DATA = f.read()</span><br><span class="line">                     f.close()</span><br><span class="line">                     key = hashlib.md5(</span><br><span class="line">                        bytes([key_1, key_2, key_3, key_4])).digest()</span><br><span class="line">                     aes = AES.new(key, AES.MODE_CBC, IV)</span><br><span class="line">                     decrypted_data = aes.decrypt(DATA)</span><br><span class="line">                     f = open(<span class="string">"out.zip"</span>,<span class="string">"wb"</span>)</span><br><span class="line">                     f.write(decrypted_data)</span><br><span class="line">                     f.close()</span><br></pre></td></tr></table></figure><p>Girdiğimiz stringler sonuçta ASCII yani 7bitlik aralıkta olduğu için XOR sonucu elde edilecek byte aralığıda bu aralığa sahip olmak zorunda. </p><p>Burda dikkatinizi <code>DATA = open(&#39;ckxalskuaewlkszdva&#39;, &#39;rb&#39;).read(32)</code> satırına vermenizi rica ediyorum. Neden 32 byte okuyorum burada ? </p><p><a href="aes.png">aes</a></p><p>AES CBC encryption şemasında sizin dosyanız ne kadar büyüse de ilk bloğun son halini ilgilendiren bir olay gerçekleşmiyor. Yani biz sadece ilk blok için deneme yaparak keyi bulabiliriz. Bu çok büyük ölçüde işimizi kolaylaştırıyor. 1.6 MB dosyanın boyutunu 32byte’a düşürmüş oluyoruz. </p><p>Bu scripti çalıştırdığımızda birkaç dakika içerisinde ilk keyimizi alıyoruz.</p><p>Key 1 : <code>\x17\x01\x2f\x03</code></p><p>Her aşamamızda flagin belirli bytelarına dair bilgi ede ede ilerliyoruz. </p><h2 id="Asama-2-SO"><a href="#Asama-2-SO" class="headerlink" title="Aşama 2 : SO"></a>Aşama 2 : SO</h2><p>İlk aşamaya benzer bir dex dosyası ile karşılaşıyoruz.</p><p>Bu sefer jar dosyası yerine bir adet <code>.so</code> dosyası oluşturulması gerekiyor ve XORlanan indexler değişik.</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i2 = <span class="number">0</span>; i2 &lt; <span class="number">10</span>; i2 += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        bArr[i] = (byte) ((byte) (bArr[i] ^ bytes[((i2 + <span class="number">1</span>) * <span class="number">4</span>) + i]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">4</span>]^flag[<span class="number">12</span>]^flag[<span class="number">20</span>]^flag[<span class="number">28</span>]^flag[<span class="number">36</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">5</span>]^flag[<span class="number">13</span>]^flag[<span class="number">21</span>]^flag[<span class="number">29</span>]^flag[<span class="number">37</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">6</span>]^flag[<span class="number">14</span>]^flag[<span class="number">22</span>]^flag[<span class="number">30</span>]^flag[<span class="number">38</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">7</span>]^flag[<span class="number">15</span>]^flag[<span class="number">23</span>]^flag[<span class="number">31</span>]^flag[<span class="number">39</span>]</span><br></pre></td></tr></table></figure><p>Aynı scripti kullanarak zip headeri yerine .so dosyanın yani ELF headerini <code>\x7f\x45\x4c\x46</code> yazıyoruz, input dosyasını <code>mmdffuoscjdamcnssn</code> olarak değiştirip ikinici keyimizi de alıyoruz.</p><p>Key2 : <code>\x3c\x27\x43\x60</code></p><h2 id="Asama-3-Shellkod"><a href="#Asama-3-Shellkod" class="headerlink" title="Aşama 3 Shellkod:"></a>Aşama 3 Shellkod:</h2><p>Bu sefer işler değişiyor. Biliyoruzki so dosyasından xxx fonksiyonu çağırılıyor. </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> String <span class="title">xxx</span><span class="params">(String str, String str2)</span></span>;</span><br></pre></td></tr></table></figure><p>So dosyanı IDA ile açıp incelediğimizde bu fonksiyonu görebiliyoruz.</p><p><img src="ida1.png" alt="ida1.png"></p><p>Daha kolay anlaşılması için değişken ve fonksiyonlari isimlendirdim.</p><p>Önce asset klasorunden <code>xtszswemcwohpluqmi</code> dosyası okunuyor ve key hesaplandıktan sonra bu dosya decrypt ediliyor. Bu sefer biraz olaylar farklı. Keyi hesaplamak için fonksiyon şu şekilde:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">K2_0 = <span class="number">0</span>;</span><br><span class="line">flaga = flag + <span class="number">4</span>;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">3</span>; i &lt; <span class="number">10</span>; i += <span class="number">3</span> )</span><br><span class="line">  K2_0 ^= *&amp;flaga[<span class="number">4</span> * (i - <span class="number">1</span>)];</span><br><span class="line"><span class="keyword">return</span> K2_0;</span><br></pre></td></tr></table></figure><p>yani : </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">8</span>]^flag[<span class="number">20</span>]^flag[<span class="number">32</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">9</span>]^flag[<span class="number">21</span>]^flag[<span class="number">33</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">10</span>]^flag[<span class="number">22</span>]^flag[<span class="number">34</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">11</span>]^flag[<span class="number">23</span>]^flag[<span class="number">35</span>]</span><br></pre></td></tr></table></figure><p>Key hesaplandiktan sonra: </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i )</span><br><span class="line"> &#123;</span><br><span class="line">   *&amp;p3enc[<span class="number">4</span> * i] ^= K2_0;</span><br><span class="line">   K2_0 += <span class="number">0x31333337</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p> fonksiyonuna veriliyor ve dosya bu şekilde decrypt ediliyor. Peki bu sefer neye göre decrypt edicez ? Decrypt edildikten sonra bir assembly kodu elde ediceğimiz belli. Çünkü fonksiyonun devamında bu alani fonksiyon şeklinde çağrılıyor. </p><p><img src="ida2.png" alt="ida2"></p><p> Bu cepte. Fonksiyon çağırılmadan önceki android log’unun bastığı değere baktığımızda </p><p> <code>Jumping to nopsled in 3, 2, 1, ...</code> stringini görüyoruz. Nop sled ne demekti shellkod demekti. NOP instructionunı shellkod yazan herkes illaki kullanmıştır. Instruction’ın byte karşılığı <code>0x90</code>. Sled olunca da bundan bir sürü demek. Decrypt ederken 4byte 4byte gidildiği için encrypted dosyanın ilk 4 byteını <code>0x90909090</code> ile XORlarsak keyimizi elde ederiz. </p><p><code>hex(0x90909090^0xfef3b7de)</code> :  <code>\x6e\x63\x27\x4e</code> keyini veriyor. Bu key ile dosyayi decrypt etmek istersek :</p><p>Key3: <code>\x6e\x63\x27\x4e</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"xtszswemcwohpluqmi"</span>,<span class="string">"rb"</span>)</span><br><span class="line">data = f.read()</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">#K2_0 = hex(0x90909090^0xfef3b7de)</span></span><br><span class="line"><span class="comment">#endianess</span></span><br><span class="line">K2_0 = <span class="number">0x4e27636e</span></span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"shell_out.dat"</span>,<span class="string">"wb"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line"></span><br><span class="line">    f.write(xor(data[<span class="number">4</span>*i:<span class="number">4</span>*i+<span class="number">4</span>],p32(K2_0)))</span><br><span class="line">    K2_0 += <span class="number">0x31333337</span></span><br><span class="line">    K2_0 = K2_0 &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>Oluşan dosyayı <code>ndisasm -b 32 shell_out.dat</code> şeklinde kontrol edebilirsiniz.</p><h2 id="Asama-4-ROP"><a href="#Asama-4-ROP" class="headerlink" title="Aşama 4 : ROP"></a>Aşama 4 : ROP</h2><p>En zor kısım burası. Shellkodun ne yaptığını anlamamız gerek.</p><p>Fonksiyona girmeden önce stackteki değerlerimize bakalım:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.text:00008C8F                 mov     edx, [ebp+flag?]</span><br><span class="line">.text:00008C92                 mov     ebx, [ebp+cx_data]</span><br><span class="line">.text:00008C98                 mov     esi, [ebp+size]</span><br><span class="line">.text:00008C9E                 mov     [esp], edx      ; s</span><br><span class="line">.text:00008CA1                 mov     [esp+4], ebx    ; src</span><br><span class="line">.text:00008CA5                 mov     [esp+8], esi    ; n</span><br><span class="line">.text:00008CB5                 call    ecx</span><br></pre></td></tr></table></figure></p><p>Shellkod çağırılırken ret adresi de pushlanacağı için stack değerlerimiz 4 artıyor.</p><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">90</span>                nop</span><br><span class="line">E800000000        call <span class="number">0x25</span>           <span class="comment">// 0x25i stacke pushla</span></span><br><span class="line"><span class="number">5B</span>                pop ebx             <span class="comment">// ebx = 0x25</span></span><br><span class="line"><span class="number">83</span>EB05            sub ebx,byte +<span class="number">0x5</span>   <span class="comment">// ebx = 0x20</span></span><br><span class="line"><span class="number">83</span>EB20            sub ebx,byte +<span class="number">0x20</span>  <span class="comment">// ebx = 0x0 + (Shellkodun yüklendiği base)</span></span><br><span class="line"><span class="number">8B</span>7C2404          mov edi,[esp+<span class="number">0x4</span>]   <span class="comment">//flag</span></span><br><span class="line"><span class="number">31</span>C9              xor ecx,ecx         </span><br><span class="line"><span class="number">83</span>C710            add edi,byte +<span class="number">0x10</span>  <span class="comment">//4byte kaydır = flag[0]</span></span><br><span class="line">BA02000000        mov edx,<span class="number">0x2</span>         </span><br><span class="line"><span class="number">330F</span>              xor ecx,[edi]       <span class="comment">//flag[i:i+4] ^ ecx</span></span><br><span class="line"><span class="number">83</span>C710            add edi,byte +<span class="number">0x10</span>  <span class="comment">//4byte kaydır</span></span><br><span class="line"><span class="number">83</span>EA01            sub edx,byte +<span class="number">0x1</span>   <span class="comment">//edxi azalt</span></span><br><span class="line"><span class="number">75F</span>6              jnz <span class="number">0x3a</span>            <span class="comment">//loop 2 yapıcak yani flag[0:4] ^ flag[16:20]</span></span><br><span class="line"><span class="number">83</span>EF20            sub edi,byte +<span class="number">0x20</span>  <span class="comment">//flagın basına geri dön</span></span><br><span class="line"><span class="number">89</span>D8              mov eax,ebx         <span class="comment">//eax = 0</span></span><br><span class="line"><span class="number">05</span>C8000000        add eax,<span class="number">0xc8</span>        <span class="comment">//eax = 200;</span></span><br><span class="line">BA32000000        mov edx,<span class="number">0x32</span>        <span class="comment">//edx = 50;</span></span><br><span class="line"><span class="number">3108</span>              xor [eax],ecx       <span class="comment">//ecxte key vardı; 200 ofsetindeki değerler anlamsız</span></span><br><span class="line"><span class="number">83</span>C004            add eax,byte +<span class="number">0x4</span>   <span class="comment">//4byte ilerle</span></span><br><span class="line"><span class="number">83</span>EA01            sub edx,byte +<span class="number">0x1</span>   <span class="comment">//edx-1 ; 50 kez xorlanıcak; 50*4 =200; 200+200=400 tam dosya boyu</span></span><br><span class="line"><span class="number">75F</span>6              jnz <span class="number">0x53</span>            <span class="comment">//loop; yine bir decryption </span></span><br><span class="line"><span class="number">89</span>D8              mov eax,ebx         <span class="comment">//eax = 0</span></span><br><span class="line"><span class="number">052</span>C010000        add eax,<span class="number">0x12c</span>       <span class="comment">//eax = 300</span></span><br><span class="line">BA19000000        mov edx,<span class="number">0x19</span>        <span class="comment">//edx = 25</span></span><br><span class="line"><span class="number">0118</span>              add [eax],ebx       <span class="comment">//[eax]taki değerlere base'i ekle </span></span><br><span class="line"><span class="number">83</span>C004            add eax,byte +<span class="number">0x4</span>   <span class="comment">//4byte ilerle</span></span><br><span class="line"><span class="number">83</span>EA01            sub edx,byte +<span class="number">0x1</span>   <span class="comment">//dec</span></span><br><span class="line"><span class="number">75F</span>6              jnz <span class="number">0x69</span>            <span class="comment">//loop</span></span><br><span class="line"><span class="number">89</span>D8              mov eax,ebx         <span class="comment">//eax = base</span></span><br><span class="line"><span class="number">052</span>C010000        add eax,<span class="number">0x12c</span>       <span class="comment">//eax = 300</span></span><br><span class="line"><span class="number">89E2</span>              mov edx,esp         <span class="comment">//save esp</span></span><br><span class="line"><span class="number">8B</span>7C2404          mov edi,[esp+<span class="number">0x4</span>]   <span class="comment">//edi = flag</span></span><br><span class="line"><span class="number">8B</span>742408          mov esi,[esp+<span class="number">0x8</span>]   <span class="comment">//esi = data</span></span><br><span class="line"><span class="number">8B</span>5C240C          mov ebx,[esp+<span class="number">0xc</span>]   <span class="comment">//ebx = size</span></span><br><span class="line"><span class="number">89</span>C4              mov esp,eax         <span class="comment">//esp = 300</span></span><br><span class="line">C3                ret</span><br></pre></td></tr></table></figure><p>Simdi kodumuz ne yapıyor kabaca bahsedersek:</p><ul><li>Key hesapla</li><li>200-400 arasını bu key ile xorla</li><li>300den sonrası için shellkodun yüklendiği base’i ekle</li><li>esp’ye 300un offsetini ata</li><li>ret</li><li>ret’ten sonra kod executionu 300den devam edicek</li></ul><p>Şimdi bizim if’i geçebilmemiz için bu fonksiyondan dönen değerin 0x31337 olması lazım. Şuan görünürde bu değer yok. 300’e gittikten sonra bu işi yapması lazım.</p><p>200-400 arasını XORlayacak keyi bulmak için bu aralığa bir bakalım.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">000000c0: 9090 9090 9090 9090 fa18 3313 42db b0d3  ..........3.B...</span><br><span class="line">000000d0: 46db f09a b2db b815 8129 3dd0 c1de 37d0  F........)=...7.</span><br><span class="line">000000e0: c1f3 37d0 3c19 f04b 819b df0b 81a0 3a13  ..7.&lt;..K......:.</span><br><span class="line">000000f0: 4218 f0ab 750b 3013 8191 ebd0 cbd3 f09a  B...u.0.........</span><br><span class="line">00000100: 8adb f2d2 4adb 02da 812b 7c07 812b 7c3b  ....J....+|..+|;</span><br><span class="line">00000110: 8188 a383 d288 a383 d288 a383 d288 a383  ................</span><br><span class="line">00000120: d288 a383 d288 a383 d288 a383 4419 3313  ............D.3.</span><br><span class="line">00000130: 4b19 3313 4f19 3313 9b18 3313 9e18 3313  K.3.O.3...3...3.</span><br><span class="line">00000140: 4019 3313 a218 3313 a618 3313 ab18 3313  @.3...3...3...3.</span><br><span class="line">00000150: b118 3313 c918 3313 4218 3313 4218 3313  ..3...3.B.3.B.3.</span><br><span class="line">00000160: 4218 3313 4218 3313 4218 3313 4218 3313  B.3.B.3.B.3.B.3.</span><br><span class="line">00000170: 4218 3313 4218 3313 4218 3313 4218 3313  B.3.B.3.B.3.B.3.</span><br><span class="line">00000180: 4218 3313 4218 3313 4218 3313 4218 3313  B.3.B.3.B.3.B.3.</span><br></pre></td></tr></table></figure><p>Bloğun sonuna bakarsanız hep tekrar eden değerler görüyoruz. Bloğun başı işe anlamsız datalardan oluşuyor. Burda bloğun sonunun 0x0 lerle bittiğini düşünerek XOR keyi olarak 0x42183313 kullandım. </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00000000  B800000000        mov eax,0x0</span><br><span class="line">00000005  C3                ret</span><br><span class="line">00000006  83C004            add eax,byte +0x4</span><br><span class="line">00000009  C3                ret</span><br><span class="line">0000000A  C3                ret</span><br><span class="line">0000000B  89F0              mov eax,esi</span><br><span class="line">0000000D  C3                ret</span><br><span class="line">0000000E  8B06              mov eax,[esi]</span><br><span class="line">00000010  C3                ret</span><br><span class="line">00000011  310E              xor [esi],ecx</span><br><span class="line">00000013  C3                ret</span><br><span class="line">00000014  83C604            add esi,byte +0x4</span><br><span class="line">00000017  C3                ret</span><br><span class="line">00000018  83EB04            sub ebx,byte +0x4</span><br><span class="line">0000001B  C3                ret</span><br><span class="line">0000001C  7E01              jng 0x1f</span><br><span class="line">0000001E  C3                ret</span><br><span class="line">0000001F  58                pop eax</span><br><span class="line">00000020  C3                ret</span><br><span class="line">00000021  83EC18            sub esp,byte +0x18</span><br><span class="line">00000024  C3                ret</span><br><span class="line">00000025  B809000000        mov eax,0x9</span><br><span class="line">0000002A  C3                ret</span><br><span class="line">0000002B  B837130300        mov eax,0x31337</span><br><span class="line">00000030  C3                ret</span><br><span class="line">00000031  89D8              mov eax,ebx</span><br><span class="line">00000033  C3                ret</span><br><span class="line">00000034  89CB              mov ebx,ecx</span><br><span class="line">00000036  C3                ret</span><br><span class="line">00000037  89C8              mov eax,ecx</span><br><span class="line">00000039  C3                ret</span><br><span class="line">0000003A  C1C108            rol ecx,byte 0x8</span><br><span class="line">0000003D  C3                ret</span><br><span class="line">0000003E  31C9              xor ecx,ecx</span><br><span class="line">00000040  C3                ret</span><br><span class="line">00000041  334F14            xor ecx,[edi+0x14]</span><br><span class="line">00000044  C3                ret</span><br><span class="line">00000045  334F28            xor ecx,[edi+0x28]</span><br><span class="line">00000048  C3                ret</span><br><span class="line">...</span><br><span class="line">00000063  90                nop</span><br><span class="line">00000064  06                push es</span><br><span class="line">00000065  0100              add [eax],eax</span><br><span class="line">00000067  0009              add [ecx],cl</span><br><span class="line">00000069  0100              add [eax],eax</span><br><span class="line">0000006B  000D010000D9      add [dword 0xd9000001],cl</span><br><span class="line">00000071  0000              add [eax],al</span><br><span class="line">00000073  00DC              add ah,bl</span><br><span class="line">00000075  0000              add [eax],al</span><br><span class="line">00000077  0002              add [edx],al</span><br><span class="line">00000079  0100              add [eax],eax</span><br><span class="line">0000007B  00E0              add al,ah</span><br><span class="line">0000007D  0000              add [eax],al</span><br><span class="line">0000007F  00E4              add ah,ah</span><br><span class="line">00000081  0000              add [eax],al</span><br><span class="line">00000083  00E9              add cl,ch</span><br><span class="line">00000085  0000              add [eax],al</span><br><span class="line">00000087  00F3              add bl,dh</span><br></pre></td></tr></table></figure><p>Bloğumuzun başı rop gadgetleri. Altı ise bu gadgetların adresleri. Disasm bozuk göstersede şu şekilde :</p><p>0x0106 0x0109 0x010d 0x00d9 .. 0x00f3 </p><p>Bu değerler espye atanmıştı. ret yapıldıkça bu değerler poplana poplana gidicek. Yani bu bizim çalışacak kodumuz. Şimdi fonksiyonun 0x31337 dönmesini istiyorduk. Bakalım rop chain döndürüyormu. Son offset 0xf3</p><p>200’u 0 kabul edip hesaplarsak : <code>hex(0xf3-200)</code> : 0x2b . Şimdi yukarıdan 0x2bye bakalım.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0000002B  B837130300        mov eax,0x31337</span><br><span class="line">00000030  C3                ret</span><br></pre></td></tr></table></figure><p>evet istediğimiz değer dönüyor. Rop için key:</p><p>Bu aşamadaki key şu şekilde hesaplanıyor : </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">16</span>]^flag[<span class="number">32</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">17</span>]^flag[<span class="number">33</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">18</span>]^flag[<span class="number">34</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">19</span>]^flag[<span class="number">35</span>]</span><br></pre></td></tr></table></figure><p>Bulduğumuz xor keyi :</p><p>Key4 : <code>\x42\x18\x33\x13</code></p><h2 id="Asama-5-JS"><a href="#Asama-5-JS" class="headerlink" title="Aşama 5 : JS"></a>Aşama 5 : JS</h2><p>Tabi rop chain sadece 0x31337 döndürmüyor ondan öncesinde fonksiyona verilen başka bir encrypted datayı decrypt ediyor. </p><p><img src="ida3.png" alt="ida3"></p><p>Bir html dosyası. Html dosyasini rop chain oluşturuyor. Cağırılan gadgetlara bakalim:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xor_ecx_ecx         </span><br><span class="line">xor_ecx_[edi+20]    //flag[20:24]</span><br><span class="line">xor_ecx_[edi+40]    //flag[40:44] ^ flag[20:24]</span><br><span class="line">xor_[esi]_ecx       //eside encrypted data var</span><br><span class="line">add_esi_4           //esi_4</span><br><span class="line">rol_ecx_8           //rotate left ecx</span><br><span class="line">sub_ebx_4           //size - 4</span><br><span class="line">loop</span><br><span class="line">mov_eax_31337</span><br></pre></td></tr></table></figure><p>Rotate left yapmadan önce ilk aşamada direk gelen xorkeyi kullaniliyor. Bu yüzden yine xor keyini hesaplayabiliriz. Headerin html olduğunu biliyoruz. Encrypted dosyanın ilk 4byte’ı ile xorlarsak</p><p>Key5: = hex(0x3c68746d^0x6a452630): <code>\x56\x2d\x52\x5d</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">20</span>]^flag[<span class="number">40</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">21</span>]^flag[<span class="number">41</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">22</span>]^flag[<span class="number">42</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">23</span>]^flag[<span class="number">43</span>]</span><br></pre></td></tr></table></figure><p>Decryption routinini implemente edicek python scripti yazalim:<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = open(<span class="string">"assets/cxnvhaekljlkjxxqkq"</span>,<span class="string">"rb"</span>)</span><br><span class="line">data = f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment">#rol8 4 iterasyondan sonra kendisine geri dönücek</span></span><br><span class="line">a = [<span class="number">0x562d525d</span>,<span class="number">0x5d562d52</span>,<span class="number">0x525d562d</span>,<span class="number">0x2d525d56</span>]</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"bam.html"</span>,<span class="string">"wb"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(int(len(data)/<span class="number">4</span>)):</span><br><span class="line"></span><br><span class="line">    f.write(xor(data[<span class="number">4</span>*i:<span class="number">4</span>*i+<span class="number">4</span>],p32(a[i%<span class="number">4</span>])))</span><br><span class="line"></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure></p><p>Bam.htmli ilk açtığımız apk dosyasından hatırlarsak : </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(mainActivity.getFilesDir(), <span class="string">"bam.html"</span>);</span><br><span class="line">WebView webView = mainActivity.mWebView;</span><br><span class="line">StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">stringBuilder.append(<span class="string">"file:///"</span>);</span><br><span class="line">stringBuilder.append(file.getAbsolutePath());</span><br><span class="line">stringBuilder.append(<span class="string">"?flag="</span>);</span><br><span class="line">stringBuilder.append(Uri.encode(str));</span><br><span class="line">webView.loadUrl(stringBuilder.toString());</span><br><span class="line">z = mValid;</span><br></pre></td></tr></table></figure><p>Son aşama olarak flag stringi bu html dosyasına parametre olarak gidiyor. Html dosyasını açtığımızda obfuscated bir javascriptle karşılaşıyoruz. <a href="https://twitter.com/theempire_h" target="_blank" rel="noopener">theempire_</a> saolsun bu adımı tak diye çözdü. Flagin 24. karakterinden sornasinın <code>=&gt; pHd_1w_e4rL13r;)}</code> ‘a eşit olması gerektiğini anlıyoruz.</p><p>Elimizde 5 key ve flagin 24-44 arası karakterleri var. </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key0_0 = <span class="string">"4 ^ 12 ^ 20 ^ 28 ^ 36"</span></span><br><span class="line">key0_1 = <span class="string">"5 ^ 13 ^ 21 ^ 29 ^ 37"</span></span><br><span class="line">key0_2 = <span class="string">"6 ^ 14 ^ 22 ^ 30 ^ 38"</span></span><br><span class="line">key0_3 = <span class="string">"7 ^ 15 ^ 23 ^ 31 ^ 39"</span></span><br><span class="line"></span><br><span class="line">key1_0 = <span class="string">"8 ^ 16 ^ 24 ^ 32 ^ 40"</span></span><br><span class="line">key1_1 = <span class="string">"9 ^ 17 ^ 25 ^ 33 ^ 41"</span></span><br><span class="line">key1_0 = <span class="string">"10 ^ 18 ^ 26 ^ 34 ^ 42"</span></span><br><span class="line">key1_1 = <span class="string">"11 ^ 19 ^ 27 ^ 35 ^ 43"</span></span><br><span class="line"></span><br><span class="line">key2_0 = <span class="string">"12 ^ 24 ^ 36"</span></span><br><span class="line">key2_1 = <span class="string">"13 ^ 25 ^ 37"</span></span><br><span class="line">key2_2 = <span class="string">"14 ^ 26 ^ 38"</span></span><br><span class="line">key2_3 = <span class="string">"15 ^ 27 ^ 39"</span></span><br><span class="line"></span><br><span class="line">key3_0 = <span class="string">"16 ^ 32"</span></span><br><span class="line">key3_1 = <span class="string">"17 ^ 33"</span></span><br><span class="line">key3_2 = <span class="string">"18 ^ 34"</span></span><br><span class="line">key3_3 = <span class="string">"19 ^ 35"</span></span><br><span class="line"></span><br><span class="line">key4_0 = <span class="string">"20 ^ 40"</span></span><br><span class="line">key4_1 = <span class="string">"21 ^ 41"</span></span><br><span class="line">key4_2 = <span class="string">"22 ^ 42"</span></span><br><span class="line">key4_3 = <span class="string">"23 ^ 43"</span></span><br></pre></td></tr></table></figure><p>Biraz kopya cekerek script yazarsak.</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">key0 = <span class="string">b'\x17\x01\x2f\x03'</span></span><br><span class="line">key1 = <span class="string">b'\x3c\x27\x43\x60'</span></span><br><span class="line">key2 = <span class="string">b'\x6e\x63\x27\x4e'</span></span><br><span class="line">key3 = <span class="string">b'\x42\x18\x33\x13'</span></span><br><span class="line">key4 = <span class="string">b'\x56\x2d\x52\x5d'</span></span><br><span class="line"></span><br><span class="line">f6, f7, f8, f9, f10 = group(<span class="number">4</span>, <span class="string">' =&gt; pHd_1w_e4rL13r;)'</span>)</span><br><span class="line">f5 = xor(key4, f10)</span><br><span class="line">f4 = xor(key3, f8)</span><br><span class="line">f3 = xor(xor(key2, f6), f9)</span><br><span class="line">f2 = xor(xor(xor(xor(key1, f4), f6), f8), f10)</span><br><span class="line">f1 = xor(xor(xor(xor(xor(key0, key1), f3), f5), f7), f9)</span><br><span class="line"></span><br><span class="line">theflag = <span class="string">'OOO&#123;'</span> + f1 + f2 + f3 + f4 + f5 + f6 + f7 + f8 + f9 + f10 + <span class="string">'&#125;'</span></span><br><span class="line"><span class="keyword">print</span> theflag</span><br></pre></td></tr></table></figure><p>flag : <code>OOO{pox&amp;mpuzz,U_solve_it =&gt; pHd_1w_e4rL13r;)}</code></p>]]></content>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Android </tag>
            
            <tag> Reverse </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>DEF CON Quals 2019 : VERYANDROIDOSO</title>
      <link href="/DEF-CON-Quals-2019-Veryandroidoso/"/>
      <url>/DEF-CON-Quals-2019-Veryandroidoso/</url>
      <content type="html"><![CDATA[<p>Here is my writeup for <code>VERYANDROIDOSO</code> <a href="ooo.defcon2019.quals.veryandroidoso.apk">task</a>. Ofcourse with frida :D<br><img src="33.png" alt=""></p><p>App takes input from us and checks if it is correct flag. Length of flag should be 23 enclosed with OOO{..}. Also inside of brackets only hex [0-9a-f].<br>18(23-5) divided into 9 part with each part length of 2. </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Button button = (Button) findViewById(R.id.button);</span><br><span class="line"><span class="keyword">final</span> EditText editText = (EditText) findViewById(R.id.editText);</span><br><span class="line">button.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        view = MainActivity.<span class="keyword">this</span>.parse(editText.getText().toString());</span><br><span class="line">        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Solver.solve(view[<span class="number">0</span>], view[<span class="number">1</span>], view[<span class="number">2</span>], view[<span class="number">3</span>], view[<span class="number">4</span>], view[<span class="number">5</span>], view[<span class="number">6</span>], view[<span class="number">7</span>], view[<span class="number">8</span>]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                MainActivity.<span class="keyword">this</span>.win();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                MainActivity.<span class="keyword">this</span>.fail();</span><br><span class="line">            &#125;</span><br><span class="line">            MainActivity.<span class="keyword">this</span>.finish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        MainActivity.<span class="keyword">this</span>.fail();</span><br><span class="line">        MainActivity.<span class="keyword">this</span>.finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Solverrr"><a href="#Solverrr" class="headerlink" title="Solverrr"></a>Solverrr</h2><p>In solver class there are <code>solver</code>, <code>getSecretNumber</code>, <code>scramble</code>(not really), <code>sleep (!)</code>:<br>and exported functions from native-lib:</p><p><code>m0, m1, m2, m3, m4, m6, m7, m8, m9</code></p><ul><li><p><code>getSecretNumber</code> gets one byte from hash of certificate of application. So its always returns same value to same input.</p></li><li><p><code>sleep</code> function takes input, and sleep nanosecond*input and returns how much nanosecond is passed (which can be vary).</p></li><li><p><code>scramble</code> does following :</p></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">scramble</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sleep = ((<span class="keyword">int</span>) sleep(<span class="number">500</span>)) - <span class="number">499</span>;</span><br><span class="line">    <span class="keyword">return</span> ((i + ((<span class="keyword">int</span>) Math.round(Math.sqrt((<span class="keyword">double</span>) ((sleep * <span class="number">4</span>) * sleep)) / ((<span class="keyword">double</span>) sleep)))) + <span class="number">321</span>) % <span class="number">256</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Looks like it depends on output of sleep function ? </p><p>Nope :D because sqrt(4sleep^2)/sleep always returns 2. So overall scramble is same as <code>return (i+2+321)%256</code><br>Same as <code>getSecretNumber</code> this function is always returns same value to same input.</p><ul><li>If you open up ghidra and <a href="dec.c">decompile</a> you can see that m0-m1-m2-m3-m4-m6 doesn’t depend on any value other than its inputs. But<br>m7 depends on s1 and s2. m8 depends on s3 and s4. If you look at offset of s4, you can see it is not defined. m9 takes one input and <code>CREATES</code> s4 data.<br>So m9 is very important to m8’s operations and output. s1, s2 and s3 is already defined in binary and never changed with any other function.</li></ul><p>Now comes fun part.</p><h2 id="Fridaa"><a href="#Fridaa" class="headerlink" title="Fridaa"></a>Fridaa</h2><p>in solve function there are huge if blocks for each input part.</p><p>For i1 code is as follows :</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> scramble = scramble(<span class="number">13</span>);</span><br><span class="line">        <span class="keyword">if</span> (i1 == <span class="number">0</span>) &#123;</span><br><span class="line">            m0 = m0(<span class="number">100</span>, getSecretNumber(scramble));</span><br><span class="line">            i10 = <span class="number">255</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i1 == <span class="number">1</span>) &#123;</span><br><span class="line">            m0 = m0(<span class="number">190</span>, getSecretNumber(scramble));</span><br><span class="line">            i10 = <span class="number">255</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i1 == <span class="number">2</span>) &#123;</span><br><span class="line">            m0 = m0(<span class="number">88</span>, getSecretNumber(scramble));</span><br><span class="line">            i10 = <span class="number">255</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i1 == <span class="number">3</span>) &#123;</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((m0 &amp; i10) != <span class="number">172</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>To not return false, we need to find correct m0 value . which is <code>m0 &amp; 255 == 172</code> . iff m0 = 172 . As you can see m0 set with output of m0 function.<br>So we need to find correct first parameter to m0. How ? frida :D</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Java.perform(function()&#123;</span><br><span class="line"></span><br><span class="line">    b = Java.use(<span class="string">"ooo.defcon2019.quals.veryandroidoso.Solver"</span>)</span><br><span class="line"></span><br><span class="line">    b.sleep.implementation = function(a)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">501</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    b.getSecretNumber.implementation = function(a)&#123;</span><br><span class="line">        r = <span class="keyword">this</span>.getSecretNumber(a)</span><br><span class="line">        console.log(<span class="string">"Secret  "</span> + r + <span class="string">" "</span> + a)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">    &#125;</span><br><span class="line">    b.scramble.implementation = function(a)&#123;</span><br><span class="line">        r = <span class="keyword">this</span>.scramble(a)</span><br><span class="line">        console.log(<span class="string">"Scramble  "</span> + r + <span class="string">" "</span> + a)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i &lt; <span class="number">255</span>;i++)&#123;</span><br><span class="line">        jj = parseInt(b.m0(i,<span class="number">113</span>))&amp;<span class="number">255</span></span><br><span class="line">        <span class="keyword">if</span>(jj == <span class="number">172</span>)&#123;</span><br><span class="line">            console.log(<span class="string">"m0 = "</span> + i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>How did I know second parameter of m0 ?. Lets just give random input : <code>OOO{123456789012345678}</code></p><p>Attach with <code>frida -U --no-pause  -f ooo.defcon2019.quals.veryandroidoso -l 1.txt</code></p><p>Then frida outputs : </p><p><code>Scramble  80 13Secret  113 80</code></p><p>secret function output is 113.</p><p>Then I bruteforced all values for m0 in for loop. Frida says m0 should be 53. 53 is input to m0. And we have just 1 option since we ANDed with 255.<br>If you search <code>m0(53,</code> in jadx you can find i1 == 250. Our first byte is 0xfa . If it is correct then We must see second scramble output in frida.</p><p>Try <code>OOO{fa3456789012345678}</code></p><p>Same script gives:</p><p><code>Scramble  80 13Secret  113 80Scramble  147 80Secret  201 147</code></p><p>So it is correct !</p><p>For i2 AND<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (i2 == <span class="number">254</span>) &#123;</span><br><span class="line">          m0 = m1(<span class="number">198</span>, getSecretNumber(scramble));</span><br><span class="line">          i10 = <span class="number">255</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          i10 = <span class="number">255</span>;</span><br><span class="line">          m0 = i2 == <span class="number">255</span> ? m1(<span class="number">220</span>, getSecretNumber(scramble)) : <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((m0 &amp; i10) != <span class="number">6</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p><p>Our condition is m0 &amp; 255 == 6, m0 should be 6. You can find correct secret value same as in step 1. So our for new for loop is :</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i &lt; <span class="number">255</span>;i++)&#123;</span><br><span class="line">    jj = <span class="built_in">parseInt</span>(b.m1(i,<span class="number">201</span>))&amp;<span class="number">255</span></span><br><span class="line">    <span class="keyword">if</span>(jj == <span class="number">6</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"m1 = "</span> + i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Add it to frida script. Then output is :<br><code>m0 = 53,m1 = 35</code>  =&gt; i2 = 180</p><p>[250,180] </p><p>So far so good.</p><p>For i3 :</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">else</span> <span class="keyword">if</span> (i3 == <span class="number">254</span>) &#123;</span><br><span class="line">    i10 = m2(<span class="number">7</span>, getSecretNumber(scramble));</span><br><span class="line">    m0 = <span class="number">251</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    i10 = i3 == <span class="number">255</span> ? m2(<span class="number">161</span>, getSecretNumber(scramble)) : <span class="number">0</span>;</span><br><span class="line">    m0 = <span class="number">251</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((i10 &amp; m0) != <span class="number">146</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This time output is ANDed with 251. i10 &amp; 251 == 146 gives two option.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i &lt; <span class="number">255</span>;i++)&#123;</span><br><span class="line">    jj = <span class="built_in">parseInt</span>(b.m2(i,<span class="number">132</span>))&amp;<span class="number">251</span></span><br><span class="line">    <span class="keyword">if</span>(jj == <span class="number">146</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"m2 = "</span> + i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>m2 = 7 and m2 = 11 ==&gt; 254 and 52</p><p>.<br>.<br>.</p><p>Overall <a href="dc.txt">dc.txt</a> gives :<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">m0 = 53</span><br><span class="line">m1 = 35</span><br><span class="line">m2 = 7,m2 = 11</span><br><span class="line">m3 = 132,m3 = 140</span><br><span class="line">m4 = 13,m4 = 14,m4 = 17,m4 = 18,m4 = 29,m4 = 30,m4 = 33,m4 = 34,m4 = 45,m4 = 46,m4 = 49,m4 = 50,m4 = 61,m4 = 62,m4 = 65,m4 = 66</span><br><span class="line">m5 = 65,m5 = 67,m5 = 69,m5 = 71,m5 = 73,m5 = 75,m5 = 77,m5 = 79,m5 = 81,m5 = 83,m5 = 85,m5 = 87,m5 = 89,m5 = 91,m5 = 93,m5 = 95,m5 = 97,m5 = 99,m5 = 101,m5 = 103,m5 = 105,m5 = 107,m5 = 109,m5 = 111,m5 = 113,m5 = 115,m5 = 117,m5 = 119,m5 = 121,m5 = 123,m5 = 125,m5 = 127,m5 = 193,m5 = 195,m5 = 197,m5 = 199,m5 = 201,m5 = 203,m5 = 205,m5 = 207,m5 = 209,m5 = 211,m5 = 213,m5 = 215,m5 = 217,m5 = 219,m5 = 221,m5 = 223,m5 = 225,m5 = 227,m5 = 229,m5 = 231,m5 = 233,m5 = 235,m5 = 237,m5 = 239,m5 = 241,m5 = 243,m5 = 245,m5 = 247,m5 = 249,m5 = 251,m5 = 253</span><br><span class="line">m6 = 205</span><br><span class="line">m7 = 129</span><br></pre></td></tr></table></figure></p><p>(Careful here, you should find correct i1 for m0) But since there is no m5 and it just checks over itself you can assign it as correct input.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">i1 = 250</span><br><span class="line">i2 = 180</span><br><span class="line">i3 = [254,52]</span><br><span class="line">i4 = [176,22]</span><br><span class="line">i5 = [254, 145, 136, 72, 203, 118, 74, 120 ,244 ,221, 102, 147, 63, 238, 49, 247]</span><br><span class="line">i6 = [65, 67, 69, 71, 73,75, 77, 79, 81, 83,85, 87, 89, 91, 93, 95, 97, 99, 101, 103, 105, 107, 109, 111, 113, 115, 117, 119, 121, 123, 125, 127, 193, 195, 197, 199, 201, 203, 205, 207, 209, 211, 213, 215, 217, 219, 221, 223, 225, 227, 229, 231, 233, 235, 237, 239, 241, 243, 245, 247, 249, 251, 253]</span><br><span class="line">i7 = 68</span><br><span class="line">i8 = 190</span><br></pre></td></tr></table></figure><p>We have 2*2*16*64 different combination for now. </p><h2 id="Bigger-plan"><a href="#Bigger-plan" class="headerlink" title="Bigger plan"></a>Bigger plan</h2><p>After m7 if block, m9(i1+..+i7*i8) is called. This will change s4. Then ONE more if block comes for last hex. Since m8 is dependent on s4 we CANNOT bruteforce like before.</p><p>If block :<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ((i10 &amp; <span class="number">255</span>) != <span class="number">103</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>i10 must be 103.</p><p>To find last hex : frida script: </p><pre><code>Iterate over possible inputsClear s4.Calculate input for m9Call m9Find correct value for m8Store solution</code></pre><p>Frida can easily handle memory. Calculate all possible values : <a href="calc.py">calc.py</a></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">nulls = []</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">nulls.push(<span class="number">0x0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; t.length;i++)&#123;</span><br><span class="line"></span><br><span class="line">i9 = t[i][<span class="number">0</span>] + t[i][<span class="number">1</span>] + t[i][<span class="number">2</span>] + t[i][<span class="number">3</span>] + t[i][<span class="number">4</span>] + t[i][<span class="number">5</span>] + t[i][<span class="number">6</span>] * t[i][<span class="number">7</span>]</span><br><span class="line"><span class="comment">//call m9</span></span><br><span class="line">b.m9(i9)</span><br><span class="line"><span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">255</span>;j++)&#123;</span><br><span class="line"></span><br><span class="line">aa = b.m8(j,<span class="number">23</span>)</span><br><span class="line">res = <span class="built_in">parseInt</span>(aa)&amp;<span class="number">255</span></span><br><span class="line"><span class="keyword">if</span>( res== <span class="number">103</span>)&#123;</span><br><span class="line"><span class="comment">//console.log("Found last digit for : " + i9+ " "+ j)</span></span><br><span class="line"><span class="built_in">console</span>.log([t[i][<span class="number">0</span>],t[i][<span class="number">1</span>],t[i][<span class="number">2</span>],t[i][<span class="number">3</span>],t[i][<span class="number">4</span>],t[i][<span class="number">5</span>],t[i][<span class="number">6</span>],t[i][<span class="number">7</span>],j])</span><br><span class="line"><span class="comment">//clear s4 maybe one more digit will be found</span></span><br><span class="line">Memory.writeByteArray(ptr(s4),nulls)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">Memory.writeByteArray(ptr(s4),nulls)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Here t is possible values. <a href="sol1.txt">Script</a> will find correct input to m8 function. Then you will need to find correct i8. I found older inputs with manual search, but for this case I used <a href="calc3.py">python</a></p><p>Now there is just last check !</p><p>This time we have all inputs lets just give it to solve function.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">b.solve.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a,o,c,d,e,f,g,h,i</span>)</span>&#123;</span><br><span class="line">solutions = []</span><br><span class="line">nulls = []</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">0x1000</span>;i++)&#123;</span><br><span class="line">nulls.push(<span class="number">0x0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; t.length;i++)&#123;</span><br><span class="line">t2 = <span class="keyword">this</span>.solve(t[i][<span class="number">0</span>],t[i][<span class="number">1</span>],t[i][<span class="number">2</span>],t[i][<span class="number">3</span>],t[i][<span class="number">4</span>],t[i][<span class="number">5</span>],t[i][<span class="number">6</span>],t[i][<span class="number">7</span>],inputs[i])</span><br><span class="line"><span class="built_in">console</span>.log(i + <span class="string">" "</span> + t2)</span><br><span class="line"><span class="keyword">if</span>(t2)&#123;</span><br><span class="line"><span class="built_in">console</span>.log(t[i][<span class="number">0</span>],t[i][<span class="number">1</span>],t[i][<span class="number">2</span>],t[i][<span class="number">3</span>],t[i][<span class="number">4</span>],t[i][<span class="number">5</span>],t[i][<span class="number">6</span>],t[i][<span class="number">7</span>],inputs[i])</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">Memory.writeByteArray(ptr(s4),nulls)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">b.sleep.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">502</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Last <a href="so2.txt">script</a></p><p>Bypass sleep function so we wont wait.</p><h2 id="Fl4g"><a href="#Fl4g" class="headerlink" title="Fl4g"></a>Fl4g</h2><p>Now enter something like <code>OOO{123456789012345678}</code> and wait until frida finds correct value ! :D</p><p><img src="sol.gif" alt=""></p><p>Flag is hex values of those integers:<br><code>OOO{fab43416484944beba}</code></p>]]></content>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Android </tag>
            
            <tag> Reverse </tag>
            
            <tag> Frida </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Mobile Malware Analysis : Tricks used in Anubis</title>
      <link href="/Mobile-Malware-Analysis-Tricks-used-in-Anubis/"/>
      <url>/Mobile-Malware-Analysis-Tricks-used-in-Anubis/</url>
      <content type="html"><![CDATA[<h2 id="Anubis"><a href="#Anubis" class="headerlink" title="Anubis"></a>Anubis</h2><p><img src="anubis.jpg" width="250"></p><p>Anubis is my first case of <code>complicated</code> android malware and taught me so much about android malware. I want to share these learnings in this post. Anubis is almost one year old but its impact is much higher than older banker families and campaign is <a href="https://twitter.com/0xabc0/status/1113698644442656773" target="_blank" rel="noopener">still going on</a>. Small section of anubis downloader samples found in play store in between July 2018 and March 2019 :</p><p><img src="gplay.png" alt=""></p><p>Anubis is full of tricks. List of capabilities: </p><ul><li>Steal information with overlay attacks from banking apps</li><li>Ransomware</li><li>SMS interception / Call forwarding</li><li>RAT</li><li>Keylogger</li></ul><p>To spread malware generally google play store is used.   </p><h2 id="Downloaders"><a href="#Downloaders" class="headerlink" title="Downloaders"></a>Downloaders</h2><p>Anubis generally consist of two part. I’ll call them downloader and payload. If malware spreads over third party sites, such as <code>flash updates</code> it only downloads payload of anubis. But if malware spreads over google play store, it uses downloader. Because it needs to. If payload of anubis is used it will be detected by play protect easily. So to download payload, fake applications deployed on play store. But how an application downloads and installs another application ?<br>Easy, with <code>REQUEST_INSTALL_PACKAGES</code> permission. I think in the current state of Play Store this permission is dangerous than any other one. Because Play Protect can catch malware and rats if published on play store. Spread of malware generally comes from this permission. Users need to check if this permission is in permission list.</p><h2 id="Social-Engineering"><a href="#Social-Engineering" class="headerlink" title="Social Engineering"></a>Social Engineering</h2><p>Malware needs to lower suspicion of user after installation. Anubis downloaders use little but strong steps to make user believe it is legitimate app. Since threat actors want to catch valuable victims, generally these fake applications will be finance related apps. Such as <code>Currency Converter</code>. </p><table><thead><tr><th style="text-align:center">Curreny - Gold - Euro</th><th style="text-align:center">Currency Center </th></tr></thead><tbody><tr><td style="text-align:center"><img src="m1.jpg" alt=""></td><td style="text-align:center"><img src="m22.png" alt=""></td></tr></tbody></table><p>( notice #1 trending )</p><p>But these apps will imitate legitimate ones. Here is how earlier fake apps worked. After installing, app will remove itself from homescreen. Why ? Lets say you downloaded an app. But it didn’t worked like you wanted. What you do ? Go back to homescreen and delete that app right ? Now you need to go to settings. Also after opening fake app, generally app will prompt <code>App needs to be updated</code> and forward user to legitimate app that have same app icon, app name and almost same developer name. So you downloaded an app, it forwarded to real one and you installed it. When you go back to your homescreen, you will see only one app which is legitimate one. With this, suspicion of user is lowered. But when you go to settings and list application, you will see 2 of them.</p><p><img src="downloader.gif" width="350" height="200"></p><p>Also ! if you try to remove malware from settings an system error(!) will show up.</p><h2 id="System-Update"><a href="#System-Update" class="headerlink" title="System Update ?"></a>System Update ?</h2><p>After user installs downloader, app will download second stage of attack, payload. Generally name of downloaded apk will be either <code>Sistem Guncellemesi, Operator Guncellemesi, Flash Update, Yazilim Guncellemesi</code>. Names are in Turkish, meaning System Update, Operator Update, Software Update. Icons of these apps:</p><table><thead><tr><th style="text-align:center">Flash Player Update</th><th style="text-align:center">Update</th><th style="text-align:center">Operator Update</th><th style="text-align:center">Service Update</th><th style="text-align:center">System Update</th></tr></thead><tbody><tr><td style="text-align:center"><img src="flash.png" alt=""></td><td style="text-align:center"><img src="gunc.png" alt=""></td><td style="text-align:center"><img src="ope.png" alt=""></td><td style="text-align:center"><img src="servis.png" alt=""></td><td style="text-align:center"><img src="sys.png" alt=""></td></tr></tbody></table><p>With these icons threat actors want user to believe these are legitimate apps. After downloader gets payload app from command and control server, prompt will shown to user. User needs to activate <code>third-party installation</code> and press yes to prompt screen. Then app will installed. After user opens up, app will ask for permissions then nothing will shown and app will dissepear from app list.</p><p><img src="dropped.gif" width="350" height="200"></p><p>Did you see flickering after giving Accessibility permission ? We will come to that.</p><h2 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h2><p>In desktop malware generally malware will write itself to <code>Startup</code> folder to get persistence and open itself each boot. What about Android malware ? Let me introduce you to <code>RECEIVE_BOOT_COMPLETED</code>. With this receiver, app can open itself in background when device is booted. Cool right ?</p><h2 id="You-cant-delete-me"><a href="#You-cant-delete-me" class="headerlink" title="You cant delete me !"></a>You cant delete me !</h2><p>Lets say user gave all permission to application and installed it. But you want to remove app. When you go to settings and try to delete app, you click the app icon. It says <code>System apps cannot be deleted</code> and you are forwarded to user to Home Screen.<br>What ?</p><p><img src="pikachu.jpg" width="250" height="250"></p><p>App didn’t take device admin permissions. How it can do that ? Lets find out.</p><h2 id="Accessibility"><a href="#Accessibility" class="headerlink" title="Accessibility"></a>Accessibility</h2><p>From <a href="https://developer.android.com/reference/android/view/accessibility/AccessibilityEvent" target="_blank" rel="noopener">official android page</a> :’Accessibility Services run in the background and receive callbacks by the system when AccessibilityEvents are fired. Such events denote some state transition in the user interface, for example, the <strong>focus has changed</strong>, a <strong>button has been clicked</strong>, etc. Such a service can optionally <strong>request</strong> the capability for querying the content of the <strong>active window</strong>‘.</p><p>What can go wrong right ?</p><p>It can track user activities and have ability to <strong>query</strong> certain things such as message boxes. Each accessibility event have source component that defines which application triggered current event. There are different event types anubis use : </p><ul><li>TYPE_VIEW_CLICKED</li><li>TYPE_VIEW_FOCUSED</li><li>TYPE_VIEW_TEXT_CHANGED</li><li>TYPE_WINDOW_STATE_CHANGED</li></ul><p>To see what all Accessibility Event types are take a look at :  <a href="https://developer.android.com/reference/android/view/accessibility/AccessibilityEvent" target="_blank" rel="noopener">AccessibilityEvent</a></p><p>Anubis tracks all accessibility events and checks event types. So if you open new app window state will change and event will trigger. Event type of <code>TYPE_WINDOW_STATE_CHANGED</code> is first check. To remove malware you probably go to Settings. Settings is also an android application called <code>com.android.settings</code>. Second check is if triggered event comes from <code>com.android.settings</code>. Then malware checks if certain strings in Event description.</p><p><img src="check.png" alt="check"></p><p> First check is for name of the app you clicked :</p><ul><li>Servis Guncellemesi (this.a.i(this))</li></ul><p>Then below strings:</p><ul><li>uninstall (this.f)</li><li>to remove (this.g)</li></ul><p>If all conditions hold, an Activity is triggered <code>a()</code> . This activity just opens AlertDialog which says <code>System apps cannot be deleted</code>. Since Application doesnt have any Launchable content, android opens alert box in the Homescreen. So whenever you try to open Malware’s details in Settings you forwarded to homescreen with alert box and you can’t delete app.</p><p><img src="hata.gif" width="350" height="200"></p><p>Maybe if I remove Accessibility permission from app, I should able to remove it right ? No. Lets say you removed permission. All’s fine. But when you open Settings again, malware will constantly ask you to give permission. You cant navigate to Apps section of Settings to remove app. Fine, maybe If I reboot then I can remove app ? Remember <code>RECEIVE_BOOT_COMPLETED</code> permission ? App will start again and ask for Accessibility permission. But you have other ways to remove the app. If you have application manager apps with package name other than <code>com.android.settings</code> you can delete malware. Or by booting in safe mode. Also if you have adb enabled and you know packagename you can delete it with : <code>adb uninstall packagename</code>. To learn package names you can list all packages with <code>adb shell pm list packages</code></p><h2 id="Keylogger"><a href="#Keylogger" class="headerlink" title="Keylogger"></a>Keylogger</h2><p>Now we covered <code>TYPE_WINDOW_STATE_CHANGED</code> event. Lets look at other 3 event.</p><ul><li>TYPE_VIEW_CLICKED</li><li>TYPE_VIEW_FOCUSED</li><li>TYPE_VIEW_TEXT_CHANGED </li></ul><p>EVERY input box you click/focus and write text into it, will trigger one the three event. No matter what app you are in. So lets say TYPE_VIEW_TEXT_CHANGED event triggered and malware caught it. With just <code>obj = accessibilityEvent.getText().toString();</code> it can get changed text and send back to its command and control server. Event type 16 = <code>TYPE_VIEW_TEXT_CHANGED</code><br><img src="text.png" alt="text"></p><p>Remember flickering after giving the accessibility permission to malware ? With accessibility, app can press buttons (yes literally). Malware press <code>yes</code> without user interaction.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( node : source.findAccessibilityNodeInfosByText(<span class="keyword">this</span>.e)) &#123;</span><br><span class="line">                node.performAction(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You guessed right, action 16 is <code>ACTION_CLICK</code> and this.e holds <code>StringYes</code>.</p><h2 id="Play-Protect"><a href="#Play-Protect" class="headerlink" title="Play Protect"></a>Play Protect</h2><p>Even though malware installed on the device from downloader without being flagged, Play Protect will constantly scan the device if its enabled and will flag anubis app as a malware. To overcome this malware tries to disable Play protect. </p><p><img src="playprotect.png" alt=""></p><h2 id="Package-List"><a href="#Package-List" class="headerlink" title="Package List"></a>Package List</h2><p>When malware installed, first thing it does is listing installed packages and sending it to command and control server. These application names are sometimes used for another purpose. For example when threat actor knows you have, lets say ‘com.x.bank’ app, threat actor sends sms that crafted for that app to lure user to open <code>com.x.bank</code> application. <code>You have received 10.000$. Login in to your X account</code> With this technique user will open that app and fake overlay will shown. This can be taught as backup plan for phishing user.</p><p>How can android app list installed packages ? Easy <code>getInstalledApplications</code><br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">pman = context.getPackageManager()</span><br><span class="line"><span class="keyword">for</span> ( ApplicationInfo appInf : pman.getInstalledApplications(<span class="number">128</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(appInf.packageName.equals(<span class="string">"com.x.bank"</span>))&#123;</span><br><span class="line">        arrayList.add(<span class="string">"com.x.bank"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Overlay-Attack"><a href="#Overlay-Attack" class="headerlink" title="Overlay Attack"></a>Overlay Attack</h2><p>Malware authors always try to find creative ways to fool victims to get their information. Overlay attack is one of them. Since early 2016 (<a href="https://lukasstefanko.com/2016/02/android-mazarbot-stealing-credit-card-information-in-italy-with-certified-issued-by-putin.html" target="_blank" rel="noopener">MazarBot</a> ) a lot of android malware used this technique for collecting user information. When targeted apps opened, malware triggers and pulls phishing page that generated for that targeted app from command and control server and <code>overlays</code> over targeted app. Showing it is easier.</p><p><img src="overlay.gif" width="350" height="200"></p><p>(random banking app is chosen. There are 100+ targeted apps)</p><p>Since overlayed screen is similar to original app and process of overlaying is done in very short time, user probably dont get suspicious. But how malware detects opened apps and overlays itself on top of another process ? Lets find out !</p><h2 id="Process-Scanning"><a href="#Process-Scanning" class="headerlink" title="Process Scanning"></a>Process Scanning</h2><p>Getting package list is not enough for overlay attack. Malware needs to know that user just opened “com.x.bank” app to make believable overlay scenerio. Or user wont fall it and be suspicious about it. There is no “an app opened” service in android. The way malware does is simple: somehow get running process list and get top process. Put that function in <code>While(true){ }</code> loop. This way you will know when new app opened. The ways of getting process list differs in targeted SDK versions. Anubis need permission to get process list if API version is greater than 23. It uses  <code>PACKAGE_USAGE_STATS</code> permission to use UsageStatsManager and get list of running processes. If API version is &lt; 23 then there are functions to get list of processes without any permission. I’ll focus on this topic on my next post. After getting process/package names, malware compare these with banking apps package names. Then opens up corresponding phishing page through webView. This action doesn’t need any permission. Any app can open itself without user interaction ! (Not in Android 9 YAY !)</p><p><img src="webView.png" height="200"></p><p>Then collected data will be send to command and control server. </p><h2 id="Battery-issues"><a href="#Battery-issues" class="headerlink" title="Battery issues"></a>Battery issues</h2><p>But running in forever loop will cause some battery issues right? Battery optimizing apps will close malware. Malware author was aware of this and here comes another permission <code>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</code>. With this permission app will not seen in battery optimizations.  </p><h2 id="SMS-Interception-and-Call-forwarding"><a href="#SMS-Interception-and-Call-forwarding" class="headerlink" title="SMS Interception and Call forwarding"></a>SMS Interception and Call forwarding</h2><p>This is scary part. Malware already have SMS_READ permission for reading sms. Why ? For OTP codes. Addition to reading, malware requests for being default SMS app. If user accepts, threat actor behind the command and control server can delete SMS from device. Then sms will be removed and user wont have any clue.</p><p>Call forwarding, oh this is really scary. Lets say bank understood user is victim of malware. Calls him/her number. But who opens the phone ? threat actor.</p><p><img src="callforward.png" alt="callforward"></p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Two permission for two stages of anubis. <code>REQUEST_INSTALL_PACKAGES</code> and <code>PACKAGE_USAGE_STATS</code> these are releated to core components of the malware to fool user. I hope you learned something new about android malware. If you have any question feel free to ask me <a href="https://twitter.com/0xabc0" target="_blank" rel="noopener">@0xabc0</a></p><p>While writing this post, Android announced 9 beta with great security related news ! Now apps can’t open itself without user interaction, no more overlay tactics for malware !</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://forum.yugiohcardmaker.net/user/731508-gregory-the-gregory/" target="_blank" rel="noopener">Anubis Image gregory-the-gregory</a></p><h2 id="Readings"><a href="#Readings" class="headerlink" title="Readings"></a>Readings</h2><p>Anubis Related:<br><a href="https://koodous.com/apks?search=tag:anubis" target="_blank" rel="noopener">Koodous for finding anubis sample</a><br><a href="https://twitter.com/LukasStefanko/status/1084728042927341569" target="_blank" rel="noopener">LukasStefanko’s twitter thread</a><br><a href="https://blog.trendmicro.com/trendlabs-security-intelligence/google-play-apps-drop-anubis-banking-malware-use-motion-based-evasion-tactics/" target="_blank" rel="noopener">Trend Micro’s post about Anubis</a><br><a href="https://securityintelligence.com/anubis-strikes-again-mobile-malware-continues-to-plague-users-in-official-app-stores/" target="_blank" rel="noopener">IBM X-Force’s post about Anubis</a><br><a href="https://news.sophos.com/en-us/2018/08/14/anubis-is-back-are-you-prepared/" target="_blank" rel="noopener">Sophos Labs’ post about Anubis</a></p><p>If you want to read related posts about android malware heres my other posts:<br><a href="https://pentest.blog/n-ways-to-unpack-mobile-malware/" target="_blank" rel="noopener">How to defeat packers in Android ecosystem</a><br><a href="https://eybisi.run/2018/07/31/Mobil-Zararli-Analizi-Bolum-1-Ortami-Kuralim/">How to setup android malware analysis lab (in Turkish)</a></p>]]></content>
      
      
        <tags>
            
            <tag> Malware </tag>
            
            <tag> Mobile </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>STMCTF18-Final Mobil Sorulari</title>
      <link href="/STMCTF18-Final-Mobil-Sorulari/"/>
      <url>/STMCTF18-Final-Mobil-Sorulari/</url>
      <content type="html"><![CDATA[<h2 id="basitmobil"><a href="#basitmobil" class="headerlink" title="basitmobil"></a>basitmobil</h2><p>jadxte açtığımda flag zaten karşımda. </p><p><img src="basit_mobil.png" alt="basit"></p><p>Flag : <code>STMCTF{yazdan_kalan_s1caklarla_1s1nal1m}</code></p><h2 id="benibul"><a href="#benibul" class="headerlink" title="benibul"></a>benibul</h2><p>Apkyı jeb’de açıyorum görüyorumki <code>.flag.txt</code> diye bir dosya oluşturuyor. İçine de binary-&gt;octal-&gt;decimal dönüşümünü yapıp değeri yazıyor.</p><p><img src="benibul.png" alt="jeb"></p><p>Dosyaya bakmadan direk datayı alıp binary -&gt; asci değerini de bakabilirsiniz. Dosyaya adb shell ile emulatore bağlanıp bakalım. (v24 istiyor ona göre vm açmak lazım)</p><p><img src="sahte.png" alt="sahte"></p><p>Bu binary değerleri sahteymiş demekki apknın başka bir yerinde başka binary değerleri var.<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cp benibul.apk benibul.zip</span><br><span class="line">unzip benibul.zip</span><br><span class="line">cd lib/x86</span><br></pre></td></tr></table></figure></p><p>Komutları ile apknın native librarysine gidiyorum. Tahminimce yine 0101 gibi değer olduğu için grepliyorum.<br>Bulduğum değerleri asciye çevirdiğimde flag çıkıyor</p><p><img src="gercek.png" alt="gercek"></p><p>Flag: <code>STMCTF{?_evet_taraf1nd4n_!}</code></p><h2 id="terslebeni"><a href="#terslebeni" class="headerlink" title="terslebeni"></a>terslebeni</h2><p>jadxte apkyı açıyorum. Görüyorumki bir karşılaştırma var. Uygulama bu karşılaştırmaya göre apkdeki bir componente setText ile text basıyor.</p><p><img src="ters.png" alt="ters"></p><p>R.string değerlerinin ne olduğunu Resources/resoueces.arsc/values/strings.xml dosyasından görebiliriz.<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R.string.a UmxUbYYSllDKA1n+ZMR/sZXJ5ZglWOSfYGzfuVauT+o=</span><br><span class="line">R.string.b R09IT01FIQ==</span><br><span class="line">R.string.d Tebrikler, doğru bayrağı buldun</span><br><span class="line">R.string.e Denemeye devam</span><br></pre></td></tr></table></figure></p><p>Karşılatırmanın yapıldığı kod parçası şu şekilde </p><p><code>Base64.encodeToString( Util.a( obj,Util.a( new String( Base64.decode( MainActivity.this.getString(R.string.b),0)))), 0).trim().equals( MainActivity.this.getString(R.string.a)) != null</code></p><p>Kodu kısaltırsak</p><p>Util.a(new String(Base64.decode(MainActivity.this.getString(R.string.b), 0)))<br>first = Util.a(base64decode(R.string.b))<br>second = Util.a(obj,first)</p><p>Yani if’i içinde  şu karşılatırma yapılıyor.<br>base64encode(second) == R.string.a</p><p>R.string.a değerini biliyoruz : UmxUbYYSllDKA1n+ZMR/sZXJ5ZglWOSfYGzfuVauT+o=</p><p>first ve second için Util classına bakalım</p><p><img src="util.png" alt="util"></p><p>Birden fazla a fonksiyonu var. first ve second için hangi a fonksiyonun çalışacağını parametre sayısı belirleyecek. First için tek değerli yani md5li fonksiyon, second için alttaki aes encryption fonksiyonu çalışacak.<br>first’ün gittiği fonksiyon gelen değerin md5ini alıp dönen değerin 16 karaterini alıyor.</p><p>second’ın gittiği a fonksiyonun ilk parametrisi str, ikinci parametresi key. Bu parametrelerle ECB modunda aes encryption yapıyor. </p><p>yani first değerimiz md5(R.string.b)[:16] , bu değer de aes encryptiona key olarak gidiyor. </p><p>second’ın gittiği fonksiyonun ilk parametresi apkdan gelen input değeri. Bu değeri alıp constant key ile encrypt edip base64ünü aldığımızda R.string.a değeriyle aynı değeri bulmamız gerek. Tersten gidersek</p><p>base64decode(R.string.a) yı md5(R.string.b)[:16] ile decrypt edince flage ulaşabiliriz.</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line">a = <span class="string">"UmxUbYYSllDKA1n+ZMR/sZXJ5ZglWOSfYGzfuVauT+o="</span></span><br><span class="line">b = <span class="string">"R09IT01FIQ=="</span></span><br><span class="line">ciphertext = base64.b64decode(a)</span><br><span class="line">key = base64.b64decode(b)</span><br><span class="line">m = md5()</span><br><span class="line">m.update(key)</span><br><span class="line">key = m.hexdigest()[:<span class="number">16</span>]</span><br><span class="line">cipher = AES.new(key,AES.MODE_ECB)</span><br><span class="line">cipher.decrypt(ciphertext)</span><br></pre></td></tr></table></figure><p>Flag : <code>STMCTF{!ben_evdey1m_zaten}</code></p><h2 id="muslukcu"><a href="#muslukcu" class="headerlink" title="muslukcu"></a>muslukcu</h2><p>apkyı jadxte açınca görünüyorki sürekli bir log.d akışı var. <code>STMCTF{</code> stringini arayınca tek bir yerde geçtiğini görüyorum ve koda gidiyorum. </p><p><img src="muslukcu.png" alt="muslukcu"></p><p>skor değişkenine  baktığımda aslında constant oldugunu görüyorum. Oyundaki skor <code>score</code> değişkeninde tutuluyor. Geriye touchx değeri kalıyor. Bu değer ekrana tıklandığında değişiyor aslında. Ama flagi hesaplarken ilk değeri olan 1000’i almak gerekiyor.<br>Bu bilgilerden sonra 2 yol kullanabiliriz.</p><ul><li>Elle hesaplama</li><li>Gerekli condition’ı sağlayıp flagi log.d ye bastırabiliriz.</li></ul><p>Elle hesaplarsanız .<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; 48*13*5000*1000*999</span><br><span class="line">3116880000000</span><br></pre></td></tr></table></figure></p><p>STMCTF{} içine koydugunuzda yarışmadaki flage ulaşıyorsunuz. </p><p>ANCAK</p><p>Bu değer bir integer değişkeninin tutabilceği değerden yani 0xffffffff ‘den fazla. Yani aslında i değeri 5000 olduğunda apk’nın log.d ye basacağı değer farklı bir değer.<br>Bunu frida ile deneyebiliriz.</p><p>Kodum şu şekilde : </p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">//prevent timeout</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"[*] Starting script"</span>);</span><br><span class="line">    Java.performNow(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      Java.choose(<span class="string">"mario.Board"</span>, &#123;</span><br><span class="line">          onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"Changed score"</span>)</span><br><span class="line">            instance.i.value = <span class="number">5000</span></span><br><span class="line">             <span class="built_in">console</span>.log(instance.touchx.value)</span><br><span class="line">             <span class="built_in">console</span>.log(instance.skor.value)</span><br><span class="line">             <span class="built_in">console</span>.log(instance.i.value)</span><br><span class="line">          &#125;,</span><br><span class="line">          onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>i değerini 5000 yapıyorum. Kodun olduğu fonksiyon sürekli çağırıldığı için trigger etmeme gerek  yok. Çağırılmasaydı  <code>instance.checkLife()</code> ekleyerek bunu sağlayabilirdik.<br>Değer değiştikten sonra condition sağlandığı için bana log.d den flagi vermesi lazım.</p><p><img src="frida.png" alt="frida"><br>Evet istenen değerler olmasına rağmen farklı bir değer çıktı.<br>Bu değere şu şekilde ulaşıp emin olabiliriz.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; 48*13*5000*1000*999 &amp; 0xffffffff</span><br><span class="line">3028710400</span><br><span class="line">&gt;&gt;&gt; 3028710400-4294967295 -1</span><br><span class="line">-1266256896</span><br></pre></td></tr></table></figure><h2 id="cokzararli"><a href="#cokzararli" class="headerlink" title="cokzararli"></a>cokzararli</h2><p>Bu soruda frida için bi check beklerdim açıkcası. Çünkü kontrol yapılmazsa gerçekten çok kolay bir şekilde geliyor soru. (Intented yolda çok zor değil tabi)</p><p>Apkda keylogger classındaki kod şu şekilde :</p><p><img src="uret.png" alt="uret"></p><p>Eğer istenen conditionlar sağlanırsa native kütüphaneden x , y  ve z fonksiyonları çağırılarak flag üretiliyor. E o zaman çağıralım bu fonksiyonları :D</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">//prevent timeout</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"[*] Starting script"</span>);</span><br><span class="line">    Java.performNow(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      Java.choose(<span class="string">"tr.com.stm.cokzararli.Keylogger"</span>, &#123;</span><br><span class="line">          onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"Found instance"</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(instance.x())</span><br><span class="line">            <span class="built_in">console</span>.log(instance.y())</span><br><span class="line">            <span class="built_in">console</span>.log(instance.z())</span><br><span class="line"></span><br><span class="line">          &#125;,</span><br><span class="line">          onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="urett.png" alt="urett"></p>]]></content>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Android </tag>
            
            <tag> Reverse </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Flareon5 #6 Challenge : Magic </title>
      <link href="/Flareon5-6-Challenge-Magic/"/>
      <url>/Flareon5-6-Challenge-Magic/</url>
      <content type="html"><![CDATA[<p>In this post I’ll try to explain how I bruteforced challenge 6 with frida.</p><p>First of all lets try to understand what binary does.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&lt; 6 &gt; ./magic </span><br><span class="line">Welcome to the ever changing magic mushroom!</span><br><span class="line">666 trials lie ahead of you!</span><br><span class="line">Challenge 1/666. Enter key: 123</span><br><span class="line">No soup <span class="keyword">for</span> you!</span><br></pre></td></tr></table></figure><p>Binary will take 666 input. Follow the flow of the program, it goes to sub_402dcf after taking input from user.<br><img src="ida1.png" alt="ida1"></p><p>In sub_402dcf, program iterates 0x21 times.<br><img src="ida2.png" alt="ida2"><br>It checks size of input with 0x40. If its less than 0x40 program goes to sub_402cc7 and exits. I should avoid sub_402cc7. </p><p>Each iteration program goes to 0x605100 + 0x120*i and take somethings. Lets look at structure for first iteration (0x605100)<br><img src="ida3.png" alt="ida3"></p><p>0x400c55,0x147,0x02,0x03,0x25,0x61385a …</p><p>Firstly it takes 0x400c55 (first region) and 0x61385a (second region) and 0x147(size) . It xors first region with second region. After that it calls first region at 0x402f06 (call rcx).</p><p><img src="gdb.png" alt="gdb"></p><p>If you look at size of “A”s in rax ,it says 61 times but I entered 63 times and remember 0x2 from first structure. So 0x2 is index of string. Also see 0x3 at rsi register. After analyzing 0x400c55 it turns out 0x3 is our length.</p><p>What I learned so far.</p><ul><li>Key size is 69, (max number at structure 0x42+3)</li><li>Before call rcx, program xors region by getting parameters from structure.</li><li>Call rcx is taking length and index of strings which comes from structure.</li><li>If its correct program goes to next iteration, so probably different function will be executed for checking input.</li></ul><p>I tried to understand each function. I reversed 3 functions but stuck at 4th. (turns out it was base64). Then I looked at structure, and saw each function takes only 1-3 length.<br>So why not bruteforce it ? Since I love frida and never tried instrumentation on linux binaries lets give it a shot. </p><p>First lets learn how functions called with frida. If functions exported you can define NativeFunction with </p><p><code>NativeFunction(Module.findExportByName(null,&#39;printf&#39;), &#39;pointer&#39;, []);</code></p><p>But I will use functions that aren’t exported. So I will give pointer to NativeFunction such as:</p><p><code>var xor = new NativeFunction( ptr(0x402CDF), &#39;void&#39;, [&#39;pointer&#39;, &#39;pointer&#39;, &#39;pointer&#39;]);</code></p><p>First parameter is pointer to beginning of routine. Second parameter is type of what function will return. Third parameter is types of parameter which function will accept.</p><p>Lets try it<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xor = <span class="keyword">new</span> NativeFunction( ptr(<span class="number">0x402CDF</span>), <span class="string">'void'</span>, [<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>]);</span><br><span class="line"><span class="keyword">var</span> fnc1 = <span class="keyword">new</span> NativeFunction( ptr(<span class="number">0x400c55</span>), <span class="string">'int'</span>, [<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>]);</span><br><span class="line"></span><br><span class="line">Interceptor.replace(ptr(<span class="number">0x400c55</span>), <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span> (<span class="params">p,p1,p2,p3,p4,p5,p6</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.context))</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&#125;, <span class="string">'int'</span>, [<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>]));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xor(ptr(<span class="number">0x400c55</span>),ptr(<span class="number">0x147</span>),ptr(<span class="number">0x61385a</span>))</span><br><span class="line"></span><br><span class="line">Memory.writeS32(ptr(<span class="number">0x00605000</span>),<span class="number">0x20676e</span>)</span><br><span class="line">t = Memory.readUtf8String(ptr(<span class="number">0x00605000</span>),<span class="number">3</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Written : "</span> + t)</span><br><span class="line"></span><br><span class="line">q = ptr(<span class="number">0x605001</span>)</span><br><span class="line">q1= ptr(<span class="number">0x605002</span>)</span><br><span class="line">q2= ptr(<span class="number">0x605003</span>)</span><br><span class="line">q3= ptr(<span class="number">0x605004</span>)</span><br><span class="line">q4= ptr(<span class="number">0x605005</span>)</span><br><span class="line">q5= ptr(<span class="number">0x605006</span>)</span><br><span class="line">q6= ptr(<span class="number">0x605007</span>)</span><br><span class="line">s = fnc1(q,q1,q2,q3,q4,q5,q6)</span><br><span class="line"><span class="keyword">if</span> (s)&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Yey"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>I defined 2 functions, first one xor routine other one is where our input checked. Second routine returns int,  After that I set a Interceptor to see registers before getting into function.<br>You can write into memory with Memory.writeS* . First parameter is pointer , second is what you want to write. You read locations as a string with readUtf8String function.<br>I give 7 parameter to fnc1 to see state of registers. Attach to binary with <code>frida magic -l brute.js</code></p><p><img src="gdb2.png" alt="gdb2"></p><p>So order of parameters is : rdi,rsi,rdx,rcx,r8,r9..<br>I used this to understand which register my parameter goes.</p><p>Now I can define functions with pointers, write strings to memory and read memory. So I have everything I need.</p><p>Before bruteforcing lets parse structure, open all functions with xor.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">s=[]</span><br><span class="line"><span class="keyword">for</span>(l =<span class="number">0</span>;l&lt;<span class="number">33</span>;l++)&#123;</span><br><span class="line">base = <span class="number">0x605100</span>+(<span class="number">0x120</span>*l)</span><br><span class="line">s[l*<span class="number">5</span>] =  Memory.readS32(ptr(base+<span class="number">0x8</span>))</span><br><span class="line">s[l*<span class="number">5</span>+<span class="number">1</span>] = Memory.readS32(ptr(base+<span class="number">0xc</span>))</span><br><span class="line">s[l*<span class="number">5</span>+<span class="number">2</span>] = Memory.readS32(ptr(base+<span class="number">0x10</span>))</span><br><span class="line">s[l*<span class="number">5</span>+<span class="number">3</span>] = Memory.readS32(ptr(base))</span><br><span class="line"> s[l*<span class="number">5</span>+<span class="number">4</span>] = Memory.readS32(ptr(base+<span class="number">0x18</span>))</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>;i&lt;s.length/<span class="number">5</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">xor(ptr(s[i*<span class="number">5</span>+<span class="number">3</span>]),ptr(s[i*<span class="number">5</span>]),ptr(s[i*<span class="number">5</span>+<span class="number">4</span>]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Define our pools with len 1, 2 and 3 for bruteforcing</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">pool = <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\"#$%&amp;\'()*+,-./:;&lt;=&gt;?@[\\]^_`&#123;|&#125;~ "</span></span><br><span class="line">pool_1 = []</span><br><span class="line">pool_2 = []</span><br><span class="line">pool_3 = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i =<span class="number">0</span>;i&lt;pool.length;i++)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">pool_1[i] = pool[i]</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> j =<span class="number">0</span>;j&lt;pool.length;j++)</span><br><span class="line">&#123;</span><br><span class="line">pool_2[i*pool.length+j] = pool[i]+pool[j]</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> k =<span class="number">0</span>;k&lt;pool.length;k++)</span><br><span class="line">&#123;</span><br><span class="line">pool_3[i*pool.length*pool.length+j*pool.length+k] = pool[i]+pool[j]+pool[k]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Get parameters from s and bruteforce functions.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toHex</span>(<span class="params">str,hex</span>)</span>&#123;</span><br><span class="line">  </span><br><span class="line">  str = str.split(<span class="string">""</span>).reverse().join(<span class="string">""</span>);</span><br><span class="line">  hex = <span class="built_in">unescape</span>(<span class="built_in">encodeURIComponent</span>(str))</span><br><span class="line">    .split(<span class="string">''</span>).map(<span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> v.charCodeAt(<span class="number">0</span>).toString(<span class="number">16</span>)</span><br><span class="line">    &#125;).join(<span class="string">''</span>)</span><br><span class="line">  stri = <span class="string">'0x'</span>+hex</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">parseInt</span>(stri)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sol = <span class="string">"                                                                     "</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;s.length/<span class="number">5</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">pool_l = []</span><br><span class="line">len = s[i*<span class="number">5</span>+<span class="number">2</span>]</span><br><span class="line"><span class="keyword">if</span>(len == <span class="number">1</span>) pool_l = pool_1</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(len == <span class="number">2</span>) pool_l = pool_2</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(len == <span class="number">3</span>) pool_l = pool_3</span><br><span class="line"><span class="keyword">else</span> pool_l = pool</span><br><span class="line">found = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> fnc1 = <span class="keyword">new</span> NativeFunction(ptr(s[i*<span class="number">5</span>+<span class="number">3</span>]), <span class="string">'int'</span>, [<span class="string">'pointer'</span>,<span class="string">'pointer'</span>,<span class="string">'pointer'</span>]);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>;j&lt;pool_l.length;j++)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">Memory.writeS32(ptr(<span class="number">0x400000</span>),toHex(pool_l[j]))</span><br><span class="line">t = Memory.readS32(ptr(<span class="number">0x400000</span>),len)</span><br><span class="line">b = <span class="number">0x605120</span>+(<span class="number">0x120</span>*i)</span><br><span class="line">fnc_r = fnc1(ptr(<span class="number">0x400000</span>),ptr(len),ptr(b))</span><br><span class="line"><span class="keyword">if</span> (fnc_r == <span class="number">1</span>)&#123;</span><br><span class="line">sol = [sol.slice(<span class="number">0</span>,s[i*<span class="number">5</span>+<span class="number">1</span>]),pool_l[j],sol.slice(s[i*<span class="number">5</span>+<span class="number">1</span>]+len)].join(<span class="string">''</span>);</span><br><span class="line">sol[i*<span class="number">5</span>+<span class="number">1</span>] = pool_l[j]</span><br><span class="line"><span class="built_in">console</span>.log(sol)</span><br><span class="line">found = <span class="literal">true</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(sol)</span><br></pre></td></tr></table></figure><p>I defined fnc1 NativeFunction which checks user input.<br>Lastly wrap all script into<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setTimeout(function () &#123;</span><br><span class="line">  /* your code here */</span><br><span class="line">&#125;, 0);</span><br></pre></td></tr></table></figure></p><p>because if I dont it will timeout.</p><p>So running this script will give this.</p><p><img src="gdb3.png" alt="gdb3"></p><p>Looks promising. BUT script couldn’t find 2 string. Even now I dont know why it doesnt find it. Maybe some register values doesnt fit idk. Since I was so close to finding first key, I tried to bypass checks and looked program at gdb.</p><p>Lets put breakpoint at after call rcx (0x402F0a) and  0x403B6C which is after all input is checked. Give string to program and if doesnt correct bypass next check by setting eax 1.</p><p><img src="gdb4.png" alt="gdb4"></p><p>Annd whoa. After hitting 0x403b6c, you can see “Ah, there is nothi   like the hot winds of He   blowing in your face.” . Turns out program shuffled our input to create meaningfull string.</p><p>Googleing sentence and blanks filled with “ng “ and “ll”. This is good. If my script cant find string with len 2, I can say its “ll” , if len is 3 its “ng “. </p><p>After giving correct input to binary, without knowing what program does I attached my frida script again. And whoila again I found string. And pool of letters is same.</p><p>So I know now, each key is shuffled, and shuffled parts are same. And I can lower my pool to this :</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pool1 = &apos;abcdefghilnorstuwy.,AH &apos;</span><br><span class="line">pool2 = [&apos;e &apos;,&apos; H&apos;,&apos;is&apos;,&apos;no&apos;,&apos;of&apos;,&apos; g&apos;,&apos;bl&apos;,&apos;ow&apos;,&apos;ur&apos;,&apos; w&apos;,&apos;in&apos;,&apos;yo&apos;] </span><br><span class="line">pool3 = [&quot;ds &quot;,&quot;hot&quot;,&quot;the&quot;,&apos; yo&apos;,&quot;ace&quot;,&quot;thi&quot;,&apos;Ah,&apos;,&apos; in&apos;,&apos; bl&apos;,&apos;lik&apos;]</span><br></pre></td></tr></table></figure><p>My plan is set my frida script such that it will find correct key, send to binary, and again again.. for each key. I will use python helper for that.</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = [<span class="string">'inds isng  llg w. e  HthitheoftheAh,urnolik inefe  yo blrhot in owace'</span>]</span><br><span class="line">r = process(<span class="string">"./magic"</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(s[<span class="number">0</span>])</span><br><span class="line">fr = process([<span class="string">'python'</span>,<span class="string">"./fri.py"</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">665</span>):</span><br><span class="line">key =fr.recvline()</span><br><span class="line"><span class="keyword">print</span> i <span class="comment">#</span></span><br><span class="line">r.sendline(key[:<span class="number">-1</span>])</span><br><span class="line">print(i,key)</span><br><span class="line">r.recvuntil(<span class="string">"Congrats!"</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>I will start magic and my frida script same time. Get key from frida and send to binary.</p><p>I will wrap my frida script to timeout so it will execute after given time (70ms).</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment">#inds isng  llg w. e  HthitheoftheAh,urnolik inefe  yo blrhot in owace</span></span><br><span class="line"><span class="comment">#abcdefghijklmnopqrstuvwxyz., ABCDEFGHIJKLMNOPQRSTUVWXYZ</span></span><br><span class="line"><span class="comment">#abcdefghilnorstuwy.,AH   </span></span><br><span class="line">session = frida.attach(<span class="string">"magic"</span>)</span><br><span class="line">script = session.create_script(<span class="string">"""</span></span><br><span class="line"><span class="string">pool2 = ['e ',' H','is','no','of',' g','bl','ow','ur',' w','in','yo'] </span></span><br><span class="line"><span class="string">pool3 = ["ds ","hot","the",' yo',"ace","thi",'Ah,',' in',' bl','lik']</span></span><br><span class="line"><span class="string">pool = 'abcdefghilnorstuwy.,AH '</span></span><br><span class="line"><span class="string">s=[]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">var xor = new NativeFunction(ptr(0x402CDF), 'void', ['pointer','pointer','pointer']);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function toHex(str,hex)&#123;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  str = str.split("").reverse().join("");</span></span><br><span class="line"><span class="string">  hex = unescape(encodeURIComponent(str))</span></span><br><span class="line"><span class="string">    .split('').map(function(v)&#123;</span></span><br><span class="line"><span class="string">      return v.charCodeAt(0).toString(16)</span></span><br><span class="line"><span class="string">    &#125;).join('')</span></span><br><span class="line"><span class="string">  stri = '0x'+hex</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  return parseInt(stri)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">var remaining = 667;</span></span><br><span class="line"><span class="string">function crackNext() &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">c = 0</span></span><br><span class="line"><span class="string">sol = "                                                                     "</span></span><br><span class="line"><span class="string">for(l =0;l&lt;33;l++)&#123;</span></span><br><span class="line"><span class="string">base = 0x605100+(0x120*l)</span></span><br><span class="line"><span class="string">s[l*5] =  Memory.readS32(ptr(base+0x8))</span></span><br><span class="line"><span class="string">s[l*5+1] = Memory.readS32(ptr(base+0xc))</span></span><br><span class="line"><span class="string">s[l*5+2] = Memory.readS32(ptr(base+0x10))</span></span><br><span class="line"><span class="string">s[l*5+3] = Memory.readS32(ptr(base))</span></span><br><span class="line"><span class="string"> s[l*5+4] = Memory.readS32(ptr(base+0x18))</span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string"> for(var i =0;i&lt;s.length/5;i++)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">xor(ptr(s[i*5+3]),ptr(s[i*5]),ptr(s[i*5+4]))</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">possible = []</span></span><br><span class="line"><span class="string">for(var i=0;i&lt;s.length/5;i++)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">pool_l = []</span></span><br><span class="line"><span class="string">len = s[i*5+2]</span></span><br><span class="line"><span class="string">if(len == 1) pool_l = pool</span></span><br><span class="line"><span class="string">else if(len == 2) pool_l = pool2</span></span><br><span class="line"><span class="string">else if(len == 3) pool_l = pool3</span></span><br><span class="line"><span class="string">else pool_l = pool</span></span><br><span class="line"><span class="string">found = false</span></span><br><span class="line"><span class="string">var fnc1 = new NativeFunction(ptr(s[i*5+3]), 'int', ['pointer','pointer','pointer']);</span></span><br><span class="line"><span class="string">for(var j = 0;j&lt;pool_l.length;j++)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">Memory.writeS32(ptr(0x400000),toHex(pool_l[j]))</span></span><br><span class="line"><span class="string">t = Memory.readS32(ptr(0x400000),len)</span></span><br><span class="line"><span class="string">b = 0x605120+(0x120*i)</span></span><br><span class="line"><span class="string">fnc_r = fnc1(ptr(0x400000),ptr(len),ptr(b))</span></span><br><span class="line"><span class="string">if (fnc_r == 1)&#123;</span></span><br><span class="line"><span class="string">sol = [sol.slice(0,s[i*5+1]),pool_l[j],sol.slice(s[i*5+1]+len)].join('');</span></span><br><span class="line"><span class="string">sol[i*5+1] = pool_l[j]</span></span><br><span class="line"><span class="string">found = true</span></span><br><span class="line"><span class="string">break</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">if(!found)&#123;</span></span><br><span class="line"><span class="string">if(len==3)&#123;</span></span><br><span class="line"><span class="string">sol = [sol.slice(0,s[i*5+1]),"ng ",sol.slice(s[i*5+1]+len)].join('');</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">else&#123;</span></span><br><span class="line"><span class="string">sol = [sol.slice(0,s[i*5+1]),"ll",sol.slice(s[i*5+1]+len)].join('');</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">console.log(sol)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for(var i =0;i&lt;s.length/5;i++)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">//console.log(i*5+3)</span></span><br><span class="line"><span class="string">xor(ptr(s[i*5+3]),ptr(s[i*5]),ptr(s[i*5+4]))</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">  if (--remaining &gt; 0) &#123;</span></span><br><span class="line"><span class="string">    setTimeout(crackNext,70);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">setTimeout(crackNext, 0);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line">    print(message)</span><br><span class="line">script.on(<span class="string">'message'</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><p>Running sol.py</p><p><img src="gdb5.png" alt="gdb5"></p><p>It was fun to use frida. I learned a lot from this challenge. :)</p>]]></content>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> reverse </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>BLE&#39;nin ABCsi : 2 - MITM</title>
      <link href="/BLE-nin-ABCsi-2-MITM/"/>
      <url>/BLE-nin-ABCsi-2-MITM/</url>
      <content type="html"><![CDATA[<p>Serimizin ilk yazısında BLE’nin temellerini öğrendiğimize göre artık BLE kullanan cihazlara yapılabilecek saldırı tekniklerinden bahsebiliriz. Bir BLE cihazımız olsun. Bu cihazımızla genellikle mobil telefonlardaki veya bilgisayara yüklediğimiz uygulamalar ile konuşuruz.</p><ul><li>Android için telefonun kurduğu bağlantılardaki bluetooth trafiğini loglayabilmek için <code>Bluetooth HCI gözetleme günlüğü</code> özelliğini açabilirsiniz.</li><li>IOS için bu işlem biraz zor. Araştırmama rağmen cihazdaki bluetooth trafiğini dumplayabilceğim bi araç bulamadım. Eğer bilen varsa yorum kısmını yeşillendirebilir. <a href="https://developer.apple.com/documentation/corebluetooth" target="_blank" rel="noopener">https://developer.apple.com/documentation/corebluetooth</a> adresinden class isimlerini bulup, bu fonksiyonları Frida ile hooklayarak yarım bir başarı elde ettim ancak tatmin edici olmadı : <a href="blefrida">frida</a></li></ul><p>Android için bluetooth ve ble cihazlarla iletişim kurabileceğimiz, <a href="https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp" target="_blank" rel="noopener">nRF Connect</a> adında uygulama bulunmakta. Kurmanızı öneririm.  </p><p>Bunların dışında yapabileceğimiz saldırı tekniklerini kabaca 3’e ayırabiliriz:</p><ul><li>Man in the middle (MITM)</li><li>Sniffing</li><li>Firmware dump</li></ul><p>Ne için kullanacağımızı kısaca açıklarsak:</p><ul><li>MITM’ı BLE link layer’da encryption kullanmayan cihazlara karşı kullanacağız.</li><li>Sniffing’i  encryption yapmış cihazlara karşı kullanacağız.</li><li>Firmware dump ile hedef cihazımızın kullandığı tüm kodları bulacağız. Özellikle gizli, dokumante edilmemiş özel kodları :)</li></ul><p>Bu yazıda MITM, gelecek yazılarda da diğer teknikleri anlatmaya çalışacağım.<br>Her teknik için ufak ekipmanlar almamız gerekecek :)</p><h2 id="MITM"><a href="#MITM" class="headerlink" title="MITM"></a>MITM</h2><p>Gereksinimler:</p><ul><li>ESP32             $12</li><li>Raspberry Pi      $50</li><li>Bluetooth dongle  $10</li></ul><p>Bu teknik için 2 adet Bluetooth kullanan cihaza ihtiyacımız var. Kendi bilgisyarımız ve bir adet Raspberry Pi. Bluetooth MAC adresinizi değiştirebiliyorsanız dongle almanıza gerek yok. RPI lazım çünkü bir bilgisayarda iki adet bluetooth client’ı çalıştırmak neredeyse imkansız.<br><img src="man.jpeg" width="350" height="200"></p><p>Temel olarak saldırı topolojimiz şu şekilde:</p><p><img src="topoloji.png" alt="topo"></p><p>Hedef cihazımız raspberry pi’ye bağlandığı için advertisement yapmayacak. Biz de bundan faydalanıp  o cihazmışız gibi advertisement yapıcaz. Kullanıcı hedef cihaza bağlandığını düşünerek bizim kurduğumuz sahte cihaza bağlanıcak.</p><p>Kali’de kurduğumuz sahte BLE, hedef cihazdaki tüm özelliklerin aynısını taşıyacak, hatta cihazla aynı MAC adresini de. Dışardan bakan biri için sahte cihazımız ve gerçek cihaz arasında bir fark olmayacak. Kullanıcının yolladığı tüm datayı kali’den raspberry pi’ye yollayacağız. Raspberry pi da gelen datayı hedef cihazımıza yollayacak. Hedef cihazdan dönen data da aynı şekilde kullanıcıya geri dönecek. Böylece kimse farkına varmadan aradan geçen tüm datayı inceleme fırsatını elde etmiş olacağız.</p><p>Tüm bu işlemleri yapan halihazırda geliştirilmiş 2 toolumuz bulunmakta. <a href="https://github.com/securing/gattacker" target="_blank" rel="noopener">GATTacker</a> ve <a href="https://github.com/DigitalSecurity/btlejuice" target="_blank" rel="noopener">btlejuice</a>. GATTacker komple komut satırında çalışmakta. Btlejuice ise web arayüzünde çalışmakta. GATTacker’ı bir cihaz üstünde başarıyla kullandım. Ancak BLECTF için kullandığım ESP32’de işe yaramadı.<br>Btlejuice ise her iki cihazda da çalıştı. O yüzden bu yazıda btlejuice kullanacağız.</p><h2 id="Raspberry"><a href="#Raspberry" class="headerlink" title="Raspberry"></a>Raspberry</h2><p> microSD kartıma raspian imajı atıp raspberry pi’yi ayağa kaldırdım. SSH ile bağlanabilmek için imajın içine boş bir txt dosyası koyup adını <code>ssh</code> yaptım. Raspberry pi’yi ethernet kablosu ile modeme bağlayıp, ip’sini bulduktan sonra ssh ile bağlandım. Default pi:raspberry credleri ile cihaza girdim. VNC server başlatıp, servera bağlandım. Raspberry pi’yi proxy olarak kullanacağız. Bir klasor oluşturup <code>sudo npm install -g btlejuice</code> ile btlejuice’i yükledim. (eğer npmde sıkıntı yaşarsanız npm 8 kurun şu <a href="https://joshtronic.com/2017/12/11/upgrade-to-nodejs-8-on-debian-and-ubuntu/" target="_blank" rel="noopener">linkten</a>)</p><p> Proxy’i <code>node node_modules/btlejuice/bin/cmd_btlejuice_proxy.js</code> ile başlatıyoruz.<br><img src="pi.png" alt="pi"></p><h2 id="Kali"><a href="#Kali" class="headerlink" title="Kali"></a>Kali</h2><p>Kalide de aynı şekilde btlejuice’i kurup bu sefer <code>sudo node node_modules/btlejuice/bin/cmd_btlejuice.js -u &lt;Raspberry IP address&gt; -w</code> komutunu çalıştırıyoruz.</p><p><img src="kali.png" alt="kali"></p><p>Ardından kali’de browser açıp localhost:8080’e gidiyoruz. Sağ üstten bluetooth işaretine bastığımızda cihazları şekilde listeliyorsa işlem tamam demektir. İşaretlediğim cihaz ayarlayacağımız ESP32mizin ismi olacak.</p><p><img src="kali_browser.png" alt="browser"></p><h2 id="ESP32"><a href="#ESP32" class="headerlink" title="ESP32"></a>ESP32</h2><p>Önceki yazıda kullandığım ESP32’ye yeni kod yükleyip, ufak bir sistem kurdum. Bu sefer kod yüklemek için Arduino IDE kullandım. ESP32’nin c kütüphanesini cpp’ye aktarıp Arduinoya geçirmiş abilerimiz. Arduino’ya esp32 kütüphanelerini eklemek için <a href="https://github.com/espressif/arduino-esp32/blob/master/docs/arduino-ide/boards_manager.md" target="_blank" rel="noopener">şu</a> linki takip edebilirsiniz.</p><p>Kod olarak şunu kullandım.<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;BLEDevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;BLEUtils.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;BLEServer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVICE_UUID        <span class="meta-string">"4fafc201-1fb5-459e-8fcc-c5c9c331914b"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHARACTERISTIC_UUID <span class="meta-string">"beb5483e-36e1-4688-b7f5-ea07361b26a8"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCallbacks</span>:</span> <span class="keyword">public</span> BLECharacteristicCallbacks &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onWrite</span><span class="params">(BLECharacteristic *pCharacteristic)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span> value = pCharacteristic-&gt;getValue();</span><br><span class="line">      <span class="keyword">if</span> (value.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> ledPin;</span><br><span class="line">        <span class="keyword">if</span>(value == <span class="string">"Secr3tP4ssw0rd"</span>) ledPin = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">else</span> ledPin = <span class="number">5</span>;</span><br><span class="line">        digitalWrite (ledPin, HIGH);</span><br><span class="line">        delay(<span class="number">500</span>);</span><br><span class="line">        digitalWrite (ledPin, LOW);</span><br><span class="line">      &#125;</span><br><span class="line">      pCharacteristic-&gt;setValue(<span class="string">"MITM my value"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">9400</span>);</span><br><span class="line">  pinMode (<span class="number">5</span>, OUTPUT);</span><br><span class="line">  pinMode (<span class="number">4</span>, OUTPUT);</span><br><span class="line">  BLEDevice::init(<span class="string">"MITMMe"</span>);</span><br><span class="line">  BLEServer *pServer = BLEDevice::createServer();</span><br><span class="line">  BLEService *pService = pServer-&gt;createService(SERVICE_UUID);</span><br><span class="line">  BLECharacteristic *pCharacteristic = pService-&gt;createCharacteristic(</span><br><span class="line">                                         CHARACTERISTIC_UUID,</span><br><span class="line">                                         BLECharacteristic::PROPERTY_READ |</span><br><span class="line">                                         BLECharacteristic::PROPERTY_WRITE</span><br><span class="line">                                       );</span><br><span class="line">  pCharacteristic-&gt;setCallbacks(<span class="keyword">new</span> MyCallbacks());</span><br><span class="line">  pCharacteristic-&gt;setValue(<span class="string">"MITM my value"</span>);</span><br><span class="line">  pService-&gt;start();</span><br><span class="line">  BLEAdvertising *pAdvertising = pServer-&gt;getAdvertising();</span><br><span class="line">  pAdvertising-&gt;start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Kodumuz karakteristiğimize şifre olarak <code>Secr3tP4ssw0rd</code> gönderdiğimizde 4 numaralı pini, farklı bir şifre gönderdiğimizde 5 numaralı pini 500 milisaniye boyunca yakmakta. Arduino IDE ile esp32mize kodu yüklüyoruz.</p><p>Devre şemamızda şu şekilde :</p><p><img src="arduino.png" alt="arduino"></p><p>Devreyi de kurduktan sonra geriye datayı intercept etmek kalıyor :)</p><h2 id="ATIL-KURT"><a href="#ATIL-KURT" class="headerlink" title="ATIL KURT"></a>ATIL KURT</h2><p>Tüm setup’ı kurduktan sonra btlejuice arayüzünde en sağdaki seçeneğe tıklayıp tikleri kaldırın yoksa handlelarımızı karıştırıyor biraz. Ardından bluetooth işaretine tıklayın. Komut satırımızda şunları gördüyseniz tamamdır.</p><p><img src="ble.png" alt="ble"><br>Eğer tikleri kaldırmazsanız işaretlediğim yer yerine bi üst infodaki <code>Fixing Bleno handles</code> mesajını görürsünüz ve nRF Connect tüm handleları göremez.<br>Ardından telefonunzdan nrf connect uygulamasını açıp <code>MITMME</code> cihazına bağlanının.<br><img src="nrf.png" width="350" height="700"></p><p>Şimdi handle’ımıza yanlış şifre girip kırmızı ışığın yandığını görün. Bir de doğru şifreyi yollayıp sarı ışığı yakın.<br>Son olarakta btljuice arayüzüne baktığınızda karşınızda gönderdiğiniz dataları görüceksiniz :)</p><p><img src="mitm.png" alt="mitm"><br>Giden datayı intercept edebiliriz. Doğru şifre girildiği halde bunu yanlışa çevirebiliriz.</p><p><img src="intercept.png" alt="intercept"></p><p>Real life örneklerden biri : <a href="https://blog.attify.com/btlejuice-mitm-attack-smart-bulb/" target="_blank" rel="noopener">https://blog.attify.com/btlejuice-mitm-attack-smart-bulb/</a></p><p>Serinin bir sonraki yazısında pairing’i pin ile yapacağız. Link layerimizi encrypt edip bu trafiğe saldırmayı deneyeceğiz. Görüşmek üzere :)</p>]]></content>
      
      
        <tags>
            
            <tag> Bluetooth </tag>
            
            <tag> Hardware </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>BLE&#39;nin ABCsi : 1 - Basics</title>
      <link href="/BLE-nin-ABCsi-1-Basics/"/>
      <url>/BLE-nin-ABCsi-1-Basics/</url>
      <content type="html"><![CDATA[<p>Bu seride Bluetooth Low Energy hakkında öğrendiğim ne varsa anlatmaya çalışacağım. İlk olarak protokoldeki temel kavramları anlatıp ardından bu kavramları uygulamalı olarak pekiştirebileceğimiz <a href="https://github.com/hackgnar/ble_ctf" target="_blank" rel="noopener">https://github.com/hackgnar/ble_ctf</a> BLECTF ‘in çözümlerinden bahsedeceğim. Sonraki yazımda da BLE cihazların güvenliğine ve saldırı tekniklerine değineceğim.</p><h2 id="Temel-Bilgiler"><a href="#Temel-Bilgiler" class="headerlink" title="Temel Bilgiler"></a>Temel Bilgiler</h2><p>Bluetooth Low Energy yani BLE. İlk olarak Bluetooth 4.0 ile 2011’de karşımıza çıktı. Klasik Bluetooth ile BLE’nin farklarını bir tabloya dökecek olursak;</p><table><thead><tr><th style="text-align:left">Özellik</th><th style="text-align:center">Bluetooth</th><th style="text-align:center">BLE</th></tr></thead><tbody><tr><td style="text-align:left">Network/Topology</td><td style="text-align:center">Scatternet</td><td style="text-align:center">Star Bus</td></tr><tr><td style="text-align:left">Enerji Tüketimi</td><td style="text-align:center">Az (&lt; 30mA)</td><td style="text-align:center">Çok az ( &lt;15mA)</td></tr><tr><td style="text-align:left">Hız</td><td style="text-align:center">700 Kbps</td><td style="text-align:center">1 Mbps</td></tr><tr><td style="text-align:left">Menzil</td><td style="text-align:center">&lt; 30m</td><td style="text-align:center">50 metre.Açık alanda 150</td></tr><tr><td style="text-align:left">RF Frekansı</td><td style="text-align:center">2400 MHz</td><td style="text-align:center">2400 MHz</td></tr><tr><td style="text-align:left">Frekans kanalları</td><td style="text-align:center">79 kanal</td><td style="text-align:center">40 kanal    (3 advertising)</td></tr><tr><td style="text-align:left">Gecikme</td><td style="text-align:center">100ms</td><td style="text-align:center">3ms</td></tr></tbody></table><p>Klasik Bluetooth devamlı veri akışı için tasarlanmıştı. BLE ise uzun aralıklarla ani (burst) veri akışı için tasarlanmış. Mesela arabadaki müzik çalara Bluetooth ile bağlanıp müzik aktarırken sürekli bir veri akışı var ancak bluetoothla çalışan bir lamba butonu siz aç/kapa komutu gönderdiğiniz süre boyunca çalışmakta.</p><p>BLE sayesinde IOT cihazlardaki enerji tüketimi hatrı sayılır bir şekilde azaldı. Bu yüzden IOT cihazlarda klasik Bluetooth yerine BLE kullanılmakta. </p><p>Tüm BLE cihazlar GATT (Generic Attribute Profile) kullanmakta. GATT’ta karşımıza çıkan terimlerden bahsedecek olursak:</p><ul><li><strong>Client</strong> : GATT komutlarını ve isteklerini başlatan, isteklere gelen cevapları kabul eden cihaz. Telefon, Bilgisayar gibi</li><li><strong>Server</strong> : GATT komutlarını ve isteklerini alan, cevapları yollayan cihazlar. Isı sensörü gibi</li><li><strong>Characteristic</strong> : Client ve Server arasında aktarılan data değeri. Pildeki voltaj miktarı </li><li><strong>Properties</strong> : Her karakteriğin özellikleri vardır. READ, WRITE, NOTIFY gibi gibi  </li><li><strong>Service</strong> : Benzer karakteristiklerin toplu hali. Mesela termometre service’i, ısı değerini ve ölçümler arasındaki zamana ait karakteristiği tutabilir.</li><li><strong>Descriptor</strong> : Karakteristik hakkında bilgi. Isı değeri olarak <code>Celcius</code> kullanılacaksa o karakteristikteki descriptora Celcius yazılabilir.</li><li><strong>Identifier</strong> : Services, descriptors, ve karakteristiklerin hepsinin bir UUID’si vardır.  Bu UUID’lere identifier denir.</li></ul><h2 id="BLECTF"><a href="#BLECTF" class="headerlink" title="BLECTF"></a>BLECTF</h2><p>Bu kadar teori yeter biraz elimizi kirletme vakti geldi. <a href="https://github.com/hackgnar/ble_ctf" target="_blank" rel="noopener">https://github.com/hackgnar/ble_ctf</a> adresinde hoşmu hoş bir CTF tarzı olayımız var. BLE’ye başlamak için birebir.</p><p>Bir adet ESP32 ile ile CTF’e başlayabiliyoruz. Türkiyede <a href="https://www.google.com/search?q=esp32" target="_blank" rel="noopener">biraz</a> pahalıya denk geliyor. Ben <a href="https://www.direnc.net/esp-32s-modul" target="_blank" rel="noopener">şu</a> adresteki cihazı satın aldım. Birde 20-30 lira arasında bir Bluetooth dongle almanızı öneririm. </p><p><img src="blectf.png" alt="device"></p><p>CTFte sadece 1 flagi almak için mac adresini değiştirmemiz gerekiyor. Bilgisayarınızda gelen Bluetooth chiplerinin mac adresini genelde değiştiremiyorsunuz. Denemek isterseniz :<br>Önce <code>hciconfig</code> yazıp sisteminizdeki bluetoothları listeleyin. Benim dongle da takılı olduğu için 2 cihaz gözüküyor.<br><img src="hciconfig1.png" alt="hcilist"></p><p>Ardından denemek istediğiniz cihazı <code>hciconfig hciX up</code> ile çalışır hale getirin ve<br><code>bdaddr -i hciX 11:22:33:44:55:66</code> ile mac adresini değiştirmeye çalışın. Eğer benim gibi hata alıyorsanız mac adresi değişmiyor demektir :(</p><p><img src="hciconfig.png" alt="hci"></p><p>BLE hackingle uğraşıcaksanız mac adresini değiştirmeniz çok işinize yarıyacak, özellikle Man in the Middle Attack yaparken :)</p><p><strong>ROM Flashing</strong></p><p>esp32yi flashlamadan önce bilgisayarınıza esp toolcahini kurmanız gerekiyor.<br><a href="http://esp-idf.readthedocs.io/en/latest/get-started/#setup-toolchain" target="_blank" rel="noopener">http://esp-idf.readthedocs.io/en/latest/get-started/#setup-toolchain</a> adresinde ortamınıza göre instructionlara takip ederek toolchaini kurun</p><p>Ardından ctfi hazırlayan abimizin github’ını clonelayın. <code>git clone https://github.com/hackgnar/ble_ctf/</code> . Klonladıktan sonra sırayla:</p><ul><li><code>cd ble_ctf</code></li><li><code>make menuconfig</code></li><li><code>make</code></li><li>Bir sonraki adımdan önce esp32yi usb ile bilgisayarınıza bağlayın</li><li><code>make flash</code></li></ul><p><strong>Gelsin Flagler</strong></p><p>CLI toolları olarak hcitool, bleah, bluetoothctl ve gatttool kullanıcaz. Kendi linux dağıtımınıza göre bu toolları kurmaya çalışın.<br>ESP32mizle iletişim kurabilmemiz için öncelikle MAC adresini bulmamız gerekiyor. Bunun için hcitool scan değil <code>hcitool lescan</code> komutunu kullanıyoruz. Çünkü esp32miz BLE kullanıyor.</p><p><img src="hcitool.png" alt="ble"></p><p>Gördüğünüz üzere esp32miz  <code>BLECTF</code> diyerek advertising yapmakta. Mac adresini kopyaladıktan sonra <code>sudo bleah -b &quot;30:AE:A4:05:4F:E6&quot;-e</code> ile şu ekran görüntüsünü alabiliyoruz.<br><img src="ble.png" alt="ble"></p><p>Bu ekranda yazının ilk kısmında bahsettiğimiz service, karakteristik ve descriptorları görebilirsiniz. Skorumuz 0x2a handlelı karakteristiğimizde tutuluyor. Eğer o karakteristiği gatttool ile okumak istiyorsak :<br><code>gatttool -b 30:AE:A4:05:4F:E6 --char-read -a 0x002a|awk -F&#39;:&#39; &#39;{print $2}&#39;|tr -d &#39; &#39;|xxd -r -p;printf &#39;\n&#39;</code> ile okuyabiliyoruz.</p><p><code>gatttool help</code> ile toolumuzun parametreleri hakkında bilgi edinebilirsiniz. <code>--char-read</code>‘i okuma , <code>--char-write</code>‘ı da yazma işleri için kullanıcaz.<br>Flagleri 0x2c numaralı handle’a 20 karakter uzunlugunda yolluyoruz.</p><p>Github sayfasında ilk flagimiz için <a href="https://github.com/hackgnar/ble_ctf/blob/master/docs/hints/flag1.md" target="_blank" rel="noopener">https://github.com/hackgnar/ble_ctf/blob/master/docs/hints/flag1.md</a> hint bırakmış abimiz.</p><p>İlk flagimizi girmek için <code>gatttool -b 30:AE:A4:05:4F:E6 --char-write-req -a 0x002c -n $(echo -n &quot;12345678901234567890&quot;|xxd -ps)</code>  komutunu giriyoruz.</p><p>Tekrar flag sayacımızı okudugumuzda : <code>Score:1 /20</code> olduğunu görüyoruz YEY</p><p>Girdiğimiz komutların çoğunu tekrar tekrar kullanıcağımız için bash scripti yazmamız çok hoş olur.<br>Default handle olarak score’un handle’ını kullanan, parametre verdiğimizde ise verdiğimiz handle’ı kullanan bir bash scripti yazalım.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">gatttool -b 30:AE:A4:05:4F:E6 --char-read -a <span class="variable">$&#123;1:-0x2a&#125;</span>|awk -F<span class="string">':'</span> <span class="string">'&#123;print $2&#125;'</span>|tr -d <span class="string">' '</span>|xxd -r -p;<span class="built_in">printf</span> <span class="string">'\n'</span></span><br></pre></td></tr></table></figure><p>read.sh olarak kaydettim.</p><p><img src="read.png" alt="read"></p><p>Süper. Birde bunu write için yapalım. İlk parametremiz yazılacak değeri, ikinci parametre de hangi handle’a yazılacağını belirlesin. Eğer 2. parametreye değer girmezsek flag girdiğimiz handle’a yazsın.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">gatttool -b 30:AE:A4:05:4F:E6 --char-write-req -a <span class="variable">$&#123;2:-0x2c&#125;</span> -n $(<span class="built_in">echo</span> -n <span class="variable">$1</span> |xxd -ps)</span><br></pre></td></tr></table></figure><p>bunu da write.sh olarak kaydettim.</p><p>0x2e de zaten 20 karakterlik md5 gözükmekte. Hemen onu flag olarak yazıyoruz.</p><p><img src="2.png" alt="first"></p><p>3.flagimiz device adının md5i.</p><p><img src="3.png" alt="3"></p><p>4.flagimiz, 0x32  handle’ına bir değer yazdığımızda handle’a geliyor.</p><p><img src="4.png" alt="4"></p><p>5.flag 0x16 handle’ında saklı. Baştan 20 karakteri flag handle’imiza yolluyoruz.<br><img src="hidden.png" alt="5"></p><p>6.flag için 0x34 handle’ına “yo” yazıyoruz.<br><img src="6.png" alt="6"></p><p>7 biraz tricky. 0x36 handle’ına 0x7 değerini yazmamızı istiyor.</p><p><img src="7.png" alt="7"></p><p>8 de 7’ye benzer şekilde</p><p><img src="8.png" alt="8"></p><p>9da 0x3c handle’ini 0x0 dan 0xff e kadar bruteforcelamamız isteniyor. </p><p><img src="9.png" alt="9"></p><p>256 deneme bitince flagi giriyoruz</p><p><img src="9_2.png" alt="9_2"></p><p>0x3e handle’imiz bize 1000 kere beni oku diyor.</p><p><img src="10.png" alt="10"></p><p>1-2 Dakika sonra flagimizi veriyor</p><p><img src="10_2.png" alt="10_2"></p><p>Bu sefer farklı bir istek çıkıyor karşımıza <code>listen for single notification</code>. 0x40 handle’ında NOTIFY şeklinde bir property var. Bu property cihaza subscribe olan clientlara notification yollaması demek. GATTtool aracında <code>--listen</code> parametresini write komutumuza eklersek bu işi yapmış oluyoruz.</p><p><img src="11.png" alt="11"></p><p>12de farklı bir handle’in indication’ını dinliyoruz. Indication ve notification nerdeyse aynı şey demek, çok farkları yok.</p><p><img src="12.png" alt="12"></p><p>13 ve 14’te multi-indication ve notification için dinleme yapıyoruz. Flagimizi ilk notificationda değilde ikincide veriyor.</p><p><img src="13.png" alt="13"><br><img src="14.png" alt="14"></p><p>15 Bluetooth mac adresimizi değiştirmemizi istiyor.<br><img src="15.png" alt="15"></p><p>16 Bağlantımızdaki MTU değerimizi değiştirmemizi istiyor. Bunu da gatttool’un interface’i içinde yapıyoruz.</p><p><img src="16.png" alt="16"></p><p>17.flagimiz için handle bize <code>write+resp hello</code> diyor. Bunu cli gatttool ile yapamadım. Kısa bir python scripti ile halloluyor.<br><img src="50.png" alt="50"></p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pygatt</span><br><span class="line">adapter = pygatt.GATTToolBackend()</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> :</span><br><span class="line">    adapter.start()</span><br><span class="line">    device = adapter.connect(<span class="string">"30:AE:A4:05:4F:E6"</span>)</span><br><span class="line">    value = device.char_read_handle(<span class="string">"0x0050"</span>)</span><br><span class="line">    print(str(value))</span><br><span class="line">    x = device.char_write(<span class="string">"0000ff14-0000-1000-8000-00805f9b34fb"</span>,bytearray([ord(<span class="string">'h'</span>),ord(<span class="string">'e'</span>),ord(<span class="string">'l'</span>),ord(<span class="string">'l'</span>),ord(<span class="string">'o'</span>)]),<span class="keyword">True</span>)</span><br><span class="line">    print(x)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    adapter.stop()</span><br></pre></td></tr></table></figure><p><img src="17.png" alt="17"></p><ol start="18"><li>Flag ilginç birşey öğretiyor bize. Karakteristik bize propertilerini verirken NOTIFY yok bende dese de, aslında NOTIFY yapabiliyormuş.</li></ol><p><img src="18.png" alt="18"></p><p>0x54 numaralı handle’ımızda tüm propertieslerimiz var</p><p><img src="19_props.png" alt="19_prop"></p><p>Hepsini deneyerek flagimizin parçalarını toplayıp birleştiriyoruz. 0x54 numaralı handle’ımıza herhangi birşey yazdığımızda handle’a atanan yeni değeri ilk parçamız. Notification olarak bize yolladığı da ikinci parçamız oluyor.</p><p><img src="19.png" alt="19"></p><p>Veee son flagimizi de giriyoruz.</p><p><img src="20.png" alt="20"></p><p>Buraya kadar okuyarak geldiyseniz BLE’nin az çok ne yaptığını anlamışsınızdır diye umuyorum. Serinin sonraki yazısında BLE cihazlara yapılabilcek saldırılardan bahsedeceğim, görüşmek üzere.  </p>]]></content>
      
      
        <tags>
            
            <tag> Bluetooth </tag>
            
            <tag> Hardware </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Mobil Zararlı Analizi - Bölüm 1: Ortamı Kuralım</title>
      <link href="/Mobil-Zararli-Analizi-Bolum-1-Ortami-Kuralim/"/>
      <url>/Mobil-Zararli-Analizi-Bolum-1-Ortami-Kuralim/</url>
      <content type="html"><![CDATA[<p>Bu seride mobil zararlı analizine yeni başlayanlar için bir rehber oluşturmaya çalışacağım. Serinin diğer yazılarında örnek zararlı analizi yapmayı düşünmekteyim. Bu yazımda analiz için ortamı kurmayı ve kullanacağım toolları anlatmaya çalıştım. Yazıyı 4 bölüme ayırabiliriz. </p><ul><li>Ortam</li><li>Toollar</li><li>VM Hardening</li><li>Zararlı bulma </li></ul><h1 id="Ortam"><a href="#Ortam" class="headerlink" title="Ortam"></a>Ortam</h1><p>Analiz ortamı için bir android emulator kullanmamız gerek. Birçok alternatif olmakla birlikte ben genymotion kullanıyorum. Performans olarak Android Studio’nun emulatorunden bir tık daha iyi ve biricik Fridamı çok rahat bir şekilde çalıştırabilmekte.<br>Genymotion kurulumu için <a href="https://www.genymotion.com/fun-zone/" target="_blank" rel="noopener">https://www.genymotion.com/fun-zone/</a> adresine giderek trial’ınızı başlatabilirsiniz. Trial bittikten sonra telefona sms yollama, arama yapma gibi birkaç özellikler gidiyor. Çokta mühim bir değişiklik değil. </p><p>Yükleyip giriş yaptıktan sonra şu görüntü ile karşılacaksınız.<br><img src="geny.png" width="350" height="350"></p><p>Add butonuna basarak sanal makine ekleyebilirsiniz. Ben <code>Custom Phone-6.0-API 23-768x1280</code>‘ı kurdum. Şimdi sırayla aşağıdaki dosyaları emulatorümüze tutup atıyoruz :</p><ul><li><a href="https://androidfilehost.com/?fid=23252070760974384" target="_blank" rel="noopener">1_Genymotion-ARM-Translation_v1.1</a></li><li><a href="https://github.com/opengapps/x86/releases/download/20180731/open_gapps-x86-6.0-pico-20180731.zip" target="_blank" rel="noopener">2_open_gapps-x86-6.0-pico-20180731</a></li><li><a href="https://download.chainfire.eu/696/supersu/" target="_blank" rel="noopener">3_SuperSU-v2.46</a></li><li><a href="http://dl-xda.xposed.info/framework/sdk23/x86/xposed-v89-sdk23-x86.zip" target="_blank" rel="noopener">4_xposed-v89-sdk23-x86</a></li><li><a href="https://forum.xda-developers.com/attachment.php?attachmentid=4393082&amp;d=1516301692" target="_blank" rel="noopener">5_XposedInstaller_3.1.5</a></li><li><a href="https://dl-xda.xposed.info/modules/mobi.acpm.inspeckage_v9_4c7fe1.apk" target="_blank" rel="noopener">6_mobi.acpm.inspeckage_v9_4c7fe1</a></li></ul><p><a href="https://vimeo.com/156745941" target="_blank" rel="noopener">https://vimeo.com/156745941</a> Şu videoda nasıl yüklendiğini görebilirsiniz. Videoda dosyalar android 5.0 için seçilmiş, ancak biz 6.0 yükleyeceğimiz için benim size verdiğim dosya linkleri farklı. Frida genymotionda 6.0dan önce çalışmadığından ötürü  6.0 versiyonunu kullanıyoruz.</p><p>Bu işlemlerden sonra emulatörümüz hazır oldu sayılır.</p><h1 id="Toollar"><a href="#Toollar" class="headerlink" title="Toollar"></a>Toollar</h1><h2 id="Inspeckage"><a href="#Inspeckage" class="headerlink" title="Inspeckage"></a>Inspeckage</h2><p>Yukarıda yüklediğimiz <a href="https://github.com/ac-pm/Inspeckage" target="_blank" rel="noopener">inspeckage</a> dinamik analiz için kullanışlı bir tool. Belirli fonksiyonları hooklayarak analiz edilen uygulamanın hangi fonksiyonları çağırdığını otomatik olarak size bildirmekte. Örneğin bir AES encryption yapıyorsa size hangi key ile neyi encrypt ettiğini web arayüzündeki <code>Crypto</code> sekmesinde size göstermekte.</p><h2 id="jadx"><a href="#jadx" class="headerlink" title="jadx"></a>jadx</h2><p><a href="https://github.com/skylot/jadx/releases" target="_blank" rel="noopener">Jadx</a> yükleyeceğimiz apkları decompile etmede kullanılan bir tool. Android uygulamalar java ile yazıldığı için decompile işlemi genelde sıkıntısız bir şekilde yapılabilmekte. <code>jadx-gui sample.apk</code> komutu ile apkyı inceleyebilirsiniz. Bazen jadx decompile işleminde başarısız oluyor. Örnek</p><p><img src="jadx.png" alt="jadx"></p><p>Bu gibi durumlarda apkımızın içindeki dex dosyasını jar’a çevirerek koda ulaşabiliriz. Apklar aslında bildiğimiz zip dosyasıdır. Uzantısını zip’e çevirerek içindeki dosyaları görebilirsiniz. Zip içindeki classes.dex bizim decompile etmeye çalıştırdığımız kodu barındırır. <a href="https://github.com/pxb1988/dex2jar" target="_blank" rel="noopener">https://github.com/pxb1988/dex2jar</a> tool’u ile bu dex dosyasını jar’a çevirebiliriz.</p><p><code>d2j-dex2jar.sh /path/to/classes.dex</code> komutu ile classes.dex2jar.jar dosyamızı elde ederiz. Bu dosyayı herhangi bir jar dosyası okuyan program ile açabilirisiniz. Hatta bu dosyayı tekrar jadx ile de açabilirsiniz. Ama bu şekilde açtığınızda apk’nın içinde bulunan diğer dosyaları göremezsiniz. AndroidManifest.xml , resource gibi dosyaları.</p><h2 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h2><p>Benim kalbimde ayrı bir yeri olan <code>Dynamic instrumentation toolkit</code> <a href="https://frida.re" target="_blank" rel="noopener">https://frida.re</a></p><p>Fridayı çalıştırabilmemiz için telefonda bir adet frida serverımızın hali hazırda çalışıyor olması gerekiyor. Genymotiondaki sanal makineler x86 tabanlı oldugu için <a href="https://github.com/frida/frida/releases" target="_blank" rel="noopener">https://github.com/frida/frida/releases</a> adresinden en güncel fridaserver-android-x86’yı indiriyoruz. <code>adb push fridaserver /data/local/tmp</code> ile emulatore yolluyoruz. <code>adb shell</code> ile emulatorumuzun içine giriyoruz. <code>cd /data/local/tmp</code> diyerek dosyayı attığımız klasore gidiyoruz. chmod verdikten sonra serverımızı çalıştırıyoruz</p><p>Ardından kendi bilgisayarımızda <code>pip install frida-tools frida</code> ile fridayı yüklüyoruz. Yüklendikten sonra <code>frida-ps -U</code> diyerek telefonda çalışan uygulamaların listesini görebilirsiniz.<br>Ne yapar frida ? Mesela DKHOS’ta çözdüğüm bir mobil sorusundan örnek <a href="https://github.com/eybisi/DKHOS/blob/master/MOBILE400.md" target="_blank" rel="noopener">https://github.com/eybisi/DKHOS/blob/master/MOBILE400.md</a> . Frida android’e özel bir tool da değil. IOS, windows, linux her yerde çalışan bir tool. Örneğin IOSta çalışan bir uygulama için, sistemdeki bluetooth fonksiyonlarını hooklayarak, uygulamanın bluetooth protokölü ile hangi datayı yollayıp aldığını görebilirsiniz. </p><p>Serinin ilerleyen yazılarında zararlı analizi kısımlarında bol bol yer vericem frida’ya. </p><h2 id="Burp"><a href="#Burp" class="headerlink" title="Burp"></a>Burp</h2><p>Zararlılarımızın çoğu komuta kontrol sunucuları ile iletişim kuracağı için bir network proxy çok işimize yarayacak. Emulatorümüze burp kurmak için, önce wifi ayarlarına gidiyoruz.<br><img src="wifi.png" width="200" height="400"></p><p>Ardından <code>Modify network</code> e basarak aşağıdaki ekrana bilgileri giriyoruz. Genymotiondaki sanal makineler default olarak 192.168.56.1 ip adresini kullanmakta.<br><img src="burp.png" width="200" height="400"></p><p>Şimdi burp sertifikamızı telefona yüklememiz gerekiyor. <a href="http://burp" target="_blank" rel="noopener">http://burp</a> adresine gidip sertifikayı indirirken telefonun browserı çöktüğü için bu işi manuel yapacağız. Kendi web browserınıza proxy ayarı çekip, burp sertifikanızı indirin. Sertifikanın uzantısını .cer’e çevirin. <code>adb push /path/to/cert.cer /storage/emulated/0/Downloads</code> komutu ile emulatore sertifikayı yollayın. Ardından telefonun <code>Settings</code> kısmından sırayla Security-&gt;Install From SD Card diyip sertifikayı yüklediğiniz klasore gidin.<br><img src="cert.png" width="200" height="400"><br>Kurmak için pin ayarlamınızı isteyecek.</p><p>İşlemi yaptıktan sonra burpte proxy ayarlarına gidip 192.168.56.1 : 8080 i ekleyin</p><p><img src="burp2.png" alt="burp2"></p><p>Artık emulatordeki HTTP ve WebSocket isteklerini burpten görebilirsiniz. </p><h1 id="VM-Hardening"><a href="#VM-Hardening" class="headerlink" title="VM Hardening"></a>VM Hardening</h1><p>Bu kısımı emulator ve root detection yapan zararlılar için anlatacağım. Çoğu zararlı emulatorde çalışıp çalışmadığını anlamak için  build.props dosyasındaki keylere bakar. Bizde bu dosyadaki değerleri değiştirerek bu detectiondan kurtulabiliriz. Bunun için öncelikle /system klasorunu writeable yapmamız lazım. <code>adb shell</code> ile bağlandıktan sonra <code>sudo su</code> diyoruz. Ardından <code>mount -o remount,rw /system</code> diyerek /system klasorunu rw yapıyoruz. <code>adb pull /system/build.prop</code> diyerek dosyamızı çekiyoruz. Değişiklikleri yaptıktan sonra <code>adb push build.prop /system/build.prop</code> ile tekrar dosyamızı yerine koyuyoruz. Örneğin benim emulatorumdeki prop dosyam <a href="build.prop">build.prop</a> Bunun dışında sistemdeki binary dosyaları kontrol eden zararlılar da olabiliyor. Bunlar için en güzel yöntem frida. Kontrol ettikleri fonksiyonları bulmanız ile scripti yazmanız 2 dknızı almaz.</p><h1 id="Zararli-bulma"><a href="#Zararli-bulma" class="headerlink" title="Zararlı bulma"></a>Zararlı bulma</h1><p>Twitterdaki yabancı abilerimiz örnek buldukça paylaşmakta. <a href="https://twitter.com/virqdroid" target="_blank" rel="noopener">@virqdroid</a>  <a href="https://koodous.com" target="_blank" rel="noopener">https://koodous.com</a> adında muhteşem bir site var. Kendiniz rule yazarak siteye yüklenen apklar içinde zararlı bulabilirsiniz. Yakın zamanda apklab.io sitesi açılacak orası da efsane olucak gibi.</p>]]></content>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Malware </tag>
            
            <tag> Analiz </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CTFZone 2018 android_ololo_country_checker</title>
      <link href="/CTFZone-2018-android-ololo-country-checker/"/>
      <url>/CTFZone-2018-android-ololo-country-checker/</url>
      <content type="html"><![CDATA[<p>Points : 314 , 8 takım çözdü</p><p>Sorunun açıklaması :<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">It&apos;s a foreign android application. Let&apos;s try to guess the country!</span><br></pre></td></tr></table></figure></p><p>Ve bir apk verildi. <a href="ololo.s.apk">ololo.apk</a></p><p>Apkdaki dosyalarımız :<br><img src="jadx.png" alt="apk"></p><p>APKyı jadx ile açtığımda, jadx’in classları düzgün decompile edemediğini gördüm. Hazır açmışken native kütüphane var mı diye baktım ve lib/armeabi-v7a altında <a href="libnative-lib.so">libnative-lib.so</a> dosyasını gördüm. Şimdii normalde android emulatoru olarak genymotion kullanmaktaydım. Ancak bu native so dosyasını apk’nın çalıştırabilmesi için arm tabanlı bir imaj kullanmam gerek, genymotionda arm sistem ayağa kaldırmak malesef mümkün değil. O yüzden paşa paşa android studioyu kurup armeabi-v7a lı bir imaj kurmamız gerekiyor. Ve apkmızın MainActivity’sindeki<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if (System.getProperty(&quot;os.arch&quot;).equalsIgnoreCase(&quot;armeabi-v7a&quot;)) &#123;</span><br><span class="line">    System.loadLibrary(&quot;native-lib&quot;);</span><br></pre></td></tr></table></figure></p><p>şu if’i kaldırmamız gerekiyor. Kaldırmazsak so dosyasını yükleyemiyor . Bu işlem için önce <code>apktool d ololo.apk</code> ile decompile edip ilgili yeri silin (bu sefer size bırakıyorum) ve <code>apktool b ololo.apk</code> ile build edin. Sign ettikten sonra apkyı telefona yükleyin.Uygulamayı açtığımızda karşımıza aşağıdaki ekran geliyor. Check’e bastığınızda crash almıyorsanız if kısmını doğru yapmışsınız demektir. Her checke basıldığında resim ve alttaki stringler değişiyor.</p><p><img src="open.png" alt="open"></p><p>Java classlarını decompile edebilmek için önce apk’yı zip’e çevirdim ve içinden classes.dex’i çıkardım. Ardından bu dex dosyasını <a href="https://github.com/pxb1988/dex2jar/releases" target="_blank" rel="noopener">https://github.com/pxb1988/dex2jar/releases</a> ile jar’a çevirdim. Jar dosyasını <a href="http://www.benf.org/other/cfr/" target="_blank" rel="noopener">http://www.benf.org/other/cfr/</a> aracı ile java hale getirdim.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar cfr_0_132.jar classes-dex2jar.jar &gt; main.java</span><br></pre></td></tr></table></figure><p><a href="main.java">main.java</a> dosyasını incelemeye koyuldum. Çok güzel anti-debugging methodları bulunmaktaydı. Genel olarak aaa.aie.* classlarının ilk methodu get, ikincisi de gelen parametre ile bu get’in karşılaştırılması idi.<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> aaa.aie;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.telephony.TelephonyManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ekd</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">egdi</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((TelephonyManager)context.getSystemService(<span class="string">"phone"</span>)).getDeviceId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">ehkdi</span><span class="params">(Context object, String[] arrstring)</span> </span>&#123;</span><br><span class="line">        object = ekd.egdi(object);</span><br><span class="line">        <span class="keyword">int</span> n = arrstring.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!arrstring[i].equalsIgnoreCase((String)object)) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>aaa.aie.eka.ega -&gt; getSDKVersion   </li><li>aaa.aie.eka.egn -&gt; getPackageName  // uygulamanın adı</li><li>aaa.aie.ekd.egdi -&gt; getDeviceId</li><li>aaa.aie.eki.egsi -&gt; getSubscriberId</li><li>aaa.aie.ekl.egsci -&gt; getSimCountryIso</li><li>aaa.aie.ekpn.egln -&gt; getLine1Number</li></ul><p>ololo.ololo.ololo.MainActivity.getSoBody methodu res/raw altındaki resimleri alıp işleme tabi tutmaktaydı. Daha fazla işlem göremeyince asıl işin so dosyasında yapıldığını düşünüp native dosyamıza dalmaya karar verdim.</p><p>libnative-lib.so dosyamızı IDAPro’da açtım. 2 fonksiyonumuz dışında hiçbir fonksiyonun ismi hoş gözükmüyordu.</p><p><img src="ida.png" alt="ida"></p><p>O iki fonksiyonun isminin öyle olmasının nedeni apkımızın MainActivity sinde çağırılmaları. Bu fonksiyonları incelemeye koyuldum. Öncelikle sorunun ismiyle alakalı olduğu için <code>Java_ololo_ololo_ololo_MainActivity_checkSomethings</code> ile başladım. Fonksiyonumuz yaklaşık 90 tane variable tanımladıktan sonra 4 adet fonksiyon çağırmakta</p><p><img src="variable.png" alt="var"></p><p>Bu 4 fonksiyonun birine gittiğimde gözüme hemen paket isimleri ilişti</p><p><img src="fonk.png" alt="fonk"></p><p>Tam olarak emin olmasamda <code>aaa.aie.ekl.egsci</code> ‘yi çağırıp dönen değeri dword_9ABC’ye atadığı sonucuna vardım. Değişkeni ve fonksiyonun adını ilgili method ne yapıyorsa ona göre adlandırdım. Bu örnek için fonksiyon ismi -&gt; getSimCountryIso ve dword_9ABC -&gt; strSimCountryIso</p><p>4 fonksiyonda da bu şekilde isimlendirme yaptım.</p><p><img src="md5.png" alt="md5"></p><p>j_ ile başlayan fonksiyonlarda çok fazla işlem vardı. string değerleri sırayla bu 3 fonksiyona tabi  tutuluyordu. Belkii md5 ?? .. Bi ihtimal diyip v84’e md5(strSubscriberId) diyip yoluma devam ettim. Açıkcası burdan sonra biraz tahmin biraz atma tutma oldu diyebilirim. Kafamdaki senaryo cihazdan topladığı bilgilerin md5ini alıp karşılaştırıyor eğer uyuyorsa bize flagi veriyor.</p><p><img src="md5s.png" alt="md5s"></p><p>Bu byte<em>**</em> değişkenlerindeki değerlere bakarsak;</p><p><img src="byte.png" alt="byte"></p><p>online araçlarla hepsinin karşılığını buluyoruz.<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">phone    = 8203412(03bec67d849e7114f1a828e1628495fe)/7793952(c377ec2ae9bc906448b6c39326e42f04)</span><br><span class="line">deviceID = 89123988(e176e3acf427e59308520009b3e2a793)/01982375(b400b6e082104ce63f18f45e64c2fbfd)</span><br><span class="line">iso_code = KZ(4aceb7d6b4564ec96bc6605cd5af37e7)/KG(56d721ccadb8bbfd8b47390d82a6ea4b)</span><br><span class="line">subscriberID = 31231712(5b529e731eab2fb96185b0e9769fc498)</span><br><span class="line">sdk_ver  = 19(1f0e3dad99908345f7439f8ffabdffc4)</span><br><span class="line">package_name = ololo.ololo.ololo(5b4802bc02112666dabafe0c77ac18d0)</span><br></pre></td></tr></table></figure></p><p>Evet tahminlerim doğru gibi. Daha fazla arm’da boğulmadan bu değerleri döndürecek bir frida scripti yazıp denemek lazım. Eğer daha önce frida kurmadıysanız kısaca özetlersek</p><p><code>pip install frida</code> ile client’a frida kuruyoruz.</p><p><code>https://github.com/frida/frida/releases</code>dan telefona veya emulatore uygun son surum server’ı indirip <code>adb push frida-dosyaismi /data/local/tmp</code> ile pushluyoruz. <code>chmod +x frida-dosyaismi</code> <code>./frida-dosyaismi</code> ile serverı başlatıyoruz.<br>Ardından clientta <code>frida-ps -U</code> dersek telefonda çalışan uygulamaları görebiliriz.<br>Instrumentation yapıcağımız uygulamayı listeden kopyalayıp <code>frida -U ololo.ololo.ololo -l script.js</code> diyerek scriptimizi load edebiliyoruz.  </p><p>Frida scriptimiz çok basit.</p><ul><li>aaa.aie.eka.ega -&gt; getSDKVersion   </li><li>aaa.aie.eka.egn -&gt; getPackageName  // uygulamanın adı</li><li>aaa.aie.ekd.egdi -&gt; getDeviceId</li><li>aaa.aie.eki.egsi -&gt; getSubscriberId</li><li>aaa.aie.ekl.egsci -&gt; getSimCountryIso</li><li>aaa.aie.ekpn.egln -&gt; getLine1Number</li></ul><p>şu fonksiyonlara md5’ini bulduğumuz değerleri döndüreceğiz.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> JavaString = Java.use(<span class="string">'java.lang.String'</span>);</span><br><span class="line">    <span class="keyword">var</span> EADB = Java.use(<span class="string">"aaa.aie.eadb"</span>);</span><br><span class="line">    EADB.headb.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Called - aaa.aib.aib()"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> EKPN = Java.use(<span class="string">"aaa.aie.ekpn"</span>); <span class="comment">// PhoneNumber</span></span><br><span class="line">    EKPN.egln.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Called - aaa.aie.ekpn.egln()"</span>);</span><br><span class="line">        <span class="comment">// return "7793952";</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"8203412"</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> EKD = Java.use(<span class="string">"aaa.aie.ekd"</span>); <span class="comment">// DeviceId</span></span><br><span class="line">    EKD.egdi.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Called - aaa.aie.ekd.egdi()"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"89123988"</span>;</span><br><span class="line">        <span class="comment">// return "01982375";</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> EKL = Java.use(<span class="string">"aaa.aie.ekl"</span>); <span class="comment">// SimIsoCountry</span></span><br><span class="line">    EKL.egsci.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Called - aaa.aie.ekl.egcsi()"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"KZ"</span>;</span><br><span class="line">        <span class="comment">//return "KG";</span></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">var</span> EKA = Java.use(<span class="string">"aaa.aie.eka"</span>);</span><br><span class="line">     EKA.ega.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">"Called - aaa.aie.eka.ega()"</span>);</span><br><span class="line">       <span class="keyword">return</span> JavaString.$<span class="keyword">new</span>(<span class="string">"19"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   EKA.egn.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">"Called - aaa.aie.eka.egn()"</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"ololo.ololo.ololo"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">var</span> EKI = Java.use(<span class="string">"aaa.aie.eki"</span>);</span><br><span class="line">    EKI.egsi.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Called - aaa.aie.eki.egsi()"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"31231712"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Java.choose(<span class="string">"ololo.ololo.ololo.MainActivity"</span>, &#123;</span><br><span class="line">        onMatch : <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">            instance.e.value = <span class="number">0</span>;</span><br><span class="line">            instance.c.value = <span class="number">0</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        onComplete : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Vee FLAG : ctfzone{1t_1s_0l0l0_g00d_4tt6mpt}</p><p><img src="sol.png" alt="sol"></p>]]></content>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Android </tag>
            
            <tag> Reverse </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CTFZone 2018 Never ever be fooled to pay the ransomware!</title>
      <link href="/CTFZone-2018-Never-ever-be-fooled-to-pay-the-ransomware/"/>
      <url>/CTFZone-2018-Never-ever-be-fooled-to-pay-the-ransomware/</url>
      <content type="html"><![CDATA[<p>Points: 269 , Yaklaşık 9 takım çözmüştü sanırım.</p><p>Sorunun açıklaması :<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Has Your Android Phone Been Infected with Malware? — Yes! — It’s awful but we have a cure!</span><br></pre></td></tr></table></figure></p><p>Soruda bize bir <a href="phonedump.zip">zip dosyası</a> verildi. İçinden imageinfo.txt ve adb backup dosyası çıktı. Adb backup dosyasını<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=mybackup.ab bs=<span class="number">24</span> skip=<span class="number">1</span> | openssl zlib -d &gt; mybackup.tar</span><br></pre></td></tr></table></figure></p><p>komutu ile tar dosyasına çevirdim ve açtım.<br>Tar içinde 2 klasor vardı. <code>shared</code> dosyası telefonun sd kartındaki dosyaların, <code>apps</code> te telefonda yüklü olan uygulamaların klasorüydü. Soru açıklaması okunduğunda bizden encrypt edilmiş dosyaları decrypt etmemizi istediği anlaşılıyordu. /shared/0/DCIM/Camera/ içinde sırasıyla</p><ul><li><a href="IMG_20180101_071505.jpg.xxx">IMG_20180101_071505.jpg.xxx</a></li><li><a href="IMG_20180101_071505.jpg.salt">IMG_20180101_071505.jpg.salt</a></li><li><a href="IMG_20180101_071505.jpg.iv">IMG_20180101_071505.jpg.iv</a></li></ul><p>bulunmaktaydı. Flagde büyük olasılıkla resimde idi.( Uygulamalara sd kart okuma-yazma izni verirken dikkatli olmak lazım :) )</p><p>Şimdi sıra bu encryption’ı yapan uygulamayı bulmaktaydı. <code>apps</code> klasorunde olan <code>com.dfwgxc.zimcdwpealgy</code> aşırı tanıdık geldi ve bir heyecan bastı. Yakın zamanda ortaya ortaya çıkan ve Türk kullancıları hedef alan <code>Anubis</code> zararlısının random paket isimlerine çok benziyordu.<a href="https://mcoskuner.net/2018/07/11/anubis-zararlisi-ve-sahibinden-uygulamasi-kisim-2-indirilen-apk-dosyalarinin-incelenmesi/" target="_blank" rel="noopener">Şurada</a> analizini görebilirsiniz <code>/shared/0/Download/</code> içindeki <code>adobe flash player.apk</code> yı jadx’te açınca kesin emin oldum. APK’nın paket adı <code>com.dfwgxc.zimcdwpealgy</code> ile uyuşuyordu. Uygulamadan ekran görüntüsü</p><p><img src="apk.jpg" alt="APK"></p><p>Gördüğünüz üzere uygulama obfuscated ve reflection kullanmakta. Encrypt edilmiş dosyaların isimlerinden anlaşılan o ki dosyalar AES ile encrypt edilmiş. Benimde aklıma  ‘Acaba bu key obfuscated olan apk’nın içinde mi ?’ sorusu geldi. Uygulamayı çalıştırıp frida ile gerekli AES fonksiyonları hooklayarak key’i çıkarmayı deneyecektim. Ancak apk çalışmadı :(<br>Bu sefer <code>apps/com.dfwgxc.zimcdwpealgy/r/app_files/oat/arm64</code> içindeki <code>muquieljmg.vdex</code> dosyasını incelemeye başladım.  Vdex nedir derseniz google amcanın sitesinden :<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vdex: contains the uncompressed DEX code of the APK, with some additional metadata to speed up verification.</span><br></pre></td></tr></table></figure></p><p>Vdex dosyasını <code>https://github.com/anestisb/vdexExtractor</code> ile önce dex’e sonrada dex2jar ile <a href="muquieljmg.apk_classes-dex2jar.jar">jar</a>‘a çevirdim. Oluşan <code>muquieljmg.apk_classes-dex2jar.jar</code>‘ı jd-gui ile açtım.</p><p><img src="jar.jpg" alt="jar"></p><p>Sonunda okunur şeyler görmeye başlamıştım. </p><p><img src="hm.png" alt="hmm"></p><p><code>faweifunhiunfg2uylbh8634gh783ghinegkrjln18hi8123</code> fonksiyonu sd kart içindeki dosyaları tek tek gezerek, dosyanın ismi “xxx”,”iv” yada “salt” ile bitiyor mu diye kontrol etmekte. Encryption yaptığı dosyaya denk gelirse tekrar encryption yapmamak için bu işlemi yapıyor. <code>faweifunhiunfg2uylbh8734gh778ghinegkrGln18hi8123</code> fonksiyonu deviceID’sinin md5’ini almak üzere id’yi <code>HIUHuihqfdiuhIUQWHDUIhgfi1278e412y78yDASVBDUYvwq</code> fonksiyonuna yolluyor</p><p><img src="md5.png" alt="md5"></p><p>Ve dosya ismi ile md5(deviceID)’i <code>agaierughl8y3g98ersiugohserkihgoas8erg89</code> fonksiyonuna yollanıyor.</p><p><img src="wow.png" alt="wow"></p><p>Fonksiyona giren paramString1 -&gt; md5(deviceID), paramStrings2 -&gt; dosya ismi. Resimden anlaşılacağı üzere md5(deviceID)’yi key olarak kullanıyor ve dosyayı encrypt ediyor. Pekii .. Biz encryption yapılmış cihazın id’sini nasıl bulucaz ?<br>Soruda verilen zipten bir de </p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt; Bizone &gt; cat imageinfo.txt </span><br><span class="line">[Computed Hashes] Image</span><br><span class="line"> MD5 checksum:    E60E8FA8C64C9FE136E1731F388CF7B0</span><br><span class="line"> SHA1 checksum:   687BCAB465DA1631B86A0EC64D92BE45EC7B96EE</span><br><span class="line"></span><br><span class="line">[Device Information]</span><br><span class="line"> Android version:8.1.0</span><br><span class="line"> Android security patch level:July 1, 2018</span><br><span class="line"> Model:Mi A1</span><br><span class="line"> Wi-fi MAC: 04:b1:67:18:47:gg</span><br><span class="line"> Local time: 2018-07-19 15:48:54 UTC</span><br><span class="line"> Android time: 2018-01-01 07:15:37 EST</span><br><span class="line"> Shell permissions: shell</span><br><span class="line"> Serial Number: 4b26a8969905</span><br><span class="line"></span><br><span class="line"> IMEI 1:867562039629283</span><br><span class="line"> IMEI 2:867562039629291</span><br></pre></td></tr></table></figure><p>şeklinde bir dosya daha çıkmıştı. Device ID’sini yani IMEI 1 yada IMEI 2’nin md5ini alıp, decrypt işlemini yapıcak bir java programı yazmamız gerekiyor. Soruyu yapan abimiz bizi düşünüp decryption işlemini yapan fonksiyonu da oraya eklemiş <code>UIHiuhLIUHIHFiuhIUWEFHi8uh23l78ry78hfguisdh</code>.İlgili fonksiyonların olduğu <a href="PkdGTfG.java">class</a></p><p>IMEI 1’in md5’ini alıyoruz<br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&lt; ~ &gt; <span class="built_in">echo</span> -n <span class="string">"867562039629283"</span> | md5sum</span><br><span class="line">55bbc19a737d5f93e5ce09424a1b1b8a</span><br></pre></td></tr></table></figure></p><p>Parametrelerle biraz oynayarak çalışcak hale getiriyoruz</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.Key;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKeyFactory;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.PBEKeySpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.KeySpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    String paramString1 =  <span class="string">"55bbc19a737d5f93e5ce09424a1b1b8a"</span>;</span><br><span class="line">    String paramString2 = <span class="string">"IMG_20180101_071505.jpg"</span>;</span><br><span class="line">    Object localObject1 = <span class="keyword">new</span> FileInputStream(paramString2+<span class="string">".salt"</span>);</span><br><span class="line">    Object localObject2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">8</span>];</span><br><span class="line">    ((FileInputStream)localObject1).read((<span class="keyword">byte</span>[])localObject2);</span><br><span class="line">    ((FileInputStream)localObject1).close();</span><br><span class="line">    Object localObject3 = <span class="keyword">new</span> FileInputStream(paramString2 + <span class="string">".iv"</span>);</span><br><span class="line">    localObject1 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">    ((FileInputStream)localObject3).read((<span class="keyword">byte</span>[])localObject1);</span><br><span class="line">    ((FileInputStream)localObject3).close();</span><br><span class="line">    localObject2 = <span class="keyword">new</span> SecretKeySpec(SecretKeyFactory.getInstance(<span class="string">"PBKDF2WithHmacSHA1"</span>).generateSecret(<span class="keyword">new</span> PBEKeySpec(paramString1.toCharArray(), (<span class="keyword">byte</span>[])localObject2, <span class="number">65536</span>, <span class="number">256</span>)).getEncoded(), <span class="string">"AES"</span>);</span><br><span class="line">    Cipher cipher1 = Cipher.getInstance(<span class="string">"AES/CBC/PKCS5Padding"</span>);</span><br><span class="line">    cipher1.init(<span class="number">2</span>, (Key)localObject2, <span class="keyword">new</span> IvParameterSpec((<span class="keyword">byte</span>[])localObject1));</span><br><span class="line">    localObject1 = <span class="keyword">new</span> FileInputStream(paramString2+<span class="string">".xxx"</span>);</span><br><span class="line">    FileOutputStream p4 = <span class="keyword">new</span> FileOutputStream(paramString2 + <span class="string">".decrypted"</span>);</span><br><span class="line">    localObject2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> i = ((FileInputStream)localObject1).read((<span class="keyword">byte</span>[])localObject2);</span><br><span class="line">      <span class="keyword">if</span> (i == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      localObject3 = cipher1.update((<span class="keyword">byte</span>[])localObject2, <span class="number">0</span>, i);</span><br><span class="line">      <span class="keyword">if</span> (localObject3 != <span class="keyword">null</span>) &#123;</span><br><span class="line">        p4.write((<span class="keyword">byte</span>[])localObject3);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] cip = cipher1.doFinal();</span><br><span class="line">    <span class="keyword">if</span> (cip != <span class="keyword">null</span>) &#123;</span><br><span class="line">      p4.write(cip);</span><br><span class="line">    &#125;</span><br><span class="line">    p4.close();</span><br><span class="line">    p4.flush();</span><br><span class="line">    p4.close();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ve<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javac hm.java</span><br><span class="line">java hm</span><br></pre></td></tr></table></figure></p><p>diyerek çalıştırıyoruz. Çıktı olarak bize IMG_20180101_071505.jpg.decrypted veriyor. Vee flag karşımızda</p><p><img src="IMG_20180101_071505.jpg.decrypted" alt="final"></p>]]></content>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Android </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
