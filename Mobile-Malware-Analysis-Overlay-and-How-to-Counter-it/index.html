<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Defeating OverlayIn my last anubis post I touched on overlay and how malware use process scanning to get top process. If somehow we can bypass those techniques, in a way overlay can be defeated. In th">
<meta property="og:type" content="article">
<meta property="og:title" content="Mobile Malware Analysis : Overlay and How to Counter It (Partly)">
<meta property="og:url" content="http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/index.html">
<meta property="og:site_name" content="hedgehog&#39;s cave">
<meta property="og:description" content="Defeating OverlayIn my last anubis post I touched on overlay and how malware use process scanning to get top process. If somehow we can bypass those techniques, in a way overlay can be defeated. In th">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/frida.jpg">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/huh.jpg">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/hide.gif">
<meta property="article:published_time" content="2019-06-10T13:17:36.000Z">
<meta property="article:modified_time" content="2022-10-25T07:16:04.853Z">
<meta property="article:author" content="abc">
<meta property="article:tag" content="Malware,CTF,Reverse Engineering,Android,Mobile">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/frida.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Mobile Malware Analysis : Overlay and How to Counter It (Partly)</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="hedgehog&#39;s cave" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/Control-Flow-Unflattening/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/DEF-CON-Quals-2019-Vitor/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&text=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&is_video=false&description=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Mobile Malware Analysis : Overlay and How to Counter It (Partly)&body=Check out this article: http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&name=Mobile Malware Analysis : Overlay and How to Counter It (Partly)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&t=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Defeating-Overlay"><span class="toc-number">1.</span> <span class="toc-text">Defeating Overlay</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLDR"><span class="toc-number">2.</span> <span class="toc-text">TLDR;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-process-scanning-and-why-malware-use-it"><span class="toc-number">3.</span> <span class="toc-text">What is process scanning and why malware use it?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem"><span class="toc-number">4.</span> <span class="toc-text">Problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Thoughts"><span class="toc-number">5.</span> <span class="toc-text">Thoughts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android-Version-vs-Technique"><span class="toc-number">6.</span> <span class="toc-text">Android Version vs Technique</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Processes-in-Android"><span class="toc-number">7.</span> <span class="toc-text">Processes in Android</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Thoughts-1"><span class="toc-number">8.</span> <span class="toc-text">Thoughts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">9.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">10.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Mobile Malware Analysis : Overlay and How to Counter It (Partly)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">abc</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-06-10T13:17:36.000Z" itemprop="datePublished">2019-06-10</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Defeating-Overlay"><a href="#Defeating-Overlay" class="headerlink" title="Defeating Overlay"></a>Defeating Overlay</h2><p>In my last <a href="https://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/">anubis</a> post I touched on overlay and how malware use process scanning to get top process. If somehow we can bypass those techniques, in a way overlay can be defeated. In this<br>post I will try to explain my way of finding a protection for some android versions. </p>
<h2 id="TLDR"><a href="#TLDR" class="headerlink" title="TLDR;"></a>TLDR;</h2><p>You can use </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">    <span class="type">Method</span> <span class="variable">setter</span> <span class="operator">=</span> android.os.Process.class.getMethod(<span class="string">&quot;setArgV0&quot;</span>, String.class); </span><br><span class="line">    setter.invoke(android.os.Process.class, text); &#125; </span><br><span class="line">    <span class="keyword">catch</span> (NoSuchMethodException e) &#123; e.printStackTrace(); &#125; </span><br><span class="line">    <span class="keyword">catch</span> (IllegalAccessException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InvocationTargetException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>to change your application’s name to protect users that have android 5.1 and 6.0 </p>
<h2 id="What-is-process-scanning-and-why-malware-use-it"><a href="#What-is-process-scanning-and-why-malware-use-it" class="headerlink" title="What is process scanning and why malware use it?"></a>What is process scanning and why malware use it?</h2><p>Process scanning is a way for getting list of running processes. Most of the android malware use process scanning to get top activity currenlty running. Then they use this information for deploying overlay attacks. Knowing which processes is currenly top active, helps to select which phishing overlay page malware will use and make attack more believable. Android was aware of this attack vector and take some steps to disable these functions. Here is a <a target="_blank" rel="noopener" href="https://jaredrummler.com/2017/09/13/android-processes/">blogpost</a> cover overall situtation. </p>
<p>Generally android is secure environment for processes. Each application have different userid and none of application&#x2F;process have rights to read&#x2F;write of other processes data. But up until API 23, there was always a way to read process list without any permission. After API 23, applications need to get PACKAGE_USAGE_STATS (system permission) or Accessibility permissions to read process list.</p>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Lets say <code>com.x.bank</code> is targeted application by malware. Malware infected the device and overlays <code>com.x.bank</code>. Mechanism of overlaying itself can be divided in two elements. First one is triggering when <code>com.x.bank</code> started (achieved via process scanning) and second one is how an app can overlay itself on top of another app. Second element is functionality of android applications. Any app can open itself with the help of services&#x2F;receivers&#x2F;intents. We can’t interfere that functionality. What about first element of overlay mechanism ? Is there a way for an application to defend itself by not being in process list or giving randomized name to process list ? This was in my head for a long time. </p>
<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>Randomize package name<br>Change process name<br>Hide from usage stats service ? :)</p>
<h2 id="Android-Version-vs-Technique"><a href="#Android-Version-vs-Technique" class="headerlink" title="Android Version vs Technique"></a>Android Version vs Technique</h2><p>Each android version invervals malware use different techniques to list process&#x2F;package names. </p>
<table>
<thead>
<tr>
<th align="center">API</th>
<th align="center">Technique</th>
</tr>
</thead>
<tbody><tr>
<td align="center">&lt;&#x3D; 19</td>
<td align="center">runningTask.get(0).topActivity</td>
</tr>
<tr>
<td align="center">20,21</td>
<td align="center">getRunningAppProcesses().get(0).processName</td>
</tr>
<tr>
<td align="center">22 23</td>
<td align="center">&#x2F;proc&#x2F;pid&#x2F;cmdline, &#x2F;proc&#x2F;pid&#x2F;stat</td>
</tr>
</tbody></table>
<blockquote>
<p>23 |  UsageStats (anubis) or Accessibility (hydra)</p>
</blockquote>
<p>According to <a target="_blank" rel="noopener" href="https://developer.android.com/about/dashboards">Android</a> usage distrubition chart of android versions as follows :</p>
<table>
<thead>
<tr>
<th align="center">Version</th>
<th align="center">Codename</th>
<th align="center">API</th>
<th align="center">Usage Percent</th>
</tr>
</thead>
<tbody><tr>
<td align="center">4.4</td>
<td align="center">Kitkat</td>
<td align="center">19</td>
<td align="center">%7.6</td>
</tr>
<tr>
<td align="center">5.0</td>
<td align="center">Lollipop</td>
<td align="center">21</td>
<td align="center">%3.5</td>
</tr>
<tr>
<td align="center">5.1</td>
<td align="center"></td>
<td align="center">22</td>
<td align="center">%14.4</td>
</tr>
<tr>
<td align="center">6.0</td>
<td align="center">Marshmallow</td>
<td align="center">23</td>
<td align="center">%21.3</td>
</tr>
<tr>
<td align="center">7.0</td>
<td align="center">Nougat</td>
<td align="center">24</td>
<td align="center">%18.1</td>
</tr>
<tr>
<td align="center">7.1</td>
<td align="center"></td>
<td align="center">25</td>
<td align="center">%10.1</td>
</tr>
<tr>
<td align="center">8.0</td>
<td align="center">Oreo</td>
<td align="center">26</td>
<td align="center">%14.0</td>
</tr>
<tr>
<td align="center">8.1</td>
<td align="center"></td>
<td align="center">27</td>
<td align="center">%7.5</td>
</tr>
</tbody></table>
<h2 id="Processes-in-Android"><a href="#Processes-in-Android" class="headerlink" title="Processes in Android"></a>Processes in Android</h2><p>If I can change process name of the application, since malware checks static package names, I can avoid being detected. </p>
<p>Sadly I can only do something for <code>/proc/pid</code> listing techniques. (which is %35.7 of android users tho) To get information about process there are several places. You can try yourself also.</p>
<ul>
<li>&#x2F;proc&#x2F;pid&#x2F;cmdline</li>
<li>&#x2F;proc&#x2F;pid&#x2F;stat</li>
<li>&#x2F;proc&#x2F;pid&#x2F;status</li>
</ul>
<p>To change process name I came across to prctl system call. Using PR_SET_NAME and New name as argument one can change current process’ name. Maybe I could call prctl from native side of application and change process name. But before writing code I tried it with frida. I hooked prctl and checked if its called with PR_SET_NAME (15). Then I replaced called string with another string. </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> prctlPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;prctl&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> prctlOri = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(prctlPtr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>])</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(prctlPtr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>( <span class="keyword">function</span> (<span class="params">a,b,c,d,e</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="number">15</span>)&#123;</span><br><span class="line">        pname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(<span class="title function_">ptr</span>(b))</span><br><span class="line">        <span class="keyword">if</span> (pname.<span class="title function_">includes</span>(<span class="string">&quot;cbunlkwsqtz&quot;</span>))&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(a,b,c,d,e)</span><br><span class="line">            <span class="keyword">for</span> ( i=<span class="number">0</span>; i&lt; <span class="number">9</span> ;i++)&#123;</span><br><span class="line">                pname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(<span class="title function_">ptr</span>(b-i))</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Brute: &quot;</span>+i+ <span class="string">&quot; &quot;</span>+pname)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">writeS64</span>(<span class="title function_">ptr</span>(b-<span class="number">9</span>),<span class="number">0x306362617830</span>)</span><br><span class="line">            pname = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(<span class="title function_">ptr</span>(b-<span class="number">9</span>))</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;YAY ! new process name : &quot;</span>,pname)</span><br><span class="line">            <span class="keyword">var</span> fd = <span class="title function_">prctlOri</span>(a,b-<span class="number">9</span>,c,d,e)</span><br><span class="line">            <span class="keyword">return</span> fd</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">var</span> fd = <span class="title function_">prctlOri</span>(a,b,c,d,e)</span><br><span class="line">    <span class="keyword">return</span> fd</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>]));</span><br></pre></td></tr></table></figure>
<p>And <code>voila</code></p>
<p><img src="/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/frida.jpg" alt="frida"></p>
<p>Ps commands shows new process name but malware doesn’t get changed name. Because proc&#x2F;pid&#x2F;cmdline didn’t change. Also why prctl even called ? Since I didnt know much about how android processes get their names I searched up again. <code>How can process change its cmdline or stat value ?</code> <a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/302948/change-proc-pid-environ-after-process-start">Stackoverflow</a>. But does Android application have argc or argv ? So I searched aosp project and come across to <a target="_blank" rel="noopener" href="https://github.com/aosp-mirror/platform_frameworks_base/blob/6bebb8418ceecf44d2af40033870f3aabacfe36e/cmds/app_process/app_main.cpp#L332">this</a> :) See the comment </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// Also note that this is a constant for &quot;normal&quot; android apps.</span><br><span class="line">// Since they&#x27;re forked from zygote, the size of their command line</span><br><span class="line">// is the size of the zygote command line.</span><br><span class="line">//</span><br><span class="line">// We change the process name of the process by over-writing</span><br><span class="line">// the start of the argument block (argv[0]) with the new name of</span><br><span class="line">// the process, so we&#x27;d mysteriously start getting truncated process</span><br><span class="line">// names if the zygote command line decreases in size.  </span><br></pre></td></tr></table></figure>
<p>In android there is a process called Zygote. Zygote is the ancestor of all processes like init0. Every process is fork of zygote.<br>After being forked from zygote, application’s process name changes within app_main.cpp. Knowing that I looked up which function I could used and saw <a target="_blank" rel="noopener" href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/os/Process.java"><code>setArgv0</code></a> which sound right. Then I tried with application. Opened up android studio.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os.Process</span><br><span class="line">Process.setArgv0(<span class="string">&quot;0xabc0&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>But android studio didn’t resolve setArgv0. If I go to declartion of Process class I can see setArgv0 there.</p>
<p><img src="/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/huh.jpg" alt="huh"></p>
<p>So whats happenning ?<br>See <code>@hide</code> tag. That tag means its hidden from developer because they are internally used and can be changed in future APIs. Also these methods can be classified in four list  after <a target="_blank" rel="noopener" href="https://developer.android.com/distribute/best-practices/develop/restrictions-non-sdk-interfaces">Android 9</a>. But we are trying to protect users that use Android 6. So there is no problem. </p>
<p>You can’t directly call these hidden methods but you can use reflection (big thanks to <a target="_blank" rel="noopener" href="https://twitter.com/ibrahimsn98">@ibrahimsn98</a>!) </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">    <span class="type">Method</span> <span class="variable">setter</span> <span class="operator">=</span> android.os.Process.class.getMethod(<span class="string">&quot;setArgV0&quot;</span>, String.class); </span><br><span class="line">    setter.invoke(android.os.Process.class, text); &#125; </span><br><span class="line">    <span class="keyword">catch</span> (NoSuchMethodException e) &#123; e.printStackTrace(); &#125; </span><br><span class="line">    <span class="keyword">catch</span> (IllegalAccessException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InvocationTargetException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>With this, process name is changed everywhere cmdline,stat,status. YAY!</p>
<p>I created 2 apk to test this. One apk is getting processes. I used this <a target="_blank" rel="noopener" href="https://github.com/jaredrummler/AndroidProcesses">project</a> which is used in Anubis. And other app is changing its process name with <code>setArgv0</code>. </p>
<p><img src="/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/hide.gif" alt="gif"></p>
<p>The reason why app is not in process list is scanner app tries to access &#x2F;data&#x2F;app&#x2F;package-name folder. Since we changed the name, it tries to access &#x2F;data&#x2F;app&#x2F;0xabc0 which is not there. So it doesn’t display it.</p>
<h2 id="Thoughts-1"><a href="#Thoughts-1" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>For other methods I couldn’t find anything. Android can give rights&#x2F;permissions to applications for not being in stats menu to avoid being detected by <code>USAGE_STATS</code> or  by <code>Accessibility</code> maybe . Targeted apps can be saved from overlaying attacks with these rights. </p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>With little code you can change your application’s process name in certain API versions. It can be used to protect users from malware :)</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://www.geeksonsecurity.com/android-overlay-malware/2016/07/27/android-overlay-malware-analysis/">https://www.geeksonsecurity.com/android-overlay-malware/2016/07/27/android-overlay-malware-analysis/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.symantec.com/connect/blogs/android-malware-finds-new-ways-derive-current-running-tasks">https://www.symantec.com/connect/blogs/android-malware-finds-new-ways-derive-current-running-tasks</a></p>
<p><a target="_blank" rel="noopener" href="https://www.nowsecure.com/blog/2017/05/25/android-overlay-malware-system-alert-window-permission/">https://www.nowsecure.com/blog/2017/05/25/android-overlay-malware-system-alert-window-permission/</a></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Defeating-Overlay"><span class="toc-number">1.</span> <span class="toc-text">Defeating Overlay</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLDR"><span class="toc-number">2.</span> <span class="toc-text">TLDR;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-process-scanning-and-why-malware-use-it"><span class="toc-number">3.</span> <span class="toc-text">What is process scanning and why malware use it?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem"><span class="toc-number">4.</span> <span class="toc-text">Problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Thoughts"><span class="toc-number">5.</span> <span class="toc-text">Thoughts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android-Version-vs-Technique"><span class="toc-number">6.</span> <span class="toc-text">Android Version vs Technique</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Processes-in-Android"><span class="toc-number">7.</span> <span class="toc-text">Processes in Android</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Thoughts-1"><span class="toc-number">8.</span> <span class="toc-text">Thoughts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">9.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">10.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&text=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&is_video=false&description=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Mobile Malware Analysis : Overlay and How to Counter It (Partly)&body=Check out this article: http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&title=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&name=Mobile Malware Analysis : Overlay and How to Counter It (Partly)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://eybisi.run/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/&t=Mobile Malware Analysis : Overlay and How to Counter It (Partly)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022
    abc
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-129796595-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-129796595-1');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'eybisi-run';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
