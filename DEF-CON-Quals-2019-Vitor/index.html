<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Vitor Defcon 2019 qualifiersda sorulmuş android reverse kategorisine ait bir ctf sorusu. Matruşka misali birkaç bölümden oluşuyor. Soruda bize bir apk veriliyor. Uygulama bizden input olarak flagi ist">
<meta property="og:type" content="article">
<meta property="og:title" content="DEF CON Quals 2019 : Vitor">
<meta property="og:url" content="http://eybisi.run/DEF-CON-Quals-2019-Vitor/index.html">
<meta property="og:site_name" content="hedgehog&#39;s cave">
<meta property="og:description" content="Vitor Defcon 2019 qualifiersda sorulmuş android reverse kategorisine ait bir ctf sorusu. Matruşka misali birkaç bölümden oluşuyor. Soruda bize bir apk veriliyor. Uygulama bizden input olarak flagi ist">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://eybisi.run/DEF-CON-Quals-2019-Vitor/mm.jpg">
<meta property="og:image" content="http://eybisi.run/DEF-CON-Quals-2019-Vitor/ida1.png">
<meta property="og:image" content="http://eybisi.run/DEF-CON-Quals-2019-Vitor/ida2.png">
<meta property="og:image" content="http://eybisi.run/DEF-CON-Quals-2019-Vitor/ida3.png">
<meta property="article:published_time" content="2019-05-25T23:22:29.000Z">
<meta property="article:modified_time" content="2022-10-25T07:16:04.847Z">
<meta property="article:author" content="abc">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Reverse">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://eybisi.run/DEF-CON-Quals-2019-Vitor/mm.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>DEF CON Quals 2019 : Vitor</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="hedgehog&#39;s cave" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/DEF-CON-Quals-2019-Veryandroidoso/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://eybisi.run/DEF-CON-Quals-2019-Vitor/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&text=DEF CON Quals 2019 : Vitor"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&is_video=false&description=DEF CON Quals 2019 : Vitor"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DEF CON Quals 2019 : Vitor&body=Check out this article: http://eybisi.run/DEF-CON-Quals-2019-Vitor/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&name=DEF CON Quals 2019 : Vitor&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&t=DEF CON Quals 2019 : Vitor"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Vitor"><span class="toc-number">1.</span> <span class="toc-text">Vitor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-1-Dex"><span class="toc-number">2.</span> <span class="toc-text">Aşama 1 : Dex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-2-SO"><span class="toc-number">3.</span> <span class="toc-text">Aşama 2 : SO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-3-Shellkod"><span class="toc-number">4.</span> <span class="toc-text">Aşama 3 Shellkod:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-4-ROP"><span class="toc-number">5.</span> <span class="toc-text">Aşama 4 : ROP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-5-JS"><span class="toc-number">6.</span> <span class="toc-text">Aşama 5 : JS</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        DEF CON Quals 2019 : Vitor
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">abc</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-05-25T23:22:29.000Z" itemprop="datePublished">2019-05-26</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Android/" rel="tag">Android</a>, <a class="tag-link-link" href="/tags/CTF/" rel="tag">CTF</a>, <a class="tag-link-link" href="/tags/Reverse/" rel="tag">Reverse</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Vitor"><a href="#Vitor" class="headerlink" title="Vitor"></a>Vitor</h2><p><img src="/DEF-CON-Quals-2019-Vitor/mm.jpg" alt="mm"></p>
<p>Defcon 2019 qualifiersda sorulmuş android reverse kategorisine ait bir ctf sorusu. Matruşka misali birkaç bölümden oluşuyor. Soruda bize bir <a target="_blank" rel="noopener" href="https://github.com/o-o-overflow/dc2019q-vitor-public/blob/master/vitor.apk">apk</a> veriliyor. Uygulama bizden input olarak flagi istiyor ve doğruluğunu kontrol ediyor. </p>
<h2 id="Asama-1-Dex"><a href="#Asama-1-Dex" class="headerlink" title="Aşama 1 : Dex"></a>Aşama 1 : Dex</h2><p>Verilen apkyı <code>jadx</code> gibi araçlarla decompile edip java kodunu inceleyebiliyoruz. Classlara göz attığımızda <code>fc</code> class’ını görüyoruz. Genel olarak her aşamada yapılacak olanlar birbirine benzer. Sadece ilk aşama için detaylı bir açıklama yapacağım. Flagi kontrol eden fonksiyonumuz şu şekilde:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">cf</span><span class="params">(MainActivity mainActivity, String str)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">z</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cfa(mainActivity, p1EncFn);</span><br><span class="line">        cfa(mainActivity, p5EncFn);</span><br><span class="line">        cfa(mainActivity, randEncFn);</span><br><span class="line">        cfa(mainActivity, rand2EncFn);</span><br><span class="line">        <span class="keyword">if</span> (str.startsWith(<span class="string">&quot;OOO&#123;&quot;</span>) &amp;&amp; str.endsWith(<span class="string">&quot;&#125;&quot;</span>) &amp;&amp; str.length() == <span class="number">45</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cf(mainActivity, dp1(mainActivity, <span class="keyword">new</span> <span class="title class_">File</span>(mainActivity.getFilesDir(), p1EncFn), g0(str.substring(<span class="number">4</span>, <span class="number">44</span>))), str)) &#123;</span><br><span class="line">                <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(mainActivity.getFilesDir(), <span class="string">&quot;bam.html&quot;</span>);</span><br><span class="line">                <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> mainActivity.mWebView;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                stringBuilder.append(<span class="string">&quot;file:///&quot;</span>);</span><br><span class="line">                stringBuilder.append(file.getAbsolutePath());</span><br><span class="line">                stringBuilder.append(<span class="string">&quot;?flag=&quot;</span>);</span><br><span class="line">                stringBuilder.append(Uri.encode(str));</span><br><span class="line">                webView.loadUrl(stringBuilder.toString());</span><br><span class="line">                z = mValid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> z;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>İlk kontrolden anlıyoruzki Flag <code>OOO&#123;</code> ile başlayıp <code>&#125;</code> ile bitiyor. Uzunluğu 45. Ardından sırasıyla incelersek:</p>
<p><code>g0(str.substring(4, 44)))</code> : g0 fonksiyonuna flagimizin süslü parantezler içerisinde kalan input yollanıyor. g0 fonksiyonu :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] g0(String str) &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">byte</span>[] bArr = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="type">byte</span>[] bytes = str.getBytes();</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        bArr[i] = (<span class="type">byte</span>) <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">0</span>; i2 &lt; <span class="number">10</span>; i2++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            bArr[i] = (<span class="type">byte</span>) ((<span class="type">byte</span>) (bArr[i] ^ bytes[(i2 * <span class="number">4</span>) + i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bArr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Fonksiyon 4 bytelık bir array döndürüyor. Bu 4 byte’ı da şu şekilde hesaplıyor:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">0</span>]^flag[<span class="number">8</span>]^flag[<span class="number">16</span>]^flag[<span class="number">24</span>]^flag[<span class="number">32</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">1</span>]^flag[<span class="number">9</span>]^flag[<span class="number">17</span>]^flag[<span class="number">25</span>]^flag[<span class="number">33</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">2</span>]^flag[<span class="number">10</span>]^flag[<span class="number">18</span>]^flag[<span class="number">26</span>]^flag[<span class="number">34</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">3</span>]^flag[<span class="number">11</span>]^flag[<span class="number">19</span>]^flag[<span class="number">27</span>]^flag[<span class="number">35</span>]</span><br></pre></td></tr></table></figure>

<p>g0 fonksiyonundan dönen 4byte, dp1 fonksiyonuna 3. parametre olarak gidiyor.</p>
<p><code>dp1(mainActivity, new File(mainActivity.getFilesDir(), p1EncFn), g0(str.substring(4, 44)))</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> File <span class="title function_">dp1</span><span class="params">(Context context, File file, <span class="type">byte</span>[] bArr)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">byte</span>[] hash = hash(bArr);</span><br><span class="line">    <span class="type">byte</span>[] readAllBytes = Files.readAllBytes(file.toPath());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">AlgorithmParameterSpec</span> <span class="variable">ivParameterSpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(initVector);</span><br><span class="line">        <span class="type">Key</span> <span class="variable">secretKeySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(hash, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">instance</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5PADDING&quot;</span>);</span><br><span class="line">        instance.init(<span class="number">2</span>, secretKeySpec, ivParameterSpec);</span><br><span class="line">        readAllBytes = instance.doFinal(readAllBytes);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), p1Fn);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file2);</span><br><span class="line">        fileOutputStream.write(readAllBytes, <span class="number">0</span>, readAllBytes.length);</span><br><span class="line">        fileOutputStream.flush();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="keyword">return</span> file2;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Bu fonksiyonda önce 4byte’ın md5ini alıyor. Bu digest değerini aes keyi olarak kullanıyor ve input olarak verilen dosyayı decrypt ediyor. dp1’i çağırıken class’ın başında tanımlanmış<br><code> public static String p1EncFn = &quot;ckxalskuaewlkszdva&quot;;</code> değeri kullanılıyor. Apk’ımızın içerisindeki asset klasorune bakarsak bu dosyayı görebiliyoruz. Peki bu dosyayı decrypt edip ne yapıyor ?</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">cf</span><span class="params">(Context context, File file, String str)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir().getAbsolutePath());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">loadClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DexClassLoader</span>(file.getAbsolutePath(), file2.getAbsolutePath(), file2.getAbsolutePath(), ClassLoader.getSystemClassLoader()).loadClass(<span class="string">&quot;ooo.p1.P1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ((Boolean) loadClass.getDeclaredMethod(<span class="string">&quot;cf&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Context.class, String.class&#125;).invoke(loadClass, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;context, str&#125;)).booleanValue();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Decrypt edilen dosya DexClassLoader APIsi ile contexte yükleniyor. Bu olayı android malwarelerinde çok görüyoruz. Tersine mühendisliği zorlaştırmak için “packing” yöntemini sıklıkla kullanıyorlar. </p>
<p>ooo.p1.P1 class’ı invoke edilip o class içerisinden bir fonksiyon çağırılıyor. Bu fonksiyon boolean bir değer döndürüyor ( O fonksiyonda baska fonksiyonlar cagiriyor tabi ). Ve flagin doğruluğu kontrol edilmiş oluyor .</p>
<p>Aşama 1’i toparlasak:</p>
<ul>
<li>Flagin belli indexlerini XORla ve 4byte’ı al</li>
<li>md5</li>
<li>ckxalskuaewlkszdva dosyasını bu keyle decrypt et</li>
<li>decrypt edilen dosya içerisinden ooo.p1.P1 classını load et.</li>
</ul>
<p>Peki biz bu 4byte’ı nasıl bulabiliriz ?</p>
<p>Biliyoruzki decrypt edilen dosyanın bir jar dosyası olması lazım. Neden ? Çünkü kullanılan DexClassLoader fonksiyonu dosya formatı olarak jar kabul ediyor. Jar dosyaları da bir nevi zip ve zip dosyalarının Magic Byte’ını yani dosya tipini anladığımız header kısmını biliyoruz. <code>\x50\x4b\x03\x04</code> dosya headerı olarak bu byteları arayacağız.</p>
<p>Şimdi brute için şu şekilde bir python scripti yazalım:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">IV = <span class="built_in">bytes</span>([<span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>])</span><br><span class="line">N_BIT = <span class="number">4</span></span><br><span class="line">S_BIT = <span class="number">2</span>**<span class="number">7</span> + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">DATA = <span class="built_in">open</span>(<span class="string">&#x27;ckxalskuaewlkszdva&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read(<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key_1 <span class="keyword">in</span> <span class="built_in">range</span>(S_BIT):</span><br><span class="line">    <span class="keyword">for</span> key_2 <span class="keyword">in</span> <span class="built_in">range</span>(S_BIT):</span><br><span class="line">        <span class="built_in">print</span>(key_1, key_2, end=<span class="string">&#x27;\r&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> key_3 <span class="keyword">in</span> <span class="built_in">range</span>(S_BIT):</span><br><span class="line">            <span class="keyword">for</span> key_4 <span class="keyword">in</span> <span class="built_in">range</span>(S_BIT):</span><br><span class="line">                key = hashlib.md5(</span><br><span class="line">                    <span class="built_in">bytes</span>([key_1, key_2, key_3, key_4])).digest()</span><br><span class="line">                aes = AES.new(key, AES.MODE_CBC, IV)</span><br><span class="line">                decrypted_data = aes.decrypt(DATA)</span><br><span class="line">                <span class="keyword">if</span> decrypted_data.startswith(<span class="string">b&#x27;\x50\x4b\x03\x04&#x27;</span>):</span><br><span class="line">                     <span class="built_in">print</span>(key_1, key_2, key_3, key_4)</span><br><span class="line">                     IV = <span class="built_in">bytes</span>([<span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>, <span class="number">19</span>, <span class="number">55</span>])</span><br><span class="line">                     f= <span class="built_in">open</span>(<span class="string">&quot;ckxalskuaewlkszdva&quot;</span>,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">                     DATA = f.read()</span><br><span class="line">                     f.close()</span><br><span class="line">                     key = hashlib.md5(</span><br><span class="line">                        <span class="built_in">bytes</span>([key_1, key_2, key_3, key_4])).digest()</span><br><span class="line">                     aes = AES.new(key, AES.MODE_CBC, IV)</span><br><span class="line">                     decrypted_data = aes.decrypt(DATA)</span><br><span class="line">                     f = <span class="built_in">open</span>(<span class="string">&quot;out.zip&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">                     f.write(decrypted_data)</span><br><span class="line">                     f.close()</span><br></pre></td></tr></table></figure>

<p>Girdiğimiz stringler sonuçta ASCII yani 7bitlik aralıkta olduğu için XOR sonucu elde edilecek byte aralığıda bu aralığa sahip olmak zorunda. </p>
<p>Burda dikkatinizi <code>DATA = open(&#39;ckxalskuaewlkszdva&#39;, &#39;rb&#39;).read(32)</code> satırına vermenizi rica ediyorum. Neden 32 byte okuyorum burada ? </p>
<p><a href="aes.png">aes</a></p>
<p>AES CBC encryption şemasında sizin dosyanız ne kadar büyüse de ilk bloğun son halini ilgilendiren bir olay gerçekleşmiyor. Yani biz sadece ilk blok için deneme yaparak keyi bulabiliriz. Bu çok büyük ölçüde işimizi kolaylaştırıyor. 1.6 MB dosyanın boyutunu 32byte’a düşürmüş oluyoruz. </p>
<p>Bu scripti çalıştırdığımızda birkaç dakika içerisinde ilk keyimizi alıyoruz.</p>
<p>Key 1 : <code>\x17\x01\x2f\x03</code></p>
<p>Her aşamamızda flagin belirli bytelarına dair bilgi ede ede ilerliyoruz. </p>
<h2 id="Asama-2-SO"><a href="#Asama-2-SO" class="headerlink" title="Aşama 2 : SO"></a>Aşama 2 : SO</h2><p>İlk aşamaya benzer bir dex dosyası ile karşılaşıyoruz.</p>
<p>Bu sefer jar dosyası yerine bir adet <code>.so</code> dosyası oluşturulması gerekiyor ve XORlanan indexler değişik.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i2 = <span class="number">0</span>; i2 &lt; <span class="number">10</span>; i2 += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        bArr[i] = (byte) ((byte) (bArr[i] ^ bytes[((i2 + <span class="number">1</span>) * <span class="number">4</span>) + i]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">4</span>]^flag[<span class="number">12</span>]^flag[<span class="number">20</span>]^flag[<span class="number">28</span>]^flag[<span class="number">36</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">5</span>]^flag[<span class="number">13</span>]^flag[<span class="number">21</span>]^flag[<span class="number">29</span>]^flag[<span class="number">37</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">6</span>]^flag[<span class="number">14</span>]^flag[<span class="number">22</span>]^flag[<span class="number">30</span>]^flag[<span class="number">38</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">7</span>]^flag[<span class="number">15</span>]^flag[<span class="number">23</span>]^flag[<span class="number">31</span>]^flag[<span class="number">39</span>]</span><br></pre></td></tr></table></figure>


<p>Aynı scripti kullanarak zip headeri yerine .so dosyanın yani ELF headerini <code>\x73\x45\x4c\x46</code> yazıyoruz, input dosyasını <code>mmdffuoscjdamcnssn</code> olarak değiştirip ikinici keyimizi de alıyoruz.</p>
<p>Key2 : <code>\x3c\x27\x43\x60</code></p>
<h2 id="Asama-3-Shellkod"><a href="#Asama-3-Shellkod" class="headerlink" title="Aşama 3 Shellkod:"></a>Aşama 3 Shellkod:</h2><p>Bu sefer işler değişiyor. Biliyoruzki so dosyasından xxx fonksiyonu çağırılıyor. </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> String <span class="title function_">xxx</span><span class="params">(String str, String str2)</span>;</span><br></pre></td></tr></table></figure>


<p>So dosyanı IDA ile açıp incelediğimizde bu fonksiyonu görebiliyoruz.</p>
<p><img src="/DEF-CON-Quals-2019-Vitor/ida1.png" alt="ida1.png"></p>
<p>Daha kolay anlaşılması için değişken ve fonksiyonlari isimlendirdim.</p>
<p>Önce asset klasorunden <code>xtszswemcwohpluqmi</code> dosyası okunuyor ve key hesaplandıktan sonra bu dosya decrypt ediliyor. Bu sefer biraz olaylar farklı. Keyi hesaplamak için fonksiyon şu şekilde:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">K2_0 = <span class="number">0</span>;</span><br><span class="line">flaga = flag + <span class="number">4</span>;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">3</span>; i &lt; <span class="number">10</span>; i += <span class="number">3</span> )</span><br><span class="line">  K2_0 ^= *&amp;flaga[<span class="number">4</span> * (i - <span class="number">1</span>)];</span><br><span class="line"><span class="keyword">return</span> K2_0;</span><br></pre></td></tr></table></figure>

<p>yani : </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">8</span>]^flag[<span class="number">20</span>]^flag[<span class="number">32</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">9</span>]^flag[<span class="number">21</span>]^flag[<span class="number">33</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">10</span>]^flag[<span class="number">22</span>]^flag[<span class="number">34</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">11</span>]^flag[<span class="number">23</span>]^flag[<span class="number">35</span>]</span><br></pre></td></tr></table></figure>


<p>Key hesaplandiktan sonra: </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i )</span><br><span class="line"> &#123;</span><br><span class="line">   *&amp;p3enc[<span class="number">4</span> * i] ^= K2_0;</span><br><span class="line">   K2_0 += <span class="number">0x31333337</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p> fonksiyonuna veriliyor ve dosya bu şekilde decrypt ediliyor. Peki bu sefer neye göre decrypt edicez ? Decrypt edildikten sonra bir assembly kodu elde ediceğimiz belli. Çünkü fonksiyonun devamında bu alani fonksiyon şeklinde çağrılıyor. </p>
<p><img src="/DEF-CON-Quals-2019-Vitor/ida2.png" alt="ida2"></p>
<p> Bu cepte. Fonksiyon çağırılmadan önceki android log’unun bastığı değere baktığımızda </p>
<p> <code>Jumping to nopsled in 3, 2, 1, ...</code> stringini görüyoruz. Nop sled ne demekti shellkod demekti. NOP instructionunı shellkod yazan herkes illaki kullanmıştır. Instruction’ın byte karşılığı <code>0x90</code>. Sled olunca da bundan bir sürü demek. Decrypt ederken 4byte 4byte gidildiği için encrypted dosyanın ilk 4 byteını <code>0x90909090</code> ile XORlarsak keyimizi elde ederiz. </p>
<p><code>hex(0x90909090^0xfef3b7de)</code> :  <code>\x6e\x63\x27\x4e</code> keyini veriyor. Bu key ile dosyayi decrypt etmek istersek :</p>
<p>Key3: <code>\x6e\x63\x27\x4e</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;xtszswemcwohpluqmi&quot;</span>,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">data = f.read()</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">#K2_0 = hex(0x90909090^0xfef3b7de)</span></span><br><span class="line"><span class="comment">#endianess</span></span><br><span class="line">K2_0 = <span class="number">0x4e27636e</span></span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;shell_out.dat&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line"></span><br><span class="line">    f.write(xor(data[<span class="number">4</span>*i:<span class="number">4</span>*i+<span class="number">4</span>],p32(K2_0)))</span><br><span class="line">    K2_0 += <span class="number">0x31333337</span></span><br><span class="line">    K2_0 = K2_0 &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">f.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Oluşan dosyayı <code>ndisasm -b 32 shell_out.dat</code> şeklinde kontrol edebilirsiniz.</p>
<h2 id="Asama-4-ROP"><a href="#Asama-4-ROP" class="headerlink" title="Aşama 4 : ROP"></a>Aşama 4 : ROP</h2><p>En zor kısım burası. Shellkodun ne yaptığını anlamamız gerek.</p>
<p>Fonksiyona girmeden önce stackteki değerlerimize bakalım:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00008C8F                 mov     edx, [ebp+flag?]</span><br><span class="line">.text:00008C92                 mov     ebx, [ebp+cx_data]</span><br><span class="line">.text:00008C98                 mov     esi, [ebp+size]</span><br><span class="line">.text:00008C9E                 mov     [esp], edx      ; s</span><br><span class="line">.text:00008CA1                 mov     [esp+4], ebx    ; src</span><br><span class="line">.text:00008CA5                 mov     [esp+8], esi    ; n</span><br><span class="line">.text:00008CB5                 call    ecx</span><br></pre></td></tr></table></figure>

<p>Shellkod çağırılırken ret adresi de pushlanacağı için stack değerlerimiz 4 artıyor.</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">90</span>                nop</span><br><span class="line">E800000000        call <span class="number">0x25</span>           <span class="comment">// 0x25i stacke pushla</span></span><br><span class="line"><span class="number">5B</span>                pop ebx             <span class="comment">// ebx = 0x25</span></span><br><span class="line"><span class="number">83</span>EB05            sub ebx,byte +<span class="number">0x5</span>   <span class="comment">// ebx = 0x20</span></span><br><span class="line"><span class="number">83</span>EB20            sub ebx,byte +<span class="number">0x20</span>  <span class="comment">// ebx = 0x0 + (Shellkodun yüklendiği base)</span></span><br><span class="line"><span class="number">8B</span>7C2404          mov edi,[esp+<span class="number">0x4</span>]   <span class="comment">//flag</span></span><br><span class="line"><span class="number">31</span>C9              <span class="keyword">xor</span> ecx,ecx         </span><br><span class="line"><span class="number">83</span>C710            add edi,byte +<span class="number">0x10</span>  <span class="comment">//4byte kaydır = flag[0]</span></span><br><span class="line">BA02000000        mov edx,<span class="number">0x2</span>         </span><br><span class="line"><span class="number">330F</span>              <span class="keyword">xor</span> ecx,[edi]       <span class="comment">//flag[i:i+4] ^ ecx</span></span><br><span class="line"><span class="number">83</span>C710            add edi,byte +<span class="number">0x10</span>  <span class="comment">//4byte kaydır</span></span><br><span class="line"><span class="number">83</span>EA01            sub edx,byte +<span class="number">0x1</span>   <span class="comment">//edxi azalt</span></span><br><span class="line"><span class="number">75F</span>6              jnz <span class="number">0x3a</span>            <span class="comment">//loop 2 yapıcak yani flag[0:4] ^ flag[16:20]</span></span><br><span class="line"><span class="number">83</span>EF20            sub edi,byte +<span class="number">0x20</span>  <span class="comment">//flagın basına geri dön</span></span><br><span class="line"><span class="number">89</span>D8              mov eax,ebx         <span class="comment">//eax = 0</span></span><br><span class="line"><span class="number">05</span>C8000000        add eax,<span class="number">0xc8</span>        <span class="comment">//eax = 200;</span></span><br><span class="line">BA32000000        mov edx,<span class="number">0x32</span>        <span class="comment">//edx = 50;</span></span><br><span class="line"><span class="number">3108</span>              <span class="keyword">xor</span> [eax],ecx       <span class="comment">//ecxte key vardı; 200 ofsetindeki değerler anlamsız</span></span><br><span class="line"><span class="number">83</span>C004            add eax,byte +<span class="number">0x4</span>   <span class="comment">//4byte ilerle</span></span><br><span class="line"><span class="number">83</span>EA01            sub edx,byte +<span class="number">0x1</span>   <span class="comment">//edx-1 ; 50 kez xorlanıcak; 50*4 =200; 200+200=400 tam dosya boyu</span></span><br><span class="line"><span class="number">75F</span>6              jnz <span class="number">0x53</span>            <span class="comment">//loop; yine bir decryption </span></span><br><span class="line"><span class="number">89</span>D8              mov eax,ebx         <span class="comment">//eax = 0</span></span><br><span class="line"><span class="number">052</span>C010000        add eax,<span class="number">0x12c</span>       <span class="comment">//eax = 300</span></span><br><span class="line">BA19000000        mov edx,<span class="number">0x19</span>        <span class="comment">//edx = 25</span></span><br><span class="line"><span class="number">0118</span>              add [eax],ebx       <span class="comment">//[eax]taki değerlere base&#x27;i ekle </span></span><br><span class="line"><span class="number">83</span>C004            add eax,byte +<span class="number">0x4</span>   <span class="comment">//4byte ilerle</span></span><br><span class="line"><span class="number">83</span>EA01            sub edx,byte +<span class="number">0x1</span>   <span class="comment">//dec</span></span><br><span class="line"><span class="number">75F</span>6              jnz <span class="number">0x69</span>            <span class="comment">//loop</span></span><br><span class="line"><span class="number">89</span>D8              mov eax,ebx         <span class="comment">//eax = base</span></span><br><span class="line"><span class="number">052</span>C010000        add eax,<span class="number">0x12c</span>       <span class="comment">//eax = 300</span></span><br><span class="line"><span class="number">89E2</span>              mov edx,esp         <span class="comment">//save esp</span></span><br><span class="line"><span class="number">8B</span>7C2404          mov edi,[esp+<span class="number">0x4</span>]   <span class="comment">//edi = flag</span></span><br><span class="line"><span class="number">8B</span>742408          mov esi,[esp+<span class="number">0x8</span>]   <span class="comment">//esi = data</span></span><br><span class="line"><span class="number">8B</span>5C240C          mov ebx,[esp+<span class="number">0xc</span>]   <span class="comment">//ebx = size</span></span><br><span class="line"><span class="number">89</span>C4              mov esp,eax         <span class="comment">//esp = 300</span></span><br><span class="line">C3                ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Simdi kodumuz ne yapıyor kabaca bahsedersek:</p>
<ul>
<li>Key hesapla</li>
<li>200-400 arasını bu key ile xorla</li>
<li>300den sonrası için shellkodun yüklendiği base’i ekle</li>
<li>esp’ye 300un offsetini ata</li>
<li>ret</li>
<li>ret’ten sonra kod executionu 300den devam edicek</li>
</ul>
<p>Şimdi bizim if’i geçebilmemiz için bu fonksiyondan dönen değerin 0x31337 olması lazım. Şuan görünürde bu değer yok. 300’e gittikten sonra bu işi yapması lazım.</p>
<p>200-400 arasını XORlayacak keyi bulmak için bu aralığa bir bakalım.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">000000c0: 9090 9090 9090 9090 fa18 3313 42db b0d3  ..........3.B...</span><br><span class="line">000000d0: 46db f09a b2db b815 8129 3dd0 c1de 37d0  F........)=...7.</span><br><span class="line">000000e0: c1f3 37d0 3c19 f04b 819b df0b 81a0 3a13  ..7.&lt;..K......:.</span><br><span class="line">000000f0: 4218 f0ab 750b 3013 8191 ebd0 cbd3 f09a  B...u.0.........</span><br><span class="line">00000100: 8adb f2d2 4adb 02da 812b 7c07 812b 7c3b  ....J....+|..+|;</span><br><span class="line">00000110: 8188 a383 d288 a383 d288 a383 d288 a383  ................</span><br><span class="line">00000120: d288 a383 d288 a383 d288 a383 4419 3313  ............D.3.</span><br><span class="line">00000130: 4b19 3313 4f19 3313 9b18 3313 9e18 3313  K.3.O.3...3...3.</span><br><span class="line">00000140: 4019 3313 a218 3313 a618 3313 ab18 3313  @.3...3...3...3.</span><br><span class="line">00000150: b118 3313 c918 3313 4218 3313 4218 3313  ..3...3.B.3.B.3.</span><br><span class="line">00000160: 4218 3313 4218 3313 4218 3313 4218 3313  B.3.B.3.B.3.B.3.</span><br><span class="line">00000170: 4218 3313 4218 3313 4218 3313 4218 3313  B.3.B.3.B.3.B.3.</span><br><span class="line">00000180: 4218 3313 4218 3313 4218 3313 4218 3313  B.3.B.3.B.3.B.3.</span><br></pre></td></tr></table></figure>

<p>Bloğun sonuna bakarsanız hep tekrar eden değerler görüyoruz. Bloğun başı işe anlamsız datalardan oluşuyor. Burda bloğun sonunun 0x0 lerle bittiğini düşünerek XOR keyi olarak 0x42183313 kullandım. </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000000  B800000000        mov eax,0x0</span><br><span class="line">00000005  C3                ret</span><br><span class="line">00000006  83C004            add eax,byte +0x4</span><br><span class="line">00000009  C3                ret</span><br><span class="line">0000000A  C3                ret</span><br><span class="line">0000000B  89F0              mov eax,esi</span><br><span class="line">0000000D  C3                ret</span><br><span class="line">0000000E  8B06              mov eax,[esi]</span><br><span class="line">00000010  C3                ret</span><br><span class="line">00000011  310E              xor [esi],ecx</span><br><span class="line">00000013  C3                ret</span><br><span class="line">00000014  83C604            add esi,byte +0x4</span><br><span class="line">00000017  C3                ret</span><br><span class="line">00000018  83EB04            sub ebx,byte +0x4</span><br><span class="line">0000001B  C3                ret</span><br><span class="line">0000001C  7E01              jng 0x1f</span><br><span class="line">0000001E  C3                ret</span><br><span class="line">0000001F  58                pop eax</span><br><span class="line">00000020  C3                ret</span><br><span class="line">00000021  83EC18            sub esp,byte +0x18</span><br><span class="line">00000024  C3                ret</span><br><span class="line">00000025  B809000000        mov eax,0x9</span><br><span class="line">0000002A  C3                ret</span><br><span class="line">0000002B  B837130300        mov eax,0x31337</span><br><span class="line">00000030  C3                ret</span><br><span class="line">00000031  89D8              mov eax,ebx</span><br><span class="line">00000033  C3                ret</span><br><span class="line">00000034  89CB              mov ebx,ecx</span><br><span class="line">00000036  C3                ret</span><br><span class="line">00000037  89C8              mov eax,ecx</span><br><span class="line">00000039  C3                ret</span><br><span class="line">0000003A  C1C108            rol ecx,byte 0x8</span><br><span class="line">0000003D  C3                ret</span><br><span class="line">0000003E  31C9              xor ecx,ecx</span><br><span class="line">00000040  C3                ret</span><br><span class="line">00000041  334F14            xor ecx,[edi+0x14]</span><br><span class="line">00000044  C3                ret</span><br><span class="line">00000045  334F28            xor ecx,[edi+0x28]</span><br><span class="line">00000048  C3                ret</span><br><span class="line">...</span><br><span class="line">00000063  90                nop</span><br><span class="line">00000064  06                push es</span><br><span class="line">00000065  0100              add [eax],eax</span><br><span class="line">00000067  0009              add [ecx],cl</span><br><span class="line">00000069  0100              add [eax],eax</span><br><span class="line">0000006B  000D010000D9      add [dword 0xd9000001],cl</span><br><span class="line">00000071  0000              add [eax],al</span><br><span class="line">00000073  00DC              add ah,bl</span><br><span class="line">00000075  0000              add [eax],al</span><br><span class="line">00000077  0002              add [edx],al</span><br><span class="line">00000079  0100              add [eax],eax</span><br><span class="line">0000007B  00E0              add al,ah</span><br><span class="line">0000007D  0000              add [eax],al</span><br><span class="line">0000007F  00E4              add ah,ah</span><br><span class="line">00000081  0000              add [eax],al</span><br><span class="line">00000083  00E9              add cl,ch</span><br><span class="line">00000085  0000              add [eax],al</span><br><span class="line">00000087  00F3              add bl,dh</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Bloğumuzun başı rop gadgetleri. Altı ise bu gadgetların adresleri. Disasm bozuk göstersede şu şekilde :</p>
<p>0x0106 0x0109 0x010d 0x00d9 .. 0x00f3 </p>
<p>Bu değerler espye atanmıştı. ret yapıldıkça bu değerler poplana poplana gidicek. Yani bu bizim çalışacak kodumuz. Şimdi fonksiyonun 0x31337 dönmesini istiyorduk. Bakalım rop chain döndürüyormu. Son offset 0xf3</p>
<p>200’u 0 kabul edip hesaplarsak : <code>hex(0xf3-200)</code> : 0x2b . Şimdi yukarıdan 0x2bye bakalım.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000002B  B837130300        mov eax,0x31337</span><br><span class="line">00000030  C3                ret</span><br></pre></td></tr></table></figure>

<p>evet istediğimiz değer dönüyor. Rop için key:</p>
<p>Bu aşamadaki key şu şekilde hesaplanıyor : </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">16</span>]^flag[<span class="number">32</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">17</span>]^flag[<span class="number">33</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">18</span>]^flag[<span class="number">34</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">19</span>]^flag[<span class="number">35</span>]</span><br></pre></td></tr></table></figure>
<p>Bulduğumuz xor keyi :</p>
<p>Key4 : <code>\x42\x18\x33\x13</code></p>
<h2 id="Asama-5-JS"><a href="#Asama-5-JS" class="headerlink" title="Aşama 5 : JS"></a>Aşama 5 : JS</h2><p>Tabi rop chain sadece 0x31337 döndürmüyor ondan öncesinde fonksiyona verilen başka bir encrypted datayı decrypt ediyor. </p>
<p><img src="/DEF-CON-Quals-2019-Vitor/ida3.png" alt="ida3"></p>
<p>Bir html dosyası. Html dosyasini rop chain oluşturuyor. Cağırılan gadgetlara bakalim:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xor_ecx_ecx         </span><br><span class="line">xor_ecx_[edi+20]    //flag[20:24]</span><br><span class="line">xor_ecx_[edi+40]    //flag[40:44] ^ flag[20:24]</span><br><span class="line">xor_[esi]_ecx       //eside encrypted data var</span><br><span class="line">add_esi_4           //esi_4</span><br><span class="line">rol_ecx_8           //rotate left ecx</span><br><span class="line">sub_ebx_4           //size - 4</span><br><span class="line">loop</span><br><span class="line">mov_eax_31337</span><br></pre></td></tr></table></figure>

<p>Rotate left yapmadan önce ilk aşamada direk gelen xorkeyi kullaniliyor. Bu yüzden yine xor keyini hesaplayabiliriz. Headerin html olduğunu biliyoruz. Encrypted dosyanın ilk 4byte’ı ile xorlarsak</p>
<p>Key5: &#x3D; hex(0x3c68746d^0x6a452630): <code>\x56\x2d\x52\x5d</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">byte[<span class="number">0</span>] = flag[<span class="number">20</span>]^flag[<span class="number">40</span>]</span><br><span class="line">byte[<span class="number">1</span>] = flag[<span class="number">21</span>]^flag[<span class="number">41</span>]</span><br><span class="line">byte[<span class="number">2</span>] = flag[<span class="number">22</span>]^flag[<span class="number">42</span>]</span><br><span class="line">byte[<span class="number">3</span>] = flag[<span class="number">23</span>]^flag[<span class="number">43</span>]</span><br></pre></td></tr></table></figure>

<p>Decryption routinini implemente edicek python scripti yazalim: </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;assets/cxnvhaekljlkjxxqkq&quot;</span>,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">data = f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment">#rol8 4 iterasyondan sonra kendisine geri dönücek</span></span><br><span class="line">a = [<span class="number">0x562d525d</span>,<span class="number">0x5d562d52</span>,<span class="number">0x525d562d</span>,<span class="number">0x2d525d56</span>]</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;bam.html&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="built_in">len</span>(data)/<span class="number">4</span>)):</span><br><span class="line"></span><br><span class="line">    f.write(xor(data[<span class="number">4</span>*i:<span class="number">4</span>*i+<span class="number">4</span>],p32(a[i%<span class="number">4</span>])))</span><br><span class="line"></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>Bam.htmli ilk açtığımız apk dosyasından hatırlarsak : </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(mainActivity.getFilesDir(), <span class="string">&quot;bam.html&quot;</span>);</span><br><span class="line"><span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> mainActivity.mWebView;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">stringBuilder.append(<span class="string">&quot;file:///&quot;</span>);</span><br><span class="line">stringBuilder.append(file.getAbsolutePath());</span><br><span class="line">stringBuilder.append(<span class="string">&quot;?flag=&quot;</span>);</span><br><span class="line">stringBuilder.append(Uri.encode(str));</span><br><span class="line">webView.loadUrl(stringBuilder.toString());</span><br><span class="line">z = mValid;</span><br></pre></td></tr></table></figure>


<p>Son aşama olarak flag stringi bu html dosyasına parametre olarak gidiyor. Html dosyasını açtığımızda obfuscated bir javascriptle karşılaşıyoruz. <a target="_blank" rel="noopener" href="https://twitter.com/theempire_h">theempire_</a> saolsun bu adımı tak diye çözdü. Flagin 24. karakterinden sornasinın <code> =&gt; pHd_1w_e4rL13r;)&#125;</code> ‘a eşit olması gerektiğini anlıyoruz.</p>
<p>Elimizde 5 key ve flagin 24-44 arası karakterleri var. </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key0_0 = <span class="string">&quot;4 ^ 12 ^ 20 ^ 28 ^ 36&quot;</span></span><br><span class="line">key0_1 = <span class="string">&quot;5 ^ 13 ^ 21 ^ 29 ^ 37&quot;</span></span><br><span class="line">key0_2 = <span class="string">&quot;6 ^ 14 ^ 22 ^ 30 ^ 38&quot;</span></span><br><span class="line">key0_3 = <span class="string">&quot;7 ^ 15 ^ 23 ^ 31 ^ 39&quot;</span></span><br><span class="line"></span><br><span class="line">key1_0 = <span class="string">&quot;8 ^ 16 ^ 24 ^ 32 ^ 40&quot;</span></span><br><span class="line">key1_1 = <span class="string">&quot;9 ^ 17 ^ 25 ^ 33 ^ 41&quot;</span></span><br><span class="line">key1_0 = <span class="string">&quot;10 ^ 18 ^ 26 ^ 34 ^ 42&quot;</span></span><br><span class="line">key1_1 = <span class="string">&quot;11 ^ 19 ^ 27 ^ 35 ^ 43&quot;</span></span><br><span class="line"></span><br><span class="line">key2_0 = <span class="string">&quot;12 ^ 24 ^ 36&quot;</span></span><br><span class="line">key2_1 = <span class="string">&quot;13 ^ 25 ^ 37&quot;</span></span><br><span class="line">key2_2 = <span class="string">&quot;14 ^ 26 ^ 38&quot;</span></span><br><span class="line">key2_3 = <span class="string">&quot;15 ^ 27 ^ 39&quot;</span></span><br><span class="line"></span><br><span class="line">key3_0 = <span class="string">&quot;16 ^ 32&quot;</span></span><br><span class="line">key3_1 = <span class="string">&quot;17 ^ 33&quot;</span></span><br><span class="line">key3_2 = <span class="string">&quot;18 ^ 34&quot;</span></span><br><span class="line">key3_3 = <span class="string">&quot;19 ^ 35&quot;</span></span><br><span class="line"></span><br><span class="line">key4_0 = <span class="string">&quot;20 ^ 40&quot;</span></span><br><span class="line">key4_1 = <span class="string">&quot;21 ^ 41&quot;</span></span><br><span class="line">key4_2 = <span class="string">&quot;22 ^ 42&quot;</span></span><br><span class="line">key4_3 = <span class="string">&quot;23 ^ 43&quot;</span></span><br></pre></td></tr></table></figure>
<p>Biraz kopya cekerek script yazarsak.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">key0 = <span class="string">b&#x27;\x17\x01\x2f\x03&#x27;</span></span><br><span class="line">key1 = <span class="string">b&#x27;\x3c\x27\x43\x60&#x27;</span></span><br><span class="line">key2 = <span class="string">b&#x27;\x6e\x63\x27\x4e&#x27;</span></span><br><span class="line">key3 = <span class="string">b&#x27;\x42\x18\x33\x13&#x27;</span></span><br><span class="line">key4 = <span class="string">b&#x27;\x56\x2d\x52\x5d&#x27;</span></span><br><span class="line"></span><br><span class="line">f6, f7, f8, f9, f10 = group(<span class="number">4</span>, <span class="string">&#x27; =&gt; pHd_1w_e4rL13r;)&#x27;</span>)</span><br><span class="line">f5 = xor(key4, f10)</span><br><span class="line">f4 = xor(key3, f8)</span><br><span class="line">f3 = xor(xor(key2, f6), f9)</span><br><span class="line">f2 = xor(xor(xor(xor(key1, f4), f6), f8), f10)</span><br><span class="line">f1 = xor(xor(xor(xor(xor(key0, key1), f3), f5), f7), f9)</span><br><span class="line"></span><br><span class="line">theflag = <span class="string">&#x27;OOO&#123;&#x27;</span> + f1 + f2 + f3 + f4 + f5 + f6 + f7 + f8 + f9 + f10 + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">print</span> theflag</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>flag : <code>OOO&#123;pox&amp;mpuzz,U_solve_it =&gt; pHd_1w_e4rL13r;)&#125;</code></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Vitor"><span class="toc-number">1.</span> <span class="toc-text">Vitor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-1-Dex"><span class="toc-number">2.</span> <span class="toc-text">Aşama 1 : Dex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-2-SO"><span class="toc-number">3.</span> <span class="toc-text">Aşama 2 : SO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-3-Shellkod"><span class="toc-number">4.</span> <span class="toc-text">Aşama 3 Shellkod:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-4-ROP"><span class="toc-number">5.</span> <span class="toc-text">Aşama 4 : ROP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asama-5-JS"><span class="toc-number">6.</span> <span class="toc-text">Aşama 5 : JS</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://eybisi.run/DEF-CON-Quals-2019-Vitor/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&text=DEF CON Quals 2019 : Vitor"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&is_video=false&description=DEF CON Quals 2019 : Vitor"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DEF CON Quals 2019 : Vitor&body=Check out this article: http://eybisi.run/DEF-CON-Quals-2019-Vitor/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&title=DEF CON Quals 2019 : Vitor"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&name=DEF CON Quals 2019 : Vitor&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://eybisi.run/DEF-CON-Quals-2019-Vitor/&t=DEF CON Quals 2019 : Vitor"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022
    abc
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-129796595-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-129796595-1');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'eybisi-run';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
